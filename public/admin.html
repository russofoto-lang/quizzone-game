<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>REGIA MASTER - Siponto Forever Young</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1a202c; color: white; }
        .glass-panel { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="p-2 h-screen flex flex-col text-sm">

    <div class="flex justify-between items-center bg-white p-2 rounded shadow mb-2">
        <h1 class="font-black text-xl text-gray-800 uppercase tracking-tighter">Regia Siponto</h1>
        <div class="flex gap-2">
            <button onclick="regia('logo')" class="px-3 py-1 bg-gray-700 text-white rounded font-bold uppercase text-xs">Logo/QR</button>
            <button onclick="regia('gioco')" class="px-3 py-1 bg-blue-600 text-white rounded font-bold uppercase text-xs">Gioco</button>
            <button onclick="regia('classifica_round')" class="px-3 py-1 bg-purple-600 text-white rounded font-bold uppercase text-xs">Podio</button>
            <button onclick="regia('classifica_gen')" class="px-3 py-1 bg-yellow-600 text-white rounded font-bold uppercase text-xs">Generale</button>
            <button onclick="mostraVincitore()" class="px-3 py-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded font-bold uppercase text-xs">Vincitore</button>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-2 flex-1 overflow-hidden">
        
        <div class="col-span-4 bg-white p-3 rounded shadow overflow-y-auto flex flex-col">
            <!-- SELEZIONE PACCHETTO -->
            <select id="sel-package" class="w-full border-2 border-green-500 p-2 rounded font-bold mb-2 text-gray-800">
    <option value="1">Pacchetto Principale</option>
</select>

            <select id="sel-tipo" class="w-full border-2 border-blue-500 p-2 rounded font-bold mb-2 text-gray-800">
                <option value="">-- SELEZIONA MODALIT√Ä --</option>
                <option value="categoria">üìÇ CATEGORIE</option>
                <option value="stima">üîÆ STIMA</option>
                <option value="anagramma">üß© ANAGRAMMA</option>
                <option value="bonus">üí∞ BONUS</option>
            </select>
            <select id="sel-cat" class="w-full border p-1 rounded mb-2 text-gray-800" disabled>
                <option value="">-- SCEGLI CATEGORIA --</option>
            </select>
            <select id="sel-dom" class="w-full border p-1 rounded mb-2 h-48 text-gray-800" size="10" disabled></select>
            
            <div class="grid grid-cols-2 gap-2 mt-auto">
                <button onclick="lancia('classico')" class="bg-blue-600 text-white py-3 rounded font-black uppercase shadow-lg">Quiz ABCD</button>
                <button onclick="lancia('buzzer')" class="bg-red-600 text-white py-3 rounded font-black uppercase shadow-lg">Buzzer/Voce</button>
            </div>
            <button onclick="resetGame()" class="w-full bg-red-900 text-white mt-2 py-1 rounded text-[10px] opacity-50 uppercase">Reset Totale Sessione</button>
        </div>

        <div class="col-span-5 bg-gray-900 p-3 rounded shadow flex flex-col border-2 border-gray-700">
            
            <div id="buzzer-alert" class="hidden bg-red-600 p-4 rounded text-center mb-2">
                <div class="text-xs font-bold uppercase mb-2">‚ö° ORDINE ARRIVI BUZZER ‚ö°</div>
                <div class="text-yellow-300 font-bold border-b border-red-500 pb-2 mb-3">
                    RISPOSTA: <span id="buzzer-solution" class="text-white uppercase">---</span>
                </div>
                
                <!-- Lista completa buzzer -->
                <div id="buzzer-queue-list" class="bg-red-900/50 rounded p-3 max-h-64 overflow-y-auto">
                    <!-- Popolato via JS -->
                </div>
                
                <div class="grid grid-cols-2 gap-2 mt-3">
                    <button onclick="buzzerCorrect()" class="bg-green-700 hover:bg-green-600 py-2 rounded font-bold uppercase text-sm">
                        ‚úÖ Assegna Punti
                    </button>
                    <button onclick="buzzerWrong()" class="bg-gray-800 hover:bg-gray-700 py-2 rounded font-bold uppercase text-sm">
                        ‚ùå Risposta Sbagliata
                    </button>
                </div>
                
                <button onclick="chiudiBuzzer()" class="w-full bg-gray-800 hover:bg-gray-700 text-white mt-3 py-2 rounded font-bold uppercase text-sm">
                    üîí Chiudi Buzzer
                </button>
            </div>

            <div id="classic-monitor" class="flex-1 overflow-y-auto">
                <div class="flex justify-between items-center border-b border-gray-700 pb-1 mb-2">
                    <span class="text-blue-400 font-black uppercase text-xs tracking-widest">Monitor Risposte Live</span>
                    <span id="answers-count" class="text-[10px] bg-gray-800 px-2 py-0.5 rounded text-gray-400">0 risposte</span>
                </div>
                <table class="w-full">
                    <thead class="text-[10px] text-gray-500 border-b border-gray-800">
                        <tr>
                            <th class="text-left py-1">SQUADRA</th>
                            <th class="text-left px-2">RISPOSTA</th>
                            <th class="text-right">TEMPO</th>
                            <th class="text-right pr-2">PUNTI</th>
                        </tr>
                    </thead>
                    <tbody id="round-table" class="text-sm">
                    </tbody>
                </table>
                
                <!-- BOTTONE MOSTRA SOLUZIONE -->
                <div id="show-solution-btn" class="hidden mt-3">
                    <button onclick="mostraSoluzioneSuDisplay()" class="w-full bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white py-3 rounded font-black uppercase shadow-lg text-sm">
                        üì∫ Mostra Soluzione su Display
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 mt-2 pt-2 border-t border-gray-800">
                <button onclick="toggleLock(false)" class="bg-green-700 hover:bg-green-600 py-2 rounded font-bold uppercase text-xs shadow-inner">üîì Apri Buzzer</button>
                <button onclick="toggleLock(true)" class="bg-gray-700 hover:bg-gray-600 py-2 rounded font-bold uppercase text-xs shadow-inner">üîí Blocca</button>
            </div>
        </div>

        <div class="col-span-3 bg-white p-3 rounded shadow flex flex-col text-gray-800">
            <h2 class="font-black border-b border-gray-200 mb-2 uppercase text-xs text-gray-500 tracking-widest">Punteggi Live</h2>
            <div class="flex-1 overflow-y-auto">
                <table class="w-full">
                    <tbody id="team-list"></tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        const socket = io();
        let currentQuestions = [], selectedQ = null, dbStructure = {};
        let currentRoundAnswers = [];

        socket.on('connect', () => { socket.emit('admin_connect'); });
        
        socket.on('init_data', (d) => { 
            dbStructure = d; 
            updateTeams(d.teams); 
            
            // Popola dropdown pacchetti
            const packageSelect = document.getElementById('sel-package');
            packageSelect.innerHTML = '<option value="">-- SELEZIONA PACCHETTO --</option>';
            d.packages.forEach(pkg => {
                packageSelect.innerHTML += `<option value="${pkg.id}" ${pkg.id === d.currentPackage ? 'selected' : ''}>${pkg.name}</option>`;
            });
            
            // Popola dropdown categorie (se presente)
            const catSelect = document.getElementById('sel-cat');
            catSelect.innerHTML = '<option value="">-- SCEGLI CATEGORIA --</option>';
            if (d.categories && d.categories.length > 0) {
                d.categories.forEach(c => {
                    catSelect.innerHTML += `<option value="${c}">${c}</option>`;
                });
            }
        });

        // Evento quando il pacchetto viene cambiato
        socket.on('package_selected', (data) => {
            console.log('Pacchetto selezionato:', data);
            
            // Aggiorna il testo del pacchetto selezionato
            const packageSelect = document.getElementById('sel-package');
            if (packageSelect.value !== data.packageId) {
                packageSelect.value = data.packageId;
            }
            
            // Popola il dropdown delle categorie
            const catSelect = document.getElementById('sel-cat');
            catSelect.innerHTML = '<option value="">-- SCEGLI CATEGORIA --</option>';
            
            if (data.categories && data.categories.length > 0) {
                data.categories.forEach(c => {
                    catSelect.innerHTML += `<option value="${c}">${c}</option>`;
                });
                catSelect.disabled = false;
            } else {
                catSelect.innerHTML = '<option value="">Nessuna categoria disponibile</option>';
                catSelect.disabled = true;
            }
            
            // Resetta le domande
            document.getElementById('sel-dom').innerHTML = '';
            document.getElementById('sel-dom').disabled = true;
            currentQuestions = [];
            selectedQ = null;
        });

        // Aggiungi evento change al dropdown pacchetti
        document.getElementById('sel-package').addEventListener('change', (e) => {
            const packageId = e.target.value;
            if (packageId) {
                socket.emit('select_package', packageId);
            }
        });

        // Caricamento domande nelle tendine
        document.getElementById('sel-tipo').addEventListener('change', (e) => {
            const t = e.target.value;
            const sc = document.getElementById('sel-cat');
            
            if(t === 'categoria') {
                // Controlla se abbiamo gi√† selezionato un pacchetto
                const currentPackageId = document.getElementById('sel-package').value;
                if (!currentPackageId) {
                    alert('Seleziona prima un pacchetto!');
                    e.target.value = ''; // Resetta la selezione
                    return;
                }
                
                // Se il dropdown categorie √® gi√† popolato, abilitalo
                if (sc.options.length > 1) {
                    sc.disabled = false;
                } else {
                    // Altrimenti richiedi le categorie al server
                    socket.emit('get_categories', { packageId: currentPackageId });
                }
            } else {
                sc.disabled = true;
                const currentPackageId = document.getElementById('sel-package').value;
                if (currentPackageId) {
                    socket.emit('get_questions', {type: t});
                }
            }
        });

        // Evento per ricevere le categorie
        socket.on('categories_list', (data) => {
            const catSelect = document.getElementById('sel-cat');
            catSelect.innerHTML = '<option value="">-- SCEGLI CATEGORIA --</option>';
            
            if (data.categories && data.categories.length > 0) {
                data.categories.forEach(c => {
                    catSelect.innerHTML += `<option value="${c}">${c}</option>`;
                });
                catSelect.disabled = false;
            }
        });

        document.getElementById('sel-cat').addEventListener('change', (e) => {
            const currentPackageId = document.getElementById('sel-package').value;
            if (!currentPackageId) {
                alert('Seleziona prima un pacchetto!');
                return;
            }
            socket.emit('get_questions', {type: 'categoria', key: e.target.value});
        });

        socket.on('receive_questions', (q) => {
            currentQuestions = q;
            const s = document.getElementById('sel-dom');
            s.disabled = false;
            s.innerHTML = '';
            q.forEach((item, i) => {
                const difficoltaEmoji = item.difficolta === 'facile' ? 'üü¢' : 
                                       item.difficolta === 'medio' ? 'üü°' : 'üî¥';
                s.innerHTML += `<option value="${i}">${difficoltaEmoji} ${item.domanda.substring(0,40)}...</option>`;
            });
        });

        document.getElementById('sel-dom').addEventListener('change', (e) => {
            selectedQ = currentQuestions[e.target.value];
        });

        // Gestione Risposte Live (Monitor Centrale)
        socket.on('update_round_monitor', (data) => {
            currentRoundAnswers = data;
            const table = document.getElementById('round-table');
            document.getElementById('answers-count').innerText = `${data.length} risposte`;
            table.innerHTML = '';
            
            data.forEach((res, index) => {
                const bg = res.corretta ? 'text-green-400' : 'text-red-400';
                const punti = res.punti || 0;
                const puntiColor = res.corretta ? 'text-green-400' : 'text-gray-600';
                
                let puntiCell;
                if (res.corretta) {
                    puntiCell = `
                        <td class="text-right pr-2">
                            <div class="flex items-center justify-end space-x-1">
                                <button onclick="updatePoints(${index}, -10)" class="bg-gray-800 text-gray-400 w-6 h-6 rounded flex items-center justify-center hover:bg-gray-700 text-xs">-10</button>
                                <span class="font-black text-sm ${puntiColor} px-2">+${punti}</span>
                                <button onclick="updatePoints(${index}, 10)" class="bg-gray-800 text-gray-400 w-6 h-6 rounded flex items-center justify-center hover:bg-gray-700 text-xs">+10</button>
                            </div>
                        </td>
                    `;
                } else {
                    puntiCell = `<td class="text-right font-black text-sm ${puntiColor} pr-2">${punti}</td>`;
                }
                
                table.innerHTML += `
                    <tr class="border-b border-gray-800 animate-in fade-in duration-300">
                        <td class="py-2 font-bold">${res.teamName}</td>
                        <td class="px-2 font-mono ${bg}">${res.corretta ? '‚úÖ' : '‚ùå'} ${res.risposta}</td>
                        <td class="text-right text-gray-500 text-[10px]">${res.tempo}s</td>
                        ${puntiCell}
                    </tr>`;
            });
            
            if(data.length > 0) {
                document.getElementById('show-solution-btn').classList.remove('hidden');
            }
        });

        // Funzione per aggiornare manualmente i punti
        function updatePoints(answerIndex, delta) {
            if (!currentRoundAnswers[answerIndex]) return;
            const currentPoints = currentRoundAnswers[answerIndex].punti;
            const newPoints = Math.max(0, currentPoints + delta);
            socket.emit('update_answer_points', { 
                answerIndex: answerIndex, 
                newPoints: newPoints 
            });
        }

        socket.on('reset_round_monitor', () => {
            currentRoundAnswers = [];
            document.getElementById('round-table').innerHTML = '';
            document.getElementById('answers-count').innerText = "0 risposte";
            document.getElementById('buzzer-alert').classList.add('hidden');
            document.getElementById('classic-monitor').classList.remove('hidden');
            document.getElementById('show-solution-btn').classList.add('hidden');
        });

        // Gestione Buzzer
        socket.on('buzzer_queue_full', (d) => {
            document.getElementById('classic-monitor').classList.add('hidden');
            document.getElementById('buzzer-alert').classList.remove('hidden');
            document.getElementById('buzzer-solution').innerText = d.correctAnswer;
            
            const queueDiv = document.getElementById('buzzer-queue-list');
            queueDiv.innerHTML = '';
            
            if(d.queue && d.queue.length > 0) {
                d.queue.forEach((player, idx) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const medal = medals[idx] || `${idx + 1}.`;
                    
                    queueDiv.innerHTML += `
                        <div class="bg-white/10 rounded p-2 mb-2 flex justify-between items-center">
                            <div class="text-left">
                                <span class="text-2xl mr-2">${medal}</span>
                                <span class="font-black text-white text-lg">${player.name}</span>
                                <span class="text-yellow-300 text-sm ml-2">(${player.time}s)</span>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="assignPoints('${player.id}', 100)" class="bg-green-500 hover:bg-green-400 px-3 py-1 rounded font-bold text-sm">+100</button>
                                <button onclick="assignPoints('${player.id}', 50)" class="bg-blue-500 hover:bg-blue-400 px-3 py-1 rounded font-bold text-sm">+50</button>
                                <button onclick="assignPoints('${player.id}', -50)" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded font-bold text-sm">-50</button>
                            </div>
                        </div>
                    `;
                });
            } else {
                queueDiv.innerHTML = '<p class="text-white/60 text-sm">In attesa di prenotazioni...</p>';
            }
        });

        socket.on('reset_buzzer_admin', () => {
            document.getElementById('buzzer-alert').classList.add('hidden');
            document.getElementById('classic-monitor').classList.remove('hidden');
        });

        // Classifica e Punti Manuali
        socket.on('update_teams', updateTeams);
        function updateTeams(t) {
            t.sort((a,b) => b.score - a.score);
            const l = document.getElementById('team-list');
            l.innerHTML = '';
            t.forEach(x => {
                l.innerHTML += `
                    <tr class="border-b border-gray-100">
                        <td class="py-2 font-bold text-sm">${x.name}</td>
                        <td class="text-right px-2 font-black text-blue-600">${x.score}</td>
                        <td class="flex gap-1 py-1 justify-end">
                            <button onclick="punti('${x.id}',50)" class="bg-green-100 text-green-700 px-2 rounded font-bold hover:bg-green-200">+50</button>
                            <button onclick="punti('${x.id}',-50)" class="bg-red-100 text-red-700 px-2 rounded font-bold hover:bg-red-200">-50</button>
                        </td>
                    </tr>`;
            });
        }

        function lancia(m) { 
            if(!selectedQ) {
                alert('Seleziona una domanda prima!');
                return;
            }
            const currentPackageId = document.getElementById('sel-package').value;
            if (!currentPackageId) {
                alert('Seleziona prima un pacchetto!');
                return;
            }
            socket.emit('invia_domanda', {...selectedQ, modalita: m}); 
        }
        
        function toggleLock(s) { socket.emit('toggle_buzzer_lock', s); }
        function buzzerCorrect() { socket.emit('buzzer_correct_assign', {points: 100}); }
        function buzzerWrong() { socket.emit('buzzer_wrong_next'); }
        function regia(v) { socket.emit('regia_cmd', v); }
        function punti(id, p) { socket.emit('admin_punti_manuali', {id: id, punti: p}); }
        function resetGame() { if(confirm("Vuoi resettare tutti i punteggi e le squadre?")) socket.emit('reset_game'); }
        
        function assignPoints(teamId, points) {
            socket.emit('buzzer_assign_points', { teamId: teamId, points: points });
        }
        
        function chiudiBuzzer() {
            socket.emit('buzzer_close');
            document.getElementById('buzzer-alert').classList.add('hidden');
            document.getElementById('classic-monitor').classList.remove('hidden');
        }
        
        function mostraSoluzioneSuDisplay() {
            if(selectedQ && selectedQ.corretta !== undefined) {
                let soluzione = selectedQ.corretta;
                if(typeof selectedQ.corretta === 'number' && selectedQ.risposte) {
                    soluzione = selectedQ.risposte[selectedQ.corretta];
                }
                socket.emit('mostra_soluzione', { soluzione: soluzione, risultati: currentRoundAnswers });
            }
        }
        
        // Funzione per mostrare il vincitore
        function mostraVincitore() {
            // Chiedi conferma
            if (confirm("Vuoi mostrare il vincitore finale? Assicurati che il gioco sia finito.")) {
                // Emetti un evento al server
                socket.emit('mostra_vincitore_finale');
            }
        }
    </script>
</body>
</html>
