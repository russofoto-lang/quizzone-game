<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Control Center - Siponto</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0a0e1a; color: white; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        .btn-primary { background: #3b82f6; transition: all 0.15s; }
        .btn-primary:hover { background: #2563eb; transform: scale(1.02); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: #f59e0b; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .btn-scene { background: #1f2937; transition: all 0.15s; padding: 8px; border-radius: 6px; cursor: pointer; }
        .btn-scene:hover { background: #374151; transform: scale(1.05); }
        .btn-scene.active { background: #10b981; box-shadow: 0 0 12px #10b981; }
        .progress-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin: 0 2px; background: #374151; }
        .progress-dot.active { background: #ef4444; box-shadow: 0 0 8px #ef4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .step-btn { opacity: 0.4; pointer-events: none; }
        .step-btn.active { opacity: 1; pointer-events: auto; }
        .preview-frame { background: #000; border: 2px solid #374151; border-radius: 12px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

<!-- HEADER MINIMAL -->
<div class="bg-gradient-to-r from-gray-900 to-gray-800 px-4 py-2 border-b border-gray-700">
    <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
            <h1 class="font-black text-xl text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-red-600">CONTROL CENTER</h1>
            <span id="question-counter" class="text-lg font-bold text-gray-400">Q: 0</span>
        </div>
        
        <!-- Layout Presets -->
        <div class="flex items-center gap-2">
            <div class="flex gap-1 mr-3 bg-gray-900/50 rounded-lg p-1 border border-gray-700">
                <button onclick="setLayout('compact')" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-bold transition">
                    üì± Compatto
                </button>
                <button onclick="setLayout('balanced')" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs font-bold transition" id="layout-balanced">
                    ‚öñÔ∏è Bilanciato
                </button>
                <button onclick="setLayout('preview')" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-bold transition">
                    üîç Preview
                </button>
            </div>
            
            <button onclick="togglePause()" id="pause-btn" class="px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg font-bold text-sm">‚è∏Ô∏è PAUSA</button>
            <button onclick="resetGame()" class="px-3 py-2 bg-red-900 hover:bg-red-800 rounded-lg font-bold text-xs opacity-60">Reset</button>
        </div>
    </div>
</div>

<!-- LAYOUT: 20-40-40 -->
<div class="flex-1 flex gap-2 p-2 overflow-hidden">
    
    <!-- COLONNA SINISTRA: MOTORE (20%) -->
    <div id="column-left" class="w-1/5 flex flex-col gap-2 transition-all duration-300">
        <!-- Selezione -->
        <div class="bg-gray-900/50 rounded-lg p-2 border border-gray-800">
            <div class="text-sm font-bold text-blue-400 mb-1 uppercase">üìö Selezione</div>
            <select id="sel-tipo" class="w-full bg-gray-800 text-white p-2 rounded text-sm font-bold border border-gray-700 mb-1">
                <option value="">Tipo</option>
                <option value="categoria">üìö Categorie</option>
                <option value="stima">üî¢ Stima</option>
                <option value="anagramma">üî§ Anagramma</option>
                <option value="bonus">‚≠ê Bonus</option>
            </select>
            <select id="sel-cat" class="w-full bg-gray-800 text-white p-2 rounded text-sm font-bold border border-gray-700" disabled>
                <option value="">Categoria</option>
            </select>
        </div>

        <!-- Lista Domande -->
        <div class="flex-1 bg-gray-900/50 rounded-lg p-2 border border-gray-800 overflow-hidden">
            <div class="text-sm font-bold text-blue-400 mb-1 uppercase">üìã Domande</div>
            <div id="questions-container" class="overflow-y-auto h-full text-xs">
                <div class="text-gray-500 text-center py-4">Seleziona tipo...</div>
            </div>
        </div>

        <!-- Azioni Lancio -->
        <div class="bg-gray-900/50 rounded-lg p-2 border border-gray-800">
            <button onclick="lanciaQuiz()" class="w-full btn-primary text-white font-bold py-3 rounded-lg mb-1 text-sm">
                üéØ LANCIA QUIZ
            </button>
            <button onclick="lanciaBuzzer()" class="w-full btn-danger text-white font-bold py-3 rounded-lg text-sm">
                ‚ö° LANCIA BUZZER
            </button>
        </div>
    </div>

    <!-- COLONNA CENTRO: PREVIEW + RISPOSTE + CLASSIFICA (40%) -->
    <div id="column-center" class="w-2/5 flex flex-col gap-2 transition-all duration-300">
        <!-- Preview Ridotta -->
        <div class="h-40 bg-gray-900/50 rounded-lg p-2 border border-gray-800 overflow-hidden">
            <div class="flex justify-between items-center mb-1">
                <div class="text-sm font-bold text-purple-400 uppercase">üì± Preview</div>
                <button onclick="refreshPreview()" class="text-xs bg-gray-800 px-2 py-0.5 rounded hover:bg-gray-700 font-bold">üîÑ</button>
            </div>
            <div class="preview-frame h-full overflow-hidden">
                <iframe id="mobile-preview" src="" class="w-full h-full border-0 pointer-events-none" style="transform: scale(0.32); transform-origin: top left; width: 313%; height: 313%;"></iframe>
            </div>
        </div>

        <!-- Monitor Risposte - PI√ô GRANDE -->
        <div class="h-56 bg-gray-900/50 rounded-lg p-2 border border-gray-800 overflow-hidden">
            <div class="flex justify-between items-center mb-1">
                <div class="text-sm font-bold text-green-400 uppercase">‚ö° Risposte</div>
                <span id="answers-count" class="text-xs bg-gray-800 px-2 py-0.5 rounded font-bold">0/10</span>
            </div>
            <div id="answers-list" class="overflow-y-auto h-48 space-y-1 text-sm"></div>
            <div id="buzzer-monitor" class="hidden overflow-y-auto h-48 space-y-1 text-sm"></div>
        </div>

        <!-- Risposta Corretta Preview -->
        <div id="correct-answer-preview" class="hidden bg-green-900/50 rounded-lg p-3 border border-green-500 mb-2">
            <div class="text-sm font-bold text-green-400 mb-1 uppercase">‚úÖ Risposta Corretta</div>
            <div id="correct-answer-text" class="text-lg font-black text-white"></div>
        </div>

        <!-- Classifica 2 Colonne - RIDOTTA -->
        <div class="flex-1 bg-gray-900/50 rounded-lg p-2 border border-gray-800 overflow-hidden">
            <div class="text-sm font-bold text-yellow-400 mb-1 uppercase">üìä Classifica</div>
            <div id="leaderboard-center" class="grid grid-cols-2 gap-1 text-sm overflow-y-auto max-h-40"></div>
        </div>
    </div>

    <!-- COLONNA DESTRA: MIXER (40%) -->
    <div id="column-right" class="w-2/5 flex flex-col gap-2 overflow-y-auto transition-all duration-300">
        
        <!-- Scene/Display -->
        <div class="bg-gray-900/50 rounded-lg p-2 border border-gray-800">
            <div class="text-sm font-bold text-blue-400 mb-2 uppercase">üì∫ Scene</div>
            <div class="grid grid-cols-4 gap-1 mb-2">
                <div onclick="regia('logo')" class="btn-scene text-center text-xs font-bold">
                    <div class="text-lg">üì±</div>
                    <div>QR</div>
                </div>
                <div onclick="regia('gioco')" class="btn-scene text-center text-xs font-bold">
                    <div class="text-lg">üéÆ</div>
                    <div>Game</div>
                </div>
                <div onclick="regia('classifica_round')" class="btn-scene text-center text-xs font-bold">
                    <div class="text-lg">üèÜ</div>
                    <div>Pod</div>
                </div>
                <div onclick="regia('classifica_gen')" class="btn-scene text-center text-xs font-bold">
                    <div class="text-lg">üìä</div>
                    <div>Cls</div>
                </div>
            </div>
            <div class="grid grid-cols-6 gap-1">
                <div onclick="regia('benvenuto')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>üéâ</div>
                    <div>Ben</div>
                </div>
                <div onclick="regia('regole')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>üìã</div>
                    <div>Reg</div>
                </div>
                <div onclick="regia('punteggi')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>üéØ</div>
                    <div>Pun</div>
                </div>
                <div onclick="regia('prossima')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>‚è∞</div>
                    <div>Pros</div>
                </div>
                <div onclick="regia('logo_forever')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>üéÆ</div>
                    <div>Logo</div>
                </div>
                <!-- BOTTONE MOSTRA VINCITORE -->
                <div onclick="socket.emit('show_winner')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>üëë</div>
                    <div>Win</div>
                </div>
            </div>
        </div>

        <!-- Azioni Rapide -->
        <div class="bg-gray-900/50 rounded-lg p-2 border border-gray-800">
            <div class="text-sm font-bold text-green-400 mb-2 uppercase">‚ö° Azioni</div>
            <div class="grid grid-cols-2 gap-1">
                <!-- BOTTONE SOLUZIONE CORRETTO -->
                <button onclick="mostraSoluzione()" class="btn-warning text-white font-bold py-2 rounded text-sm">
                    üì∫ Soluzione
                </button>
                <button onclick="resetDisplays()" class="btn-danger text-white font-bold py-2 rounded text-sm">
                    üîÑ Reset Disp
                </button>
            </div>
        </div>

        <!-- Buzzer Musicale - COLLAPSIBLE -->
        <div class="bg-purple-900/20 rounded-lg border border-purple-700">
            <button onclick="toggleSection('musicale')" class="w-full flex justify-between items-center p-2 hover:bg-purple-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-purple-300 uppercase">üéµ Gioco Musicale</div>
                <span id="icon-musicale" class="text-purple-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-musicale" class="hidden p-2 pt-0">
                <div class="grid grid-cols-3 gap-1 mb-2">
                    <button onclick="openBuzzerStandalone()" class="btn-success text-white font-bold py-2 rounded text-sm">
                        üîì Apri
                    </button>
                    <button onclick="closeBuzzer()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 rounded text-sm">
                        üîí Blocca
                    </button>
                    <button onclick="resetBuzzer()" class="btn-primary text-white font-bold py-2 rounded text-sm">
                        üîÑ Reset
                    </button>
            </div>
                <div id="buzzer-queue-admin" class="hidden space-y-1 text-sm max-h-24 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Karaoke YouTube - COLLAPSIBLE -->
        <div class="bg-pink-900/20 rounded-lg border border-pink-700">
            <button onclick="toggleSection('karaoke')" class="w-full flex justify-between items-center p-2 hover:bg-pink-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-pink-300 uppercase">üé§ Karaoke YouTube</div>
                <span id="icon-karaoke" class="text-pink-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-karaoke" class="hidden p-2 pt-0">
                <!-- Input Libero -->
                <div class="mb-2">
                    <input type="text" id="youtube-id-input" placeholder="ID Video (es: dQw4w9WgXcQ)" 
                           class="w-full bg-gray-800 text-white text-xs p-2 rounded border border-gray-700 mb-1">
                    <div class="grid grid-cols-2 gap-1">
                        <button onclick="playYoutubeKaraoke()" class="btn-success text-white font-bold py-2 rounded text-sm">
                            ‚ñ∂Ô∏è Play
                        </button>
                        <button onclick="stopKaraoke()" class="btn-danger text-white font-bold py-2 rounded text-sm">
                            ‚èπÔ∏è Stop
                        </button>
                    </div>
                </div>
                
                <!-- Preset Videos -->
                <div class="text-xs text-gray-400 mb-1">Preset:</div>
                <div class="space-y-1">
                    <button onclick="playYoutubePreset('fKo44V64XnA')" class="w-full bg-pink-800 hover:bg-pink-700 text-white font-bold py-1.5 rounded text-xs">
                        üéµ Come Mai - 883
                    </button>
                    <button onclick="playYoutubePreset('xHKfX5299kc')" class="w-full bg-pink-800 hover:bg-pink-700 text-white font-bold py-1.5 rounded text-xs">
                        üéµ Pi√π Bella Cosa - Ramazzotti
                    </button>
                    <button onclick="playYoutubePreset('aVli1cR51sM')" class="w-full bg-pink-800 hover:bg-pink-700 text-white font-bold py-1.5 rounded text-xs">
                        üéµ Felicit√† - Albano
                    </button>
                </div>
            </div>
        </div>

        <!-- Ruota della Fortuna - COLLAPSIBLE -->
        <div class="bg-yellow-900/20 rounded-lg border border-yellow-700">
            <button onclick="toggleSection('ruota')" class="w-full flex justify-between items-center p-2 hover:bg-yellow-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-yellow-300 uppercase">üé∞ Ruota Fortuna</div>
                <span id="icon-ruota" class="text-yellow-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-ruota" class="hidden p-2 pt-0">
                <div class="space-y-1">
                    <button onclick="ruotaStep(1)" class="w-full btn-primary text-white font-bold py-2 rounded text-sm">
                        1Ô∏è‚É£ Spiega Regole
                    </button>
                    <button onclick="ruotaStep(2)" class="w-full btn-warning text-white font-bold py-2 rounded text-sm">
                        2Ô∏è‚É£ Gira Ruota
                    </button>
                    <button onclick="ruotaStep(3)" class="w-full btn-success text-white font-bold py-2 rounded text-sm">
                        3Ô∏è‚É£ Mostra Scelta
                    </button>
                    <div id="ruota-winner-display" class="hidden text-xs text-center py-2 bg-yellow-900/30 rounded font-bold">
                        Estratto: <span id="ruota-winner-name">---</span>
                    </div>
                    <button onclick="ruotaStep(4)" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 rounded text-sm">
                        4Ô∏è‚É£ Lancia Domanda Sfida
                    </button>
                </div>
            </div>
        </div>

        <!-- DUELLO RUBA-PUNTI - COLLAPSIBLE -->
        <div class="bg-red-900/20 rounded-lg border border-red-700">
            <button onclick="toggleSection('duello')" class="w-full flex justify-between items-center p-2 hover:bg-red-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-red-300 uppercase">üî• Duello Ruba-Punti</div>
                <span id="icon-duello" class="text-red-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-duello" class="hidden p-2 pt-0">
                <div class="space-y-1">
                    <button onclick="duelloStep(1)" id="duello-step-1" class="w-full btn-primary text-white font-bold py-2 rounded text-sm">
                        1Ô∏è‚É£ Avvia Duello
                    </button>
                    <div id="duello-attaccante-display" class="hidden text-xs text-center py-2 bg-red-900/40 rounded font-bold border border-red-700">
                        <div class="text-yellow-400">ATTACCANTE:</div>
                        <div id="duello-attaccante-name" class="text-white text-sm">---</div>
                    </div>
                    <button onclick="duelloStep(2)" id="duello-step-2" class="w-full btn-warning text-white font-bold py-2 rounded text-sm opacity-40 pointer-events-none">
                        2Ô∏è‚É£ Scelta Avversario
                    </button>
                    <div id="duello-difensore-display" class="hidden text-xs text-center py-2 bg-blue-900/40 rounded font-bold border border-blue-700">
                        <div class="text-blue-400">DIFENSORE:</div>
                        <div id="duello-difensore-name" class="text-white text-sm">---</div>
                    </div>
                    <button onclick="duelloStep(3)" id="duello-step-3" class="w-full btn-success text-white font-bold py-2 rounded text-sm opacity-40 pointer-events-none">
                        3Ô∏è‚É£ Scelta Categoria
                    </button>
                    <div id="duello-categoria-display" class="hidden text-xs text-center py-2 bg-purple-900/40 rounded font-bold border border-purple-700">
                        <div class="text-purple-400">CATEGORIA:</div>
                        <div id="duello-categoria-name" class="text-white text-sm">---</div>
                    </div>
                    <div class="border-t border-red-700 my-2 pt-2">
                        <div class="text-xs text-center text-gray-400 mb-1">DOMANDA DUELLO</div>
                        <button onclick="duelloStep(4)" id="duello-step-4" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 rounded text-sm opacity-40 pointer-events-none">
                            üéØ Lancia Domanda
                        </button>
                    </div>
                    <div id="duello-scoreboard" class="hidden text-center py-2 bg-black/40 rounded border border-gray-700">
                        <div class="flex justify-center items-center gap-3 text-2xl font-black">
                            <span id="duello-score-att" class="text-yellow-400">0</span>
                            <span class="text-white">-</span>
                            <span id="duello-score-dif" class="text-blue-400">0</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">Primo a 2 vince</div>
                    </div>
                    <div id="duello-answer-buttons" class="hidden space-y-1 border-t border-red-700 pt-2">
                        <div class="text-xs text-center text-yellow-400 mb-1">
                            Risponde: <span id="duello-current-answerer">---</span>
                        </div>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="duelloAnswerResult(true)" class="btn-success text-white font-bold py-2 rounded text-sm">
                                ‚úÖ CORRETTO
                            </button>
                            <button onclick="duelloAnswerResult(false)" class="btn-danger text-white font-bold py-2 rounded text-sm">
                                ‚ùå SBAGLIATO
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MEMORY GAME - COLLAPSIBLE -->
        <div class="bg-purple-900/20 rounded-lg border border-purple-700">
            <button onclick="toggleSection('memory')" class="w-full flex justify-between items-center p-2 hover:bg-purple-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-purple-300 uppercase">üß† Memory Game</div>
                <span id="icon-memory" class="text-purple-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-memory" class="hidden p-2 pt-0">
                <div class="space-y-1">
                    <button onclick="startMemoryGame()" class="w-full btn-primary text-white font-bold py-2 rounded text-sm">
                        üéÆ AVVIA MEMORY
                    </button>
                    <div id="memory-status" class="hidden text-xs text-center py-2 bg-purple-900/30 rounded font-bold">
                        Manche: <span id="memory-manche-display">1/3</span>
                    </div>
                    <div class="grid grid-cols-2 gap-1">
                        <button onclick="skipMemoryRound()" class="btn-warning text-white font-bold py-2 rounded text-sm">
                            ‚è≠Ô∏è Skip Round
                        </button>
                        <button onclick="stopMemoryGame()" class="btn-danger text-white font-bold py-2 rounded text-sm">
                            üõë Stop
                        </button>
                        </div>
                </div>
            </div>
        </div>

        <!-- Sfida Finale - COLLAPSIBLE -->
        <div class="bg-red-900/20 rounded-lg border border-red-700">
            <button onclick="toggleSection('finale')" class="w-full flex justify-between items-center p-2 hover:bg-red-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-red-300 uppercase">üî• Sfida Finale</div>
                <span id="icon-finale" class="text-red-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-finale" class="hidden p-2 pt-0">
                <div class="space-y-1">
                <button onclick="showFinaleExplanation()" id="step-1" class="step-btn active w-full btn-primary text-white font-bold py-2 rounded text-sm">
                    1Ô∏è‚É£ Spiega Regole
                </button>
                <button onclick="startFinale()" id="step-2" class="step-btn w-full btn-danger text-white font-bold py-2 rounded text-sm">
                    2Ô∏è‚É£ Attica Finale
                </button>
                <button onclick="prepareAllIn()" id="step-3" class="step-btn w-full btn-warning text-white font-bold py-2 rounded text-sm">
                    3Ô∏è‚É£ Prepara ALL IN
                </button>
                <div id="allin-bets-status" class="hidden text-xs text-center text-yellow-400 py-1 font-bold"></div>
                <button onclick="showAllInQuestion()" id="step-4" class="step-btn w-full btn-warning text-white font-bold py-2 rounded text-sm">
                    4Ô∏è‚É£ Mostra Domanda
                </button>
                <div id="step-5" class="step-btn text-xs text-gray-400 text-center py-1">
                    5Ô∏è‚É£ Lancia domande 2-5 (x2)
                </div>
                <button onclick="revealWinner()" id="step-6" class="step-btn w-full btn-warning text-white font-bold py-2 rounded text-sm">
                    6Ô∏è‚É£ RIVELA VINCITORE üëë
                </button>
                <div id="finale-progress" class="hidden text-center py-1">
                    <span class="progress-dot"></span>
                    <span class="progress-dot"></span>
                    <span class="progress-dot"></span>
                    <span class="progress-dot"></span>
                    <span class="progress-dot"></span>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let currentQuestions = [], selectedQ = null, dbStructure = {};
    let isPaused = false, finaleActive = false, finaleQuestionCount = 0;
    let totalQuestionsAsked = 0, allInPrepared = false, totalTeams = 0;

    socket.on('connect', () => { socket.emit('admin_connect'); });
    
    socket.on('init_data', (d) => { 
        dbStructure = d; 
        totalTeams = d.teams.length;
        updateTeams(d.teams); 
        populateCategories();
        // ‚úÖ Carica automaticamente la preview all'avvio
        refreshPreview();
    });

    function populateCategories() {
        const sc = document.getElementById('sel-cat');
        sc.innerHTML = '<option value="">Categoria</option>';
        if(dbStructure.categories) {
            dbStructure.categories.forEach(c => {
                sc.innerHTML += `<option value="${c}">${c.replace(/_/g,' ')}</option>`;
            });
        }
    }

    document.getElementById('sel-tipo').addEventListener('change', (e) => {
        const t = e.target.value;
        const sc = document.getElementById('sel-cat');
        if(t === 'categoria') {
            sc.disabled = false;
        } else {
            sc.disabled = true;
            if(t) socket.emit('get_questions', {type: t});
        }
    });

    document.getElementById('sel-cat').addEventListener('change', (e) => {
        if(e.target.value) socket.emit('get_questions', {type: 'categoria', category: e.target.value});
    });

    socket.on('questions_list', (q) => {  // ‚úÖ FIX: Era 'receive_questions'
        currentQuestions = q;
        showQuestionsList(q);
    });

    function showQuestionsList(questions) {
        const container = document.getElementById('questions-container');
        container.innerHTML = '';
        
        questions.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'p-2 bg-gray-800 rounded mb-1 cursor-pointer hover:bg-gray-700 border border-gray-700';
            div.innerHTML = `
                <div class="font-bold text-blue-400">Q${i+1}</div>
                <div class="leading-tight mt-0.5">${item.domanda.substring(0,50)}...</div>
            `;
            div.onclick = () => selectQuestion(i);
            container.appendChild(div);
        });
    }

    function selectQuestion(index) {
        selectedQ = currentQuestions[index];
        document.querySelectorAll('#questions-container > div').forEach((el, i) => {
            el.className = i === index ? 
                'p-2 bg-blue-600 rounded mb-1 cursor-pointer border-2 border-blue-400' : 
                'p-2 bg-gray-800 rounded mb-1 cursor-pointer hover:bg-gray-700 border border-gray-700';
        });
    }

    function lanciaQuiz() { if(selectedQ) lancia('quiz'); else alert('‚ùå Seleziona domanda!'); }
    function lanciaBuzzer() { if(selectedQ) lancia('buzzer'); else alert('‚ùå Seleziona una domanda prima!'); }

    function lancia(m) {
        totalQuestionsAsked++;
        document.getElementById('question-counter').textContent = `Q: ${totalQuestionsAsked}`;
        
        if(finaleActive) {
            finaleQuestionCount++;
            updateFinaleProgress();
            socket.emit('invia_domanda_finale', {...selectedQ, modalita: m});
            if(finaleQuestionCount >= 5) activateStep(6);
        } else {
            socket.emit('invia_domanda', {...selectedQ, modalita: m});
        }
    }

    socket.on('update_round_monitor', (data) => {
        document.getElementById('answers-count').textContent = `${data.length}/${totalTeams}`;
        const list = document.getElementById('answers-list');
        list.innerHTML = '';
        
        data.forEach((res) => {
            const div = document.createElement('div');
            div.className = `p-2 rounded ${res.corretta ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`;
            div.innerHTML = `
                <span class="font-bold">${res.teamName}</span>
                <span class="float-right font-bold">${res.corretta ? '+' : ''}${res.punti || 0}</span>
            `;
            list.appendChild(div);
        });
    });

    socket.on('reset_round_monitor', () => {
        document.getElementById('answers-list').innerHTML = '';
        document.getElementById('answers-list').classList.remove('hidden');
        document.getElementById('buzzer-monitor').classList.add('hidden');
        document.getElementById('buzzer-monitor').innerHTML = '';
    });

    socket.on('buzzer_queue_full', (d) => {
        const isMusicBuzzer = d.standalone || false;
        
        if(isMusicBuzzer) {
            const queueDiv = document.getElementById('buzzer-queue-admin');
            queueDiv.classList.remove('hidden');
            queueDiv.innerHTML = '';
            
            if(d.queue && d.queue.length > 0) {
                d.queue.forEach((player, idx) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const div = document.createElement('div');
                    div.className = 'bg-black/30 rounded p-2 mb-1';
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold">${medals[idx] || (idx+1)+'.'} ${player.name}</span>
                            <span class="text-yellow-400 text-xs">${player.time}s</span>
                        </div>
                        <div class="grid grid-cols-3 gap-1">
                            <button onclick="assignPoints('${player.id}', 100)" class="bg-green-600 hover:bg-green-500 text-white text-xs py-1 rounded font-bold">+100</button>
                            <button onclick="assignPoints('${player.id}', 50)" class="bg-blue-600 hover:bg-blue-500 text-white text-xs py-1 rounded font-bold">+50</button>
                            <button onclick="assignPoints('${player.id}', -50)" class="bg-red-600 hover:bg-red-500 text-white text-xs py-1 rounded font-bold">-50</button>
                        </div>
                    `;
                    queueDiv.appendChild(div);
                });
            }
        } else {
            const monitorDiv = document.getElementById('buzzer-monitor');
            const answersList = document.getElementById('answers-list');
            
            monitorDiv.classList.remove('hidden');
            answersList.classList.add('hidden');
            monitorDiv.innerHTML = '';
            
            document.getElementById('answers-count').textContent = `${d.queue.length}/10`;
            
            if(d.queue && d.queue.length > 0) {
                d.queue.forEach((player, idx) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const medal = medals[idx] || `${idx + 1}¬∞`;
                    
                    const div = document.createElement('div');
                    div.className = 'bg-black/30 rounded p-2 mb-1';
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold">${medal} ${player.name}</span>
                            <span class="text-yellow-400 text-xs">${player.time}s</span>
                        </div>
                        <div class="grid grid-cols-3 gap-1">
                            <button onclick="assignPoints('${player.id}', 100)" class="bg-green-600 hover:bg-green-500 text-white text-xs py-1 rounded font-bold">+100</button>
                            <button onclick="assignPoints('${player.id}', 50)" class="bg-blue-600 hover:bg-blue-500 text-white text-xs py-1 rounded font-bold">+50</button>
                            <button onclick="assignPoints('${player.id}', -50)" class="bg-red-600 hover:bg-red-500 text-white text-xs py-1 rounded font-bold">-50</button>
                        </div>
                    `;
                    monitorDiv.appendChild(div);
                });
            }
        }
    });

    socket.on('reset_buzzer_admin', () => {
        document.getElementById('buzzer-queue-admin').classList.add('hidden');
        document.getElementById('buzzer-queue-admin').innerHTML = '';
    });

    function resetBuzzer() { 
        socket.emit('buzzer_reset'); 
    }
    
    function openBuzzerStandalone() { 
        socket.emit('start_buzzer', { domanda: 'üéµ Premi quando sai la risposta!' });
        console.log('üéµ Buzzer standalone attivato');
    }
    
    function closeBuzzer() { 
        socket.emit('buzzer_close');
        console.log('üîí Buzzer chiuso');
    }

    function assignPoints(teamId, points) {
        socket.emit('admin_punti_manuali', { id: teamId, punti: points });
        console.log(`Assegnati ${points} punti a ${teamId}`);
    }

    socket.on('update_teams', (teams) => {
        totalTeams = teams.length;
        const lb = document.getElementById('leaderboard-center');
        lb.innerHTML = '';
        const sorted = teams.sort((a, b) => b.score - a.score);
        sorted.forEach((t, i) => {
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            const medal = i < 3 ? medals[i] : `${i + 1}¬∞`;
            lb.innerHTML += `
                <div class="bg-gray-800/70 rounded-lg p-2 flex items-center justify-between border border-gray-700">
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                        <span class="text-xl">${medal}</span>
                        <span class="font-bold text-white text-sm truncate">${t.name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-yellow-400 font-black text-sm">${t.score}</span>
                        <button onclick="adjustPoints('${t.id}', 50)" class="bg-green-600 hover:bg-green-500 text-white font-bold px-2 py-1 rounded text-xs">+</button>
                        <button onclick="adjustPoints('${t.id}', -50)" class="bg-red-600 hover:bg-red-500 text-white font-bold px-2 py-1 rounded text-xs">‚àí</button>
                    </div>
                </div>
            `;
        });
    });

    // ‚úÖ Funzione per aggiungere/togliere punti
    function adjustPoints(teamId, points) {
        socket.emit('assign_points', { teamId: teamId, points: points });
        console.log(`üí∞ ${points > 0 ? '+' : ''}${points} punti a ${teamId}`);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üé§ KARAOKE YOUTUBE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function playYoutubeKaraoke() {
        const videoId = document.getElementById('youtube-id-input').value.trim();
        if(!videoId) {
            alert('‚ùå Inserisci un Video ID!');
            return;
        }
        socket.emit('play_youtube_karaoke', { videoId: videoId });
        console.log('üé§ Karaoke avviato:', videoId);
    }

    function playYoutubePreset(videoId) {
        socket.emit('play_youtube_karaoke', { videoId: videoId });
        document.getElementById('youtube-id-input').value = videoId;
        console.log('üé§ Preset karaoke:', videoId);
    }

    function stopKaraoke() {
        socket.emit('stop_karaoke');
        console.log('‚èπÔ∏è Karaoke fermato');
    }

    // Ruota della Fortuna Functions
    let ruotaWinner = null;

    function ruotaStep(step) {
        switch(step) {
            case 1:
                // Spiega regole
                socket.emit('ruota_step', { step: 'explain' });
                console.log('üé∞ Spiegazione Ruota');
                break;
            case 2:
                // Gira ruota e estrae squadra
                socket.emit('ruota_step', { step: 'spin' });
                console.log('üé∞ Ruota gira...');
                break;
            case 3:
                // Mostra scelta al telefono
                if(!ruotaWinner) {
                    alert('‚ö†Ô∏è Prima gira la ruota!');
                    return;
                }
                socket.emit('ruota_step', { step: 'choice', teamId: ruotaWinner.id });
                console.log('üé∞ Mostra scelta a:', ruotaWinner.name);
                break;
            case 4:
                // Lancia domanda sfida
                if(!selectedQ) {
                    alert('‚ö†Ô∏è Seleziona una domanda prima!');
                    return;
                }
                socket.emit('ruota_step', { step: 'challenge', question: selectedQ });
                console.log('üé∞ Domanda sfida lanciata');
                break;
        }
    }

    // Riceve squadra estratta dalla ruota
    socket.on('ruota_winner', (data) => {
        ruotaWinner = data;
        document.getElementById('ruota-winner-display').classList.remove('hidden');
        document.getElementById('ruota-winner-name').textContent = data.name;
        console.log('üé∞ Estratto:', data.name);
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üî• DUELLO RUBA-PUNTI Functions
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    let duelloAttaccante = null;
    let duelloDifensore = null;
    let duelloCategoria = null;

    function duelloStep(step) {
        switch(step) {
            case 1:
                // Avvia duello - estrae attaccante
                socket.emit('duello_start');
                console.log('üî• Duello avviato');
                break;
            case 2:
                // Mostra scelta avversario
                if(!duelloAttaccante) {
                    alert('‚ö†Ô∏è Prima avvia il duello!');
                    return;
                }
                socket.emit('duello_show_opponent_choice');
                console.log('üî• Mostra scelta avversario');
                break;
            case 3:
                // Mostra scelta categoria
                if(!duelloDifensore) {
                    alert('‚ö†Ô∏è Prima scegli l\'avversario!');
                    return;
                }
                socket.emit('duello_show_category_choice');
                console.log('üî• Mostra scelta categoria');
                break;
            case 4:
                // Lancia domanda duello
                if(!duelloCategoria) {
                    alert('‚ö†Ô∏è Prima scegli la categoria!');
                    return;
                }
                if(!selectedQ) {
                    alert('‚ö†Ô∏è Seleziona una domanda dalla categoria ' + duelloCategoria + '!');
                    return;
                }
                socket.emit('duello_launch_question', { question: selectedQ });
                console.log('üî• Domanda duello lanciata');
                break;
        }
    }

    function duelloAnswerResult(correct) {
        socket.emit('duello_answer_result', { correct: correct });
        console.log('üî• Risposta:', correct ? 'CORRETTA' : 'SBAGLIATA');
    }

    // Riceve attaccante estratto
    socket.on('duello_attaccante', (data) => {
        duelloAttaccante = data.attaccante;
        document.getElementById('duello-attaccante-display').classList.remove('hidden');
        document.getElementById('duello-attaccante-name').textContent = data.attaccante.name;
        
        // Abilita step 2
        document.getElementById('duello-step-2').classList.remove('opacity-40', 'pointer-events-none');
        
        console.log('üî• Attaccante:', data.attaccante.name);
    });

    // Riceve difensore scelto
    socket.on('duello_difensore_scelto', (data) => {
        duelloDifensore = data.difensore;
        document.getElementById('duello-difensore-display').classList.remove('hidden');
        document.getElementById('duello-difensore-name').textContent = data.difensore.name;
        
        // Abilita step 3
        document.getElementById('duello-step-3').classList.remove('opacity-40', 'pointer-events-none');
        
        console.log('üî• Difensore:', data.difensore.name);
    });

    // Riceve categoria scelta
    socket.on('duello_categoria_scelta', (data) => {
        duelloCategoria = data.category;
        document.getElementById('duello-categoria-display').classList.remove('hidden');
        document.getElementById('duello-categoria-name').textContent = data.category.toUpperCase();
        
        // Abilita step 4 e mostra scoreboard
        document.getElementById('duello-step-4').classList.remove('opacity-40', 'pointer-events-none');
        document.getElementById('duello-scoreboard').classList.remove('hidden');
        
        console.log('üî• Categoria:', data.category);
    });

    // In attesa risposta (chi ha premuto buzzer)
    socket.on('duello_waiting_answer', (data) => {
        document.getElementById('duello-answer-buttons').classList.remove('hidden');
        document.getElementById('duello-current-answerer').textContent = data.teamName;
        console.log('üî• Risponde:', data.teamName, '| Risposta corretta:', data.correctAnswer);
    });

    // L'altro pu√≤ rispondere (dopo sbagliata)
    socket.on('duello_other_can_answer', (data) => {
        document.getElementById('duello-current-answerer').textContent = data.teamName;
        console.log('üî• Ora risponde:', data.teamName, '| Risposta corretta:', data.correctAnswer);
    });

    // Punto segnato
    socket.on('duello_point_scored', (data) => {
        document.getElementById('duello-score-att').textContent = data.scoreAttaccante;
        document.getElementById('duello-score-dif').textContent = data.scoreDifensore;
        document.getElementById('duello-answer-buttons').classList.add('hidden');
        console.log('üî• Score:', data.scoreAttaccante, '-', data.scoreDifensore);
    });

    // Prossima domanda
    socket.on('duello_next_question', () => {
        alert('‚úÖ Punto segnato! Lancia la prossima domanda (2 o 3)');
        console.log('üî• Pronto per prossima domanda');
    });

    // Fine duello
    socket.on('duello_end', (data) => {
        alert(`üèÜ ${data.winner.name} VINCE IL DUELLO!\n\n${data.pointsChange}`);
        
        // Reset UI duello
        duelloAttaccante = null;
        duelloDifensore = null;
        duelloCategoria = null;
        
        document.getElementById('duello-attaccante-display').classList.add('hidden');
        document.getElementById('duello-difensore-display').classList.add('hidden');
        document.getElementById('duello-categoria-display').classList.add('hidden');
        document.getElementById('duello-scoreboard').classList.add('hidden');
        document.getElementById('duello-answer-buttons').classList.add('hidden');
        
        document.getElementById('duello-step-2').classList.add('opacity-40', 'pointer-events-none');
        document.getElementById('duello-step-3').classList.add('opacity-40', 'pointer-events-none');
        document.getElementById('duello-step-4').classList.add('opacity-40', 'pointer-events-none');
        
        document.getElementById('duello-score-att').textContent = '0';
        document.getElementById('duello-score-dif').textContent = '0';
        
        console.log('üî• Duello terminato');
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üß† MEMORY GAME - ADMIN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function startMemoryGame() {
        if(confirm('üß† Avviare Memory Game (3 manche)?')) {
            socket.emit('memory_start');
            document.getElementById('memory-status').classList.remove('hidden');
            console.log('üß† Memory avviato');
        }
    }

    function skipMemoryRound() {
        socket.emit('memory_skip_round');
        console.log('üß† Round saltata');
    }

    function stopMemoryGame() {
        if(confirm('üõë Fermare Memory Game?')) {
            socket.emit('memory_stop');
            document.getElementById('memory-status').classList.add('hidden');
            console.log('üß† Memory fermato');
        }
    }

    socket.on('memory_manche_intro', (data) => {
        document.getElementById('memory-manche-display').textContent = `${data.manche}/${data.totalManches}`;
    });

    // Accordion/Collapse Toggle
    function toggleSection(section) {
        const content = document.getElementById(`content-${section}`);
        const icon = document.getElementById(`icon-${section}`);
        
        if(content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.textContent = '‚ñ≤';
        } else {
            content.classList.add('hidden');
            icon.textContent = '‚ñº';
        }
    }

    function regia(v) { socket.emit('regia_cmd', v); }
    function resetDisplays() { if(confirm("Reset?")) socket.emit('reset_displays'); }
    function resetGame() { if(confirm("‚ö†Ô∏è RESET TOTALE?")) socket.emit('reset_game'); }
    
    function mostraSoluzione() {
        if(selectedQ && selectedQ.corretta !== undefined) {
            // Invia la risposta corretta al server
            socket.emit('mostra_soluzione', { 
                soluzione: selectedQ.corretta 
            });
            console.log('üì∫ Soluzione inviata:', selectedQ.corretta);
        } else {
            alert('‚ùå Seleziona una domanda prima!');
        }
    }

    function togglePause() {
        const btn = document.getElementById('pause-btn');
        if(isPaused) {
            socket.emit('resume_game');
            btn.innerHTML = '‚è∏Ô∏è PAUSA';
            btn.className = 'px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg font-bold text-sm';
            isPaused = false;
        } else {
            socket.emit('pause_game');
            btn.innerHTML = '‚ñ∂Ô∏è RIPRENDI';
            btn.className = 'px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-bold text-sm';
            isPaused = true;
        }
    }

    function activateStep(stepNum) {
        for(let i = 1; i <= 6; i++) {
            const step = document.getElementById(`step-${i}`);
            if(step) {
                step.className = step.className.replace(' active', '');
                if(i === stepNum) step.className += ' active';
            }
        }
    }

    function showFinaleExplanation() {
        socket.emit('show_finale_explanation');
        setTimeout(() => activateStep(2), 20000);
    }

    function startFinale() {
        if(confirm('üî• Iniziare FINALE?')) {
            socket.emit('start_finale');
            finaleActive = true;
            finaleQuestionCount = 0;
            document.getElementById('finale-progress').classList.remove('hidden');
            activateStep(3);
        }
    }

    function prepareAllIn() {
        if(!selectedQ) return alert('‚ùå Seleziona domanda 1!');
        allInPrepared = true;
        socket.emit('invia_domanda_finale', {...selectedQ, modalita: 'quiz'});
        document.getElementById('allin-bets-status').classList.remove('hidden');
        document.getElementById('allin-bets-status').textContent = `üí∞ 0/${totalTeams}`;
        activateStep(4);
    }

    function showAllInQuestion() {
        socket.emit('admin_force_show_allin');
        allInPrepared = false;
        activateStep(5);
    }

    socket.on('allin_bet_placed', (data) => {
        document.getElementById('allin-bets-status').textContent = `üí∞ ${data.betsCount}/${data.totalTeams}`;
        if(data.betsCount >= data.totalTeams) {
            document.getElementById('allin-bets-status').textContent = `‚úÖ Tutti!`;
        }
    });

    function revealWinner() {
        socket.emit('reveal_winner');
        finaleActive = false;
        document.getElementById('finale-progress').classList.add('hidden');
        activateStep(1);
    }

    function updateFinaleProgress() {
        const dots = document.querySelectorAll('#finale-progress .progress-dot');
        dots.forEach((dot, i) => {
            dot.className = i < finaleQuestionCount ? 'progress-dot active' : 'progress-dot';
        });
    }

    function refreshPreview() {
        document.getElementById('mobile-preview').src = window.location.origin + '/preview';
    }

    // ‚úÖ Ricevi e mostra la risposta corretta in anticipo
    socket.on('show_correct_answer_preview', (data) => {
        const preview = document.getElementById('correct-answer-preview');
        const text = document.getElementById('correct-answer-text');
        text.textContent = `${data.corretta}`;
        preview.classList.remove('hidden');
        console.log('‚úÖ Risposta corretta:', data.corretta);
    });

    // Nascondi quando cambia domanda
    socket.on('nuova_domanda', () => {
        document.getElementById('correct-answer-preview').classList.add('hidden');
    });

    // ‚úÖ Ricevi dati delle domande all'avvio
    socket.on('questions_data', (data) => {
        dbStructure.categories = data.categories;
        dbStructure.questions = data.questions;
        populateCategories();
        console.log('üìö Categorie caricate:', data.categories);
    });

    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('mobile-preview').src = window.location.origin + '/preview';
    });

    document.addEventListener('keydown', (e) => {
        if(e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') return;
        if(e.code === 'Space') { e.preventDefault(); lanciaQuiz(); }
        if(e.code === 'KeyB') { e.preventDefault(); lanciaBuzzer(); }
        if(e.code === 'KeyP') { e.preventDefault(); togglePause(); }
    });

    // Layout Presets System
    function setLayout(type) {
        const left = document.getElementById('column-left');
        const center = document.getElementById('column-center');
        const right = document.getElementById('column-right');
        
        const layouts = {
            compact: ['15%', '35%', '50%'],   // Focus controlli
            balanced: ['20%', '40%', '40%'],  // Default
            preview: ['15%', '50%', '35%']    // Focus preview/risposte
        };
        
        const [l, c, r] = layouts[type];
        
        // Applica dimensioni con smooth transition
        left.style.width = l;
        center.style.width = c;
        right.style.width = r;
        
        // Aggiorna bottoni attivi
        document.querySelectorAll('[onclick^="setLayout"]').forEach(btn => {
            btn.className = 'px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-bold transition';
        });
        event.target.className = 'px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs font-bold transition';
        
        // Salva preferenza
        localStorage.setItem('preferredLayout', type);
        console.log(`üìê Layout: ${type.toUpperCase()} (${l} / ${c} / ${r})`);
    }
    
    // Carica layout salvato all'avvio
    window.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem('preferredLayout') || 'balanced';
        setTimeout(() => {
            const btn = document.querySelector(`[onclick="setLayout('${saved}')"]`);
            if(btn) btn.click();
        }, 100);
    });
</script>

</body>
</html>
