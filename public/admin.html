<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>REGIA - Il Quizzone</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-200 p-4 h-screen flex flex-col">

    <div class="flex justify-between items-center mb-4 bg-white p-3 rounded shadow">
        <h1 class="text-xl font-bold">üéõÔ∏è REGIA</h1>
        <div id="status" class="text-xs font-bold text-red-500 uppercase">Disconnesso</div>
    </div>

    <div class="grid grid-cols-3 gap-4 flex-1 overflow-hidden">
        
        <div class="col-span-2 flex flex-col gap-4">
            
            <div class="bg-white p-4 rounded shadow">
                <h2 class="font-bold mb-2 text-gray-700">1. Seleziona Domanda</h2>
                <div class="flex gap-2 mb-4">
                    <select id="sel-cat" class="border p-2 rounded w-1/3 bg-gray-50">
                        <option value="">-- Scegli Categoria --</option>
                    </select>
                    <select id="sel-dom" class="border p-2 rounded w-2/3 bg-gray-50" disabled>
                        <option value="">-- Prima scegli categoria --</option>
                    </select>
                </div>
                
                <div id="preview" class="p-3 bg-blue-50 border border-blue-200 rounded text-sm text-gray-600 mb-4 h-24 overflow-y-auto">
                    Nessuna domanda selezionata.
                </div>

                <div class="flex gap-2">
                    <button onclick="lancia('classico')" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700">LANCIA QUIZ (A,B,C,D)</button>
                    <button onclick="lancia('buzzer')" class="flex-1 bg-red-600 text-white font-bold py-3 rounded hover:bg-red-700">LANCIA BUZZER üö®</button>
                </div>
            </div>

            <div class="bg-white p-4 rounded shadow flex-1 flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="font-bold text-gray-700">2. Controllo Live</h2>
                    <button onclick="rivela()" class="bg-green-500 text-white px-4 py-1 rounded font-bold hover:bg-green-600 text-sm">MOSTRA SOLUZIONE</button>
                </div>
                
                <div id="log-feed" class="flex-1 bg-gray-900 text-green-400 p-2 rounded font-mono text-xs overflow-y-auto border border-black">
                    <div class="text-gray-500 italic">In attesa di risposte...</div>
                </div>
            </div>
        </div>

        <div class="bg-white p-4 rounded shadow flex flex-col">
            <h2 class="font-bold mb-2 text-gray-700 border-b pb-1">Squadre (<span id="team-cnt">0</span>)</h2>
            <div class="flex-1 overflow-y-auto">
                <table class="w-full text-sm">
                    <tbody id="team-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let selectedQuestion = null;
        let questionData = []; // Cache domande categoria corrente

        // --- SOCKET EVENTS ---
        socket.on('connect', () => {
            document.getElementById('status').innerText = "ONLINE";
            document.getElementById('status').className = "text-xs font-bold text-green-500 uppercase";
            socket.emit('admin_connect');
        });

        socket.on('init_data', (data) => {
            // Popola Categorie
            const sel = document.getElementById('sel-cat');
            sel.innerHTML = '<option value="">-- Scegli Categoria --</option>';
            data.categories.forEach(c => {
                sel.innerHTML += `<option value="${c}">${c}</option>`;
            });
            updateTeams(data.teams);
        });

        socket.on('receive_questions', (questions) => {
            questionData = questions;
            const sel = document.getElementById('sel-dom');
            sel.disabled = false;
            sel.innerHTML = '<option value="">-- Scegli Domanda --</option>';
            questions.forEach((q, idx) => {
                sel.innerHTML += `<option value="${idx}">${q.id}. ${q.domanda.substring(0,40)}...</option>`;
            });
        });

        socket.on('update_teams', (teams) => updateTeams(teams));

        socket.on('risposta_ricevuta', (data) => {
            log(`üí¨ <b>${data.teamName}</b>: ${data.risposta}`, data.teamId);
        });

        socket.on('buzzer_bloccato', (data) => {
            log(`üö® <b>BUZZER:</b> ${data.winner}`, null, 'red');
        });

        // --- UI LOGIC ---
        document.getElementById('sel-cat').addEventListener('change', (e) => {
            if(e.target.value) socket.emit('get_questions', e.target.value);
        });

        document.getElementById('sel-dom').addEventListener('change', (e) => {
            const idx = e.target.value;
            if(idx !== "") {
                selectedQuestion = questionData[idx];
                document.getElementById('preview').innerHTML = `
                    <b>Q:</b> ${selectedQuestion.domanda}<br>
                    <b>R:</b> ${selectedQuestion.risposte.join(' | ')}<br>
                    <b>Corretta:</b> ${selectedQuestion.risposte[selectedQuestion.corretta] || selectedQuestion.corretta}
                `;
            }
        });

        function lancia(mode) {
            if(!selectedQuestion) return alert("Seleziona una domanda!");
            
            // Prepara oggetto completo
            const payload = {
                ...selectedQuestion,
                modalita: mode
            };
            socket.emit('invia_domanda', payload);
            document.getElementById('log-feed').innerHTML = '<div class="text-yellow-500">--- DOMANDA LANCIATA ---</div>';
        }

        function rivela() { socket.emit('rivela_risposta'); }

        function daiPunti(id, pts) { socket.emit('assegna_punti', { teamId: id, punti: pts }); }

        function updateTeams(teams) {
            teams.sort((a,b) => b.score - a.score);
            const list = document.getElementById('team-list');
            list.innerHTML = '';
            document.getElementById('team-cnt').innerText = teams.length;
            
            teams.forEach(t => {
                list.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-2 font-bold">${t.name}</td>
                        <td class="text-right text-blue-600 font-mono">${t.score}</td>
                        <td class="text-right">
                            <button onclick="daiPunti('${t.id}', 50)" class="bg-green-100 text-green-700 px-2 rounded text-xs hover:bg-green-200">+50</button>
                        </td>
                    </tr>`;
            });
        }

        function log(msg, id, color='green') {
            const feed = document.getElementById('log-feed');
            let btn = id ? `<button onclick="daiPunti('${id}', 50)" class="bg-${color}-600 text-white px-1 ml-2 rounded text-[10px]">OK</button>` : '';
            feed.innerHTML = `<div class="mb-1 pb-1 border-b border-gray-700 flex justify-between"><span>${msg}</span>${btn}</div>` + feed.innerHTML;
        }
    </script>
</body>
</html>
