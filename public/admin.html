<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>REGIA - Il Quizzone</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-200 p-4 h-screen flex flex-col">

    <div class="flex justify-between items-center mb-4 bg-white p-3 rounded shadow">
        <h1 class="text-xl font-bold text-gray-800">üéõÔ∏è REGIA MASTER</h1>
        <div id="status" class="text-xs font-bold text-red-500 uppercase">Connessione...</div>
    </div>

    <div class="grid grid-cols-3 gap-4 flex-1 overflow-hidden">
        
        <div class="col-span-2 flex flex-col gap-4">
            
            <div class="bg-white p-4 rounded shadow">
                <h2 class="font-bold mb-3 text-gray-700 border-b pb-2">1. Selezione Gioco</h2>
                
                <div class="flex gap-2 mb-3">
                    <select id="sel-tipo" class="border-2 border-blue-500 p-2 rounded w-1/3 font-bold text-blue-900">
                        <option value="">-- TIPO GIOCO --</option>
                        <option value="categorie">üìÇ CATEGORIE</option>
                        <option value="bonus">üí∞ BONUS</option>
                        <option value="raffica">‚ö° RAFFICA</option>
                    </select>

                    <select id="sel-cat" class="border p-2 rounded w-2/3 bg-gray-50 disabled:bg-gray-200" disabled>
                        <option value="">-- Scegli Materia --</option>
                    </select>
                </div>

                <div class="mb-3">
                    <select id="sel-dom" class="w-full border p-2 rounded bg-gray-50 disabled:bg-gray-200" disabled>
                        <option value="">-- Prima scegli il tipo --</option>
                    </select>
                </div>
                
                <div id="preview" class="p-3 bg-blue-50 border border-blue-200 rounded text-sm text-gray-600 mb-4 h-24 overflow-y-auto">
                    Seleziona una domanda per vedere l'anteprima.
                </div>

                <div class="flex gap-2">
                    <button onclick="lancia('classico')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded shadow transition">
                        LANCIA (Quiz Classico)
                    </button>
                    <button onclick="lancia('buzzer')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded shadow transition">
                        LANCIA (Buzzer)
                    </button>
                </div>
            </div>

            <div class="bg-white p-4 rounded shadow flex-1 flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="font-bold text-gray-700">2. Controllo Live</h2>
                    <button onclick="rivela()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-1 rounded font-bold shadow animate-pulse">
                        SVELA RISPOSTA
                    </button>
                </div>
                <div id="log-feed" class="flex-1 bg-gray-900 text-green-400 p-2 rounded font-mono text-xs overflow-y-auto border border-black shadow-inner">
                    <div class="text-gray-500 italic">Attendo risposte...</div>
                </div>
            </div>
        </div>

        <div class="bg-white p-4 rounded shadow flex flex-col">
            <h2 class="font-bold mb-2 text-gray-700 border-b pb-1">Squadre (<span id="team-cnt">0</span>)</h2>
            <div class="flex-1 overflow-y-auto">
                <table class="w-full text-sm text-left">
                    <tbody id="team-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentQuestions = [];
        let selectedQ = null;
        let dbStructure = {};

        socket.on('connect', () => {
            document.getElementById('status').innerText = "ONLINE";
            document.getElementById('status').className = "text-xs font-bold text-green-500 uppercase";
            socket.emit('admin_connect');
        });

        socket.on('init_data', (data) => {
            dbStructure = data;
            updateTeams(data.teams);
        });

        socket.on('receive_questions', (questions) => {
            currentQuestions = questions;
            const selDom = document.getElementById('sel-dom');
            selDom.disabled = false;
            selDom.innerHTML = '<option value="">-- Seleziona Domanda --</option>';
            questions.forEach((q, idx) => {
                let text = q.domanda.length > 60 ? q.domanda.substring(0,60) + "..." : q.domanda;
                let pts = q.punti ? `[${q.punti}pt]` : ""; 
                selDom.innerHTML += `<option value="${idx}">${q.id}. ${pts} ${text}</option>`;
            });
        });

        socket.on('update_teams', updateTeams);
        
        socket.on('risposta_ricevuta', (data) => {
            log(`üí¨ <b>${data.teamName}</b>: ${data.risposta}`, data.teamId);
        });

        socket.on('buzzer_bloccato', (data) => {
            log(`üö® <b>BUZZER:</b> ${data.winner}`, null, 'red');
        });

        // MENU CHANGE HANDLERS
        document.getElementById('sel-tipo').addEventListener('change', (e) => {
            const type = e.target.value;
            const selCat = document.getElementById('sel-cat');
            const selDom = document.getElementById('sel-dom');
            
            selCat.innerHTML = '<option value="">-- Scegli --</option>';
            selDom.innerHTML = '<option value="">-- --</option>';
            selDom.disabled = true;
            selCat.disabled = true;

            if (type === 'categorie') {
                selCat.disabled = false;
                dbStructure.categories.forEach(c => {
                    selCat.innerHTML += `<option value="${c}">${c.toUpperCase()}</option>`;
                });
            } else if (type === 'bonus' || type === 'raffica') {
                socket.emit('get_questions', { type: type });
            }
        });

        document.getElementById('sel-cat').addEventListener('change', (e) => {
            const cat = e.target.value;
            if(cat) socket.emit('get_questions', { type: 'categoria', key: cat });
        });

        document.getElementById('sel-dom').addEventListener('change', (e) => {
            const idx = e.target.value;
            if (idx !== "") {
                selectedQ = currentQuestions[idx];
                let rispHTML = "";
                if(selectedQ.risposte) {
                    rispHTML = selectedQ.risposte.map((r, i) => 
                        (i === selectedQ.corretta ? `<b class="text-green-600">${r}</b>` : r)
                    ).join(' | ');
                }
                document.getElementById('preview').innerHTML = `
                    <div class="font-bold text-blue-800">${selectedQ.domanda}</div>
                    <div class="mt-1 text-xs text-gray-500">Risposte: ${rispHTML}</div>
                    <div class="mt-1 text-xs font-bold text-purple-600">Punti: ${selectedQ.punti || 0}</div>
                `;
            }
        });

        function lancia(mode) {
            if(!selectedQ) return alert("Seleziona una domanda!");
            const payload = { ...selectedQ, modalita: mode };
            socket.emit('invia_domanda', payload);
            document.getElementById('log-feed').innerHTML = 
                `<div class="text-yellow-400 font-bold border-b border-yellow-600 mb-2">üöÄ DOMANDA LANCIATA (${mode.toUpperCase()})</div>`;
        }

        function rivela() { socket.emit('rivela_risposta'); }
        function daiPunti(id, pts) { socket.emit('assegna_punti', { teamId: id, punti: pts }); }

        function updateTeams(teams) {
            teams.sort((a,b) => b.score - a.score);
            const list = document.getElementById('team-list');
            list.innerHTML = '';
            document.getElementById('team-cnt').innerText = teams.length;
            teams.forEach(t => {
                list.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-2 font-bold">${t.name}</td>
                        <td class="text-right text-blue-600 font-mono">${t.score}</td>
                        <td class="text-right">
                            <button onclick="daiPunti('${t.id}', 50)" class="bg-green-100 text-green-700 px-2 rounded text-xs hover:bg-green-200">+50</button>
                        </td>
                    </tr>`;
            });
        }

        function log(msg, id, color='green') {
            const feed = document.getElementById('log-feed');
            let btn = id ? `<button onclick="daiPunti('${id}', 50)" class="ml-2 bg-${color}-600 text-white px-2 rounded text-[10px]">OK (+50)</button>` : '';
            feed.innerHTML = `<div class="mb-1 pb-1 border-b border-gray-700 flex justify-between items-center"><span>${msg}</span>${btn}</div>` + feed.innerHTML;
        }
    </script>
</body>
</html>
