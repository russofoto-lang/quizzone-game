<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Control Center - Siponto</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/audio-engine.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <style>
        body { background: #070b14; color: white; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        .font-display { font-family: 'Orbitron', 'Inter', sans-serif; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #6366f1); transition: all 0.15s; border: 1px solid rgba(99,102,241,0.3); }
        .btn-primary:hover { background: linear-gradient(135deg, #2563eb, #4f46e5); transform: scale(1.02); box-shadow: 0 0 16px rgba(59,130,246,0.4); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); border: 1px solid rgba(16,185,129,0.3); }
        .btn-success:hover { background: linear-gradient(135deg, #059669, #047857); box-shadow: 0 0 16px rgba(16,185,129,0.4); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); border: 1px solid rgba(245,158,11,0.3); }
        .btn-warning:hover { background: linear-gradient(135deg, #d97706, #b45309); box-shadow: 0 0 16px rgba(245,158,11,0.4); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); border: 1px solid rgba(239,68,68,0.3); }
        .btn-danger:hover { background: linear-gradient(135deg, #dc2626, #b91c1c); box-shadow: 0 0 16px rgba(239,68,68,0.4); }
        .btn-scene { background: rgba(31,41,55,0.8); transition: all 0.15s; padding: 8px; border-radius: 8px; cursor: pointer; border: 1px solid rgba(255,255,255,0.06); }
        .btn-scene:hover { background: rgba(55,65,81,0.8); transform: scale(1.05); border-color: rgba(255,255,255,0.12); }
        .btn-scene.active { background: rgba(16,185,129,0.3); border-color: #10b981; box-shadow: 0 0 16px rgba(16,185,129,0.3); }
        .progress-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin: 0 2px; background: #1e293b; }
        .progress-dot.active { background: #ef4444; box-shadow: 0 0 10px rgba(239,68,68,0.6); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .step-btn { opacity: 0.4; pointer-events: none; }
        .step-btn.active { opacity: 1; pointer-events: auto; }
        .preview-frame { background: #000; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .admin-panel { background: rgba(15,23,42,0.6); border: 1px solid rgba(255,255,255,0.06); border-radius: 0.5rem; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

<!-- HEADER MINIMAL -->
<div class="px-4 py-2 border-b border-white/10" style="background: linear-gradient(90deg, rgba(7,11,20,0.95), rgba(15,23,42,0.95));">
    <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
            <h1 class="font-display font-black text-xl text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-orange-400 to-red-500">CONTROL CENTER</h1>
            <span id="question-counter" class="text-lg font-bold text-gray-400">Q: 0</span>
        </div>
        
        <!-- Layout Presets -->
        <div class="flex items-center gap-2">
            <div class="flex gap-1 mr-3 bg-gray-900/50 rounded-lg p-1 border border-gray-700">
                <button onclick="setLayout('compact')" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-bold transition">
                    ğŸ“± Compatto
                </button>
                <button onclick="setLayout('balanced')" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs font-bold transition" id="layout-balanced">
                    âš–ï¸ Bilanciato
                </button>
                <button onclick="setLayout('preview')" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-bold transition">
                    ğŸ” Preview
                </button>
            </div>
            
            <button onclick="togglePause()" id="pause-btn" class="px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg font-bold text-sm">â¸ï¸ PAUSA</button>
            <button onclick="resetGame()" class="px-3 py-2 bg-red-900 hover:bg-red-800 rounded-lg font-bold text-xs opacity-60">Reset</button>
        </div>
    </div>
</div>

<!-- LAYOUT: 20-40-40 -->
<div class="flex-1 flex gap-2 p-2 overflow-hidden">
    
    <!-- COLONNA SINISTRA: MOTORE (20%) -->
    <div id="column-left" class="w-1/5 flex flex-col gap-2 transition-all duration-300">
        <!-- Selezione -->
        <div class="admin-panel p-2">
            <div class="text-sm font-bold text-blue-400 mb-1 uppercase">ğŸ“š Selezione</div>
            <select id="sel-tipo" class="w-full bg-gray-800 text-white p-2 rounded text-sm font-bold border border-gray-700 mb-1">
                <option value="">Tipo</option>
                <option value="categoria">ğŸ“š Categorie</option>
                <option value="stima">ğŸ”¢ Stima</option>
                <option value="anagramma">ğŸ”¤ Anagramma</option>
                <option value="bonus">â­ Bonus</option>
            </select>
            <select id="sel-cat" class="w-full bg-gray-800 text-white p-2 rounded text-sm font-bold border border-gray-700" disabled>
                <option value="">Categoria</option>
            </select>
        </div>

        <!-- Lista Domande -->
        <div class="flex-1 admin-panel p-2 overflow-hidden">
            <div class="text-sm font-bold text-blue-400 mb-1 uppercase">ğŸ“‹ Domande</div>
            <div id="questions-container" class="overflow-y-auto h-full text-xs">
                <div class="text-gray-500 text-center py-4">Seleziona tipo...</div>
            </div>
        </div>

        <!-- Azioni Lancio -->
        <div class="admin-panel p-2">
            <button onclick="lanciaQuiz()" class="w-full btn-primary text-white font-bold py-3 rounded-lg mb-1 text-sm">
                ğŸ¯ LANCIA QUIZ
            </button>
            <button onclick="lanciaBuzzer()" class="w-full btn-danger text-white font-bold py-3 rounded-lg text-sm">
                âš¡ LANCIA BUZZER
            </button>
        </div>
    </div>

    <!-- COLONNA CENTRO: PREVIEW + RISPOSTE + CLASSIFICA (40%) -->
    <div id="column-center" class="w-2/5 flex flex-col gap-2 transition-all duration-300">
        <!-- Preview Ridotta -->
        <div class="h-40 admin-panel p-2 overflow-hidden">
            <div class="flex justify-between items-center mb-1">
                <div class="text-sm font-bold text-purple-400 uppercase">ğŸ“± Preview</div>
                <button onclick="refreshPreview()" class="text-xs bg-gray-800 px-2 py-0.5 rounded hover:bg-gray-700 font-bold">ğŸ”„</button>
            </div>
            <div class="preview-frame h-full overflow-hidden">
                <iframe id="mobile-preview" src="" class="w-full h-full border-0 pointer-events-none" style="transform: scale(0.32); transform-origin: top left; width: 313%; height: 313%;"></iframe>
            </div>
        </div>

        <!-- Monitor Risposte - PIÃ™ GRANDE -->
        <div class="h-56 admin-panel p-2 overflow-hidden">
            <div class="flex justify-between items-center mb-1">
                <div class="text-sm font-bold text-green-400 uppercase">âš¡ Risposte</div>
                <span id="answers-count" class="text-xs bg-gray-800 px-2 py-0.5 rounded font-bold">0/10</span>
            </div>
            <div id="answers-list" class="overflow-y-auto h-48 space-y-1 text-sm"></div>
            <div id="buzzer-monitor" class="hidden overflow-y-auto h-48 space-y-1 text-sm"></div>
        </div>

        <!-- Risposta Corretta Preview -->
        <div id="correct-answer-preview" class="hidden bg-green-900/50 rounded-lg p-3 border border-green-500 mb-2">
            <div class="text-sm font-bold text-green-400 mb-1 uppercase">âœ… Risposta Corretta</div>
            <div id="correct-answer-text" class="text-lg font-black text-white"></div>
        </div>

        <!-- Classifica 2 Colonne - RIDOTTA -->
        <div class="flex-1 admin-panel p-2 overflow-hidden">
            <div class="text-sm font-bold text-yellow-400 mb-1 uppercase">ğŸ“Š Classifica</div>
            <div id="leaderboard-center" class="grid grid-cols-2 gap-1 text-sm overflow-y-auto max-h-40"></div>
        </div>
    </div>

    <!-- COLONNA DESTRA: MIXER (40%) -->
    <div id="column-right" class="w-2/5 flex flex-col gap-2 overflow-y-auto transition-all duration-300">
        
        <!-- Scene/Display -->
        <div class="admin-panel p-2">
            <div class="text-sm font-bold text-blue-400 mb-2 uppercase">ğŸ“º Scene</div>
            <div class="grid grid-cols-4 gap-1 mb-2">
                <div onclick="regia('logo')" class="btn-scene text-center text-xs font-bold">
                    <div class="text-lg">ğŸ“±</div>
                    <div>QR</div>
                </div>
                <div onclick="regia('gioco')" class="btn-scene text-center text-xs font-bold">
                    <div class="text-lg">ğŸ®</div>
                    <div>Game</div>
                </div>
                <div onclick="regia('classifica_round')" class="btn-scene text-center text-xs font-bold">
                    <div class="text-lg">ğŸ†</div>
                    <div>Pod</div>
                </div>
                <div onclick="regia('classifica_gen')" class="btn-scene text-center text-xs font-bold">
                    <div class="text-lg">ğŸ“Š</div>
                    <div>Cls</div>
                </div>
            </div>
            <div class="grid grid-cols-6 gap-1 mb-1">
                <div onclick="regia('benvenuto')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>ğŸ‰</div>
                    <div>Ben</div>
                </div>
                <div onclick="regia('regole')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>ğŸ“‹</div>
                    <div>Reg</div>
                </div>
                <div onclick="regia('punteggi')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>ğŸ¯</div>
                    <div>Pun</div>
                </div>
                <div onclick="regia('prossima')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>â°</div>
                    <div>Pros</div>
                </div>
                <div onclick="regia('logo_forever')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>ğŸ®</div>
                    <div>Logo</div>
                </div>
                <!-- BOTTONE MOSTRA VINCITORE -->
                <div onclick="socket.emit('show_winner')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>ğŸ‘‘</div>
                    <div>Win</div>
                </div>
            </div>
            <!-- âœ… NUOVO: Reset Round per podio -->
            <button onclick="regia('reset_round')" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-1 rounded text-[10px]">
                ğŸ”„ Reset Round
            </button>
        </div>

        <!-- Azioni Rapide -->
        <div class="admin-panel p-2">
            <div class="text-sm font-bold text-green-400 mb-2 uppercase">âš¡ Azioni</div>
            <div class="grid grid-cols-2 gap-1">
                <!-- BOTTONE SOLUZIONE CORRETTO -->
                <button onclick="mostraSoluzione()" class="btn-warning text-white font-bold py-2 rounded text-sm">
                    ğŸ“º Soluzione
                </button>
                <button onclick="resetDisplays()" class="btn-danger text-white font-bold py-2 rounded text-sm">
                    ğŸ”„ Reset Disp
                </button>
            </div>
        </div>

        <!-- Buzzer Musicale - COLLAPSIBLE -->
        <div class="bg-purple-900/20 rounded-lg border border-purple-700">
            <button onclick="toggleSection('musicale')" class="w-full flex justify-between items-center p-2 hover:bg-purple-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-purple-300 uppercase">ğŸµ Gioco Musicale</div>
                <span id="icon-musicale" class="text-purple-300 font-bold text-lg">â–¼</span>
            </button>
            <div id="content-musicale" class="hidden p-2 pt-0">
                <div class="grid grid-cols-3 gap-1 mb-2">
                    <button onclick="openBuzzerStandalone()" class="btn-success text-white font-bold py-2 rounded text-sm">
                        ğŸ”“ Apri
                    </button>
                    <button onclick="closeBuzzer()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 rounded text-sm">
                        ğŸ”’ Blocca
                    </button>
                    <button onclick="resetBuzzer()" class="btn-primary text-white font-bold py-2 rounded text-sm">
                        ğŸ”„ Reset
                    </button>
            </div>
                <div id="buzzer-queue-admin" class="hidden space-y-1 text-sm max-h-24 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Karaoke YouTube - COLLAPSIBLE -->
        <div class="bg-pink-900/20 rounded-lg border border-pink-700">
            <button onclick="toggleSection('karaoke')" class="w-full flex justify-between items-center p-2 hover:bg-pink-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-pink-300 uppercase">ğŸ¤ Karaoke YouTube</div>
                <span id="icon-karaoke" class="text-pink-300 font-bold text-lg">â–¼</span>
            </button>
            <div id="content-karaoke" class="hidden p-2 pt-0">
                <!-- Input Libero -->
                <div class="mb-2">
                    <input type="text" id="youtube-id-input" placeholder="ID Video (es: dQw4w9WgXcQ)" 
                           class="w-full bg-gray-800 text-white text-xs p-2 rounded border border-gray-700 mb-1">
                    <div class="grid grid-cols-2 gap-1">
                        <button onclick="playYoutubeKaraoke()" class="btn-success text-white font-bold py-2 rounded text-sm">
                            â–¶ï¸ Play
                        </button>
                        <button onclick="stopKaraoke()" class="btn-danger text-white font-bold py-2 rounded text-sm">
                            â¹ï¸ Stop
                        </button>
                    </div>
                </div>
                
                <!-- Preset Videos -->
                <div class="text-xs text-gray-400 mb-1">Preset:</div>
                <div class="space-y-1">
                    <button onclick="playYoutubePreset('fKo44V64XnA')" class="w-full bg-pink-800 hover:bg-pink-700 text-white font-bold py-1.5 rounded text-xs">
                        ğŸµ Come Mai - 883
                    </button>
                    <button onclick="playYoutubePreset('xHKfX5299kc')" class="w-full bg-pink-800 hover:bg-pink-700 text-white font-bold py-1.5 rounded text-xs">
                        ğŸµ PiÃ¹ Bella Cosa - Ramazzotti
                    </button>
                    <button onclick="playYoutubePreset('aVli1cR51sM')" class="w-full bg-pink-800 hover:bg-pink-700 text-white font-bold py-1.5 rounded text-xs">
                        ğŸµ FelicitÃ  - Albano
                    </button>
                </div>
            </div>
        </div>

        <!-- ğŸ”Š EFFETTI AUDIO - COLLAPSIBLE -->
        <div class="bg-cyan-900/20 rounded-lg border border-cyan-700">
            <button onclick="toggleSection('audio')" class="w-full flex justify-between items-center p-2 hover:bg-cyan-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-cyan-300 uppercase">ğŸ”Š Effetti Audio</div>
                <span id="icon-audio" class="text-cyan-300 font-bold text-lg">â–¼</span>
            </button>
            <div id="content-audio" class="hidden p-2 pt-0">
                <!-- Toggle + Volume -->
                <div class="flex items-center gap-2 mb-2">
                    <button onclick="toggleAudioEnabled()" id="audio-toggle-btn" class="flex-1 btn-success text-white font-bold py-1.5 rounded text-xs">
                        ğŸ”Š ON
                    </button>
                    <input type="range" id="audio-volume" min="0" max="100" value="50"
                           class="flex-1 h-2 accent-cyan-400" onchange="setAudioVolume(this.value)">
                    <span id="audio-volume-label" class="text-xs text-gray-400 w-8">50%</span>
                </div>

                <!-- Pulsanti Effetti Rapidi -->
                <div class="text-xs text-gray-400 mb-1">Effetti manuali:</div>
                <div class="grid grid-cols-3 gap-1 mb-1">
                    <button onclick="playSfx('gong')" class="bg-cyan-800 hover:bg-cyan-700 text-white font-bold py-1.5 rounded text-xs">
                        ğŸ”” Gong
                    </button>
                    <button onclick="playSfx('fanfare')" class="bg-cyan-800 hover:bg-cyan-700 text-white font-bold py-1.5 rounded text-xs">
                        ğŸº Fanfare
                    </button>
                    <button onclick="playSfx('drumroll', 3)" class="bg-cyan-800 hover:bg-cyan-700 text-white font-bold py-1.5 rounded text-xs">
                        ğŸ¥ Rullo
                    </button>
                </div>
                <div class="grid grid-cols-3 gap-1 mb-1">
                    <button onclick="playSfx('correct')" class="bg-green-800 hover:bg-green-700 text-white font-bold py-1.5 rounded text-xs">
                        âœ… Corretto
                    </button>
                    <button onclick="playSfx('wrong')" class="bg-red-800 hover:bg-red-700 text-white font-bold py-1.5 rounded text-xs">
                        âŒ Sbagliato
                    </button>
                    <button onclick="playSfx('buzzer')" class="bg-yellow-800 hover:bg-yellow-700 text-white font-bold py-1.5 rounded text-xs">
                        âš¡ Buzzer
                    </button>
                </div>
                <div class="grid grid-cols-3 gap-1 mb-1">
                    <button onclick="playSfx('timesUp')" class="bg-orange-800 hover:bg-orange-700 text-white font-bold py-1.5 rounded text-xs">
                        â° Tempo!
                    </button>
                    <button onclick="playSfx('suspense', 5)" class="bg-purple-800 hover:bg-purple-700 text-white font-bold py-1.5 rounded text-xs">
                        ğŸ˜± Suspense
                    </button>
                    <button onclick="playSfx('reveal')" class="bg-indigo-800 hover:bg-indigo-700 text-white font-bold py-1.5 rounded text-xs">
                        ğŸ­ Reveal
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-1">
                    <button onclick="playSfx('countdownBeeps', 5)" class="bg-red-900 hover:bg-red-800 text-white font-bold py-1.5 rounded text-xs">
                        â³ Countdown 5s
                    </button>
                    <button onclick="playSfx('wheelSpin', 4)" class="bg-yellow-900 hover:bg-yellow-800 text-white font-bold py-1.5 rounded text-xs">
                        ğŸ° Ruota Spin
                    </button>
                </div>
            </div>
        </div>

        <!-- Ruota della Fortuna - COLLAPSIBLE -->
        <div class="bg-yellow-900/20 rounded-lg border border-yellow-700">
            <button onclick="toggleSection('ruota')" class="w-full flex justify-between items-center p-2 hover:bg-yellow-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-yellow-300 uppercase">ğŸ° Ruota Fortuna</div>
                <span id="icon-ruota" class="text-yellow-300 font-bold text-lg">â–¼</span>
            </button>
            <div id="content-ruota" class="hidden p-2 pt-0">
                <div class="space-y-1">
                    <button onclick="ruotaStep(1)" class="w-full btn-primary text-white font-bold py-2 rounded text-sm">
                        1ï¸âƒ£ Spiega Regole
                    </button>
                    <button onclick="ruotaStep(2)" class="w-full btn-warning text-white font-bold py-2 rounded text-sm">
                        2ï¸âƒ£ Gira Ruota
                    </button>
                    <button onclick="ruotaStep(3)" class="w-full btn-success text-white font-bold py-2 rounded text-sm">
                        3ï¸âƒ£ Mostra Scelta
                    </button>
                    <div id="ruota-winner-display" class="hidden text-xs text-center py-2 bg-yellow-900/30 rounded font-bold">
                        Estratto: <span id="ruota-winner-name">---</span>
                    </div>
                    <button onclick="ruotaStep(4)" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 rounded text-sm">
                        4ï¸âƒ£ Lancia Domanda Sfida
                    </button>
                </div>
            </div>
        </div>

        <!-- DUELLO RUBA-PUNTI - COLLAPSIBLE -->
        <div class="bg-red-900/20 rounded-lg border border-red-700">
            <button onclick="toggleSection('duello')" class="w-full flex justify-between items-center p-2 hover:bg-red-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-red-300 uppercase">ğŸ”¥ Duello Ruba-Punti</div>
                <span id="icon-duello" class="text-red-300 font-bold text-lg">â–¼</span>
            </button>
            <div id="content-duello" class="hidden p-2 pt-0">
                <div class="space-y-1">
                    <button onclick="duelloStep(1)" id="duello-step-1" class="w-full btn-primary text-white font-bold py-2 rounded text-sm">
                        1ï¸âƒ£ Avvia Duello
                    </button>
                    <div id="duello-attaccante-display" class="hidden text-xs text-center py-2 bg-red-900/40 rounded font-bold border border-red-700">
                        <div class="text-yellow-400">ATTACCANTE:</div>
                        <div id="duello-attaccante-name" class="text-white text-sm">---</div>
                    </div>
                    <button onclick="duelloStep(2)" id="duello-step-2" class="w-full btn-warning text-white font-bold py-2 rounded text-sm opacity-40 pointer-events-none">
                        2ï¸âƒ£ Scelta Avversario
                    </button>
                    <div id="duello-difensore-display" class="hidden text-xs text-center py-2 bg-blue-900/40 rounded font-bold border border-blue-700">
                        <div class="text-blue-400">DIFENSORE:</div>
                        <div id="duello-difensore-name" class="text-white text-sm">---</div>
                    </div>
                    <button onclick="duelloStep(3)" id="duello-step-3" class="w-full btn-success text-white font-bold py-2 rounded text-sm opacity-40 pointer-events-none">
                        3ï¸âƒ£ Scelta Categoria
                    </button>
                    <div id="duello-categoria-display" class="hidden text-xs text-center py-2 bg-purple-900/40 rounded font-bold border border-purple-700">
                        <div class="text-purple-400">CATEGORIA:</div>
                        <div id="duello-categoria-name" class="text-white text-sm">---</div>
                    </div>
                    <div class="border-t border-red-700 my-2 pt-2">
                        <div class="text-xs text-center text-gray-400 mb-1">DOMANDA DUELLO</div>
                        <button onclick="duelloStep(4)" id="duello-step-4" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 rounded text-sm opacity-40 pointer-events-none">
                            ğŸ¯ Lancia Domanda
                        </button>
                    </div>
                    <div id="duello-scoreboard" class="hidden text-center py-2 bg-black/40 rounded border border-gray-700">
                        <div class="flex justify-center items-center gap-3 text-2xl font-black">
                            <span id="duello-score-att" class="text-yellow-400">0</span>
                            <span class="text-white">-</span>
                            <span id="duello-score-dif" class="text-blue-400">0</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">Primo a 2 vince</div>
                    </div>
                    <div id="duello-answer-buttons" class="hidden space-y-1 border-t border-red-700 pt-2">
                        <div class="text-xs text-center text-yellow-400 mb-1">
                            Risponde: <span id="duello-current-answerer">---</span>
                        </div>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="duelloAnswerResult(true)" class="btn-success text-white font-bold py-2 rounded text-sm">
                                âœ… CORRETTO
                            </button>
                            <button onclick="duelloAnswerResult(false)" class="btn-danger text-white font-bold py-2 rounded text-sm">
                                âŒ SBAGLIATO
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MEMORY GAME - COLLAPSIBLE -->
        <div class="bg-purple-900/20 rounded-lg border border-purple-700">
            <button onclick="toggleSection('memory')" class="w-full flex justify-between items-center p-2 hover:bg-purple-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-purple-300 uppercase">ğŸ§  Memory Game</div>
                <span id="icon-memory" class="text-purple-300 font-bold text-lg">â–¼</span>
            </button>
            <div id="content-memory" class="hidden p-2 pt-0">
                <div class="space-y-1">
                    <button onclick="startMemoryGame()" class="w-full btn-primary text-white font-bold py-2 rounded text-sm">
                        ğŸ® AVVIA MEMORY
                    </button>
                    <div id="memory-status" class="hidden text-xs text-center py-2 bg-purple-900/30 rounded font-bold">
                        Manche: <span id="memory-manche-display">1/3</span>
                    </div>
                    <div class="grid grid-cols-2 gap-1">
                        <button onclick="skipMemoryRound()" class="btn-warning text-white font-bold py-2 rounded text-sm">
                            â­ï¸ Skip Round
                        </button>
                        <button onclick="stopMemoryGame()" class="btn-danger text-white font-bold py-2 rounded text-sm">
                            ğŸ›‘ Stop
                        </button>
                        </div>
                </div>
            </div>
        </div>

        <!-- âœ… FIX COMPLETO: Sfida Finale - COLLAPSIBLE -->
        <div class="bg-red-900/20 rounded-lg border border-red-700">
            <button onclick="toggleSection('finale')" class="w-full flex justify-between items-center p-2 hover:bg-red-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-red-300 uppercase">ğŸ”¥ Sfida Finale</div>
                <span id="icon-finale" class="text-red-300 font-bold text-lg">â–¼</span>
            </button>
            <div id="content-finale" class="hidden p-2 pt-0">
                <div class="space-y-1">
                    <button onclick="showFinaleExplanation()" id="step-1" class="step-btn active w-full btn-primary text-white font-bold py-2 rounded text-sm">
                        1ï¸âƒ£ Spiega Regole
                    </button>
                    <button onclick="startFinale()" id="step-2" class="step-btn w-full btn-danger text-white font-bold py-2 rounded text-sm">
                        2ï¸âƒ£ Attiva Finale
                    </button>
                    <button onclick="prepareAllIn()" id="step-3" class="step-btn w-full btn-warning text-white font-bold py-2 rounded text-sm">
                        3ï¸âƒ£ Prepara ALL IN
                    </button>
                    <div id="allin-bets-status" class="hidden text-xs text-center text-yellow-400 py-1 font-bold">
                        ğŸ’° <span id="allin-counter">0</span>/<span id="allin-total">0</span> squadre
                    </div>
                    <button onclick="showAllInResults()" id="step-4" class="step-btn w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 rounded text-sm">
                        4ï¸âƒ£ Mostra Risultati
                    </button>
                    <button onclick="processAllIn()" id="step-5" class="step-btn w-full btn-success text-white font-bold py-2 rounded text-sm">
                        5ï¸âƒ£ Elabora Punteggi
                    </button>
                    <div id="step-6" class="step-btn text-xs text-gray-400 text-center py-1">
                        6ï¸âƒ£ Lancia domande 2-5 (x2)
                    </div>
                    <button onclick="revealWinner()" id="step-6-btn" class="step-btn w-full btn-warning text-white font-bold py-2 rounded text-sm">
                        7ï¸âƒ£ RIVELA VINCITORE ğŸ‘‘
                    </button>
                    <div id="finale-progress" class="hidden text-center py-1">
                        <span class="progress-dot"></span>
                        <span class="progress-dot"></span>
                        <span class="progress-dot"></span>
                        <span class="progress-dot"></span>
                        <span class="progress-dot"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ğŸ’€ IL PATTO COL DESTINO - COLLAPSIBLE -->
        <div class="bg-purple-900/20 rounded-lg border border-purple-700">
            <button onclick="toggleSection('patto')" class="w-full flex justify-between items-center p-2 hover:bg-purple-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-purple-300 uppercase">ğŸ’€ Il Patto col Destino</div>
                <span id="icon-patto" class="text-purple-300 font-bold text-lg">â–¼</span>
            </button>
            <div id="content-patto" class="hidden p-2 pt-0">
                <div class="space-y-1">
                    <button onclick="pattoShowRegole()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded text-sm">
                        ğŸ“œ Spiega Regole
                    </button>
                    <button onclick="pattoAvvia()" id="patto-avvia-btn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 rounded text-sm">
                        ğŸ² AVVIA PATTO
                    </button>
                    <div id="patto-utilizzi-display" class="text-xs text-center py-2 bg-purple-900/30 rounded font-bold">
                        Utilizzi: <span id="patto-usi">0</span>/2
                    </div>
                    <div id="patto-status" class="hidden text-xs text-center py-2 rounded font-bold">
                        <!-- Popolato dinamicamente -->
                    </div>
                    <div id="patto-scelte-status" class="hidden text-xs space-y-1">
                        <!-- Mostra chi ha scelto -->
                    </div>
                    <button onclick="pattoReset()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-1.5 rounded text-xs">
                        ğŸ”„ Reset
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let currentQuestions = [], selectedQ = null, dbStructure = {};
    let isPaused = false, finaleActive = false, finaleQuestionCount = 0;
    let totalQuestionsAsked = 0, allInPrepared = false, totalTeams = 0;
    let gameState = { teams: {} }; // Stato temporaneo

    socket.on('connect', () => { socket.emit('admin_connect'); });
    
    socket.on('init_data', (d) => { 
        dbStructure = d; 
        totalTeams = d.teams.length;
        updateTeams(d.teams); 
        populateCategories();
        // âœ… Carica automaticamente la preview all'avvio
        refreshPreview();
    });

    function populateCategories() {
        const sc = document.getElementById('sel-cat');
        sc.innerHTML = '<option value="">Categoria</option>';
        if(dbStructure.categories) {
            dbStructure.categories.forEach(c => {
                sc.innerHTML += `<option value="${c}">${c.replace(/_/g,' ')}</option>`;
            });
        }
    }

    document.getElementById('sel-tipo').addEventListener('change', (e) => {
        const t = e.target.value;
        const sc = document.getElementById('sel-cat');
        if(t === 'categoria') {
            sc.disabled = false;
        } else {
            sc.disabled = true;
            if(t) socket.emit('get_questions', {type: t});
        }
    });

    document.getElementById('sel-cat').addEventListener('change', (e) => {
        if(e.target.value) socket.emit('get_questions', {type: 'categoria', category: e.target.value});
    });

    socket.on('questions_list', (q) => {  // âœ… FIX: Era 'receive_questions'
        currentQuestions = q;
        showQuestionsList(q);
    });

    function showQuestionsList(questions) {
        const container = document.getElementById('questions-container');
        container.innerHTML = '';
        
        questions.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'p-2 bg-gray-800 rounded mb-1 cursor-pointer hover:bg-gray-700 border border-gray-700';
            div.innerHTML = `
                <div class="font-bold text-blue-400">Q${i+1}</div>
                <div class="leading-tight mt-0.5">${item.domanda.substring(0,50)}...</div>
            `;
            div.onclick = () => selectQuestion(i);
            container.appendChild(div);
        });
    }

    function selectQuestion(index) {
        selectedQ = currentQuestions[index];
        document.querySelectorAll('#questions-container > div').forEach((el, i) => {
            el.className = i === index ? 
                'p-2 bg-blue-600 rounded mb-1 cursor-pointer border-2 border-blue-400' : 
                'p-2 bg-gray-800 rounded mb-1 cursor-pointer hover:bg-gray-700 border border-gray-700';
        });
    }

    function lanciaQuiz() { if(selectedQ) lancia('quiz'); else alert('âŒ Seleziona domanda!'); }
    function lanciaBuzzer() { if(selectedQ) lancia('buzzer'); else alert('âŒ Seleziona una domanda prima!'); }

    function lancia(m) {
        totalQuestionsAsked++;
        document.getElementById('question-counter').textContent = `Q: ${totalQuestionsAsked}`;
        
        if(finaleActive) {
            finaleQuestionCount++;
            updateFinaleProgress();
            socket.emit('invia_domanda_finale', {...selectedQ, modalita: m});
            if(finaleQuestionCount >= 5) activateStep(6);
        } else {
            socket.emit('invia_domanda', {...selectedQ, modalita: m});
        }
    }

    socket.on('update_round_monitor', (data) => {
        document.getElementById('answers-count').textContent = `${data.length}/${totalTeams}`;
        const list = document.getElementById('answers-list');
        list.innerHTML = '';
        
        data.forEach((res) => {
            const div = document.createElement('div');
            div.className = `p-2 rounded ${res.corretta ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`;
            div.innerHTML = `
                <span class="font-bold">${res.teamName}</span>
                <span class="float-right font-bold">${res.corretta ? '+' : ''}${res.punti || 0}</span>
            `;
            list.appendChild(div);
        });
    });

    socket.on('reset_round_monitor', () => {
        document.getElementById('answers-list').innerHTML = '';
        document.getElementById('answers-list').classList.remove('hidden');
        document.getElementById('buzzer-monitor').classList.add('hidden');
        document.getElementById('buzzer-monitor').innerHTML = '';
    });

    socket.on('buzzer_queue_full', (d) => {
        const isMusicBuzzer = d.standalone || false;
        
        if(isMusicBuzzer) {
            const queueDiv = document.getElementById('buzzer-queue-admin');
            queueDiv.classList.remove('hidden');
            queueDiv.innerHTML = '';
            
            if(d.queue && d.queue.length > 0) {
                d.queue.forEach((player, idx) => {
                    const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                    const div = document.createElement('div');
                    div.className = 'bg-black/30 rounded p-2 mb-1';
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold">${medals[idx] || (idx+1)+'.'} ${player.name}</span>
                            <span class="text-yellow-400 text-xs">${player.time}s</span>
                        </div>
                        <div class="grid grid-cols-3 gap-1">
                            <button onclick="assignPoints('${player.id}', 100)" class="bg-green-600 hover:bg-green-500 text-white text-xs py-1 rounded font-bold">+100</button>
                            <button onclick="assignPoints('${player.id}', 50)" class="bg-blue-600 hover:bg-blue-500 text-white text-xs py-1 rounded font-bold">+50</button>
                            <button onclick="assignPoints('${player.id}', -50)" class="bg-red-600 hover:bg-red-500 text-white text-xs py-1 rounded font-bold">-50</button>
                        </div>
                    `;
                    queueDiv.appendChild(div);
                });
            }
        } else {
            const monitorDiv = document.getElementById('buzzer-monitor');
            const answersList = document.getElementById('answers-list');
            
            monitorDiv.classList.remove('hidden');
            answersList.classList.add('hidden');
            monitorDiv.innerHTML = '';
            
            document.getElementById('answers-count').textContent = `${d.queue.length}/10`;
            
            if(d.queue && d.queue.length > 0) {
                d.queue.forEach((player, idx) => {
                    const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                    const medal = medals[idx] || `${idx + 1}Â°`;
                    
                    const div = document.createElement('div');
                    div.className = 'bg-black/30 rounded p-2 mb-1';
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold">${medal} ${player.name}</span>
                            <span class="text-yellow-400 text-xs">${player.time}s</span>
                        </div>
                        <div class="grid grid-cols-3 gap-1">
                            <button onclick="assignPoints('${player.id}', 100)" class="bg-green-600 hover:bg-green-500 text-white text-xs py-1 rounded font-bold">+100</button>
                            <button onclick="assignPoints('${player.id}', 50)" class="bg-blue-600 hover:bg-blue-500 text-white text-xs py-1 rounded font-bold">+50</button>
                            <button onclick="assignPoints('${player.id}', -50)" class="bg-red-600 hover:bg-red-500 text-white text-xs py-1 rounded font-bold">-50</button>
                        </div>
                    `;
                    monitorDiv.appendChild(div);
                });
            }
        }
    });

    socket.on('reset_buzzer_admin', () => {
        document.getElementById('buzzer-queue-admin').classList.add('hidden');
        document.getElementById('buzzer-queue-admin').innerHTML = '';
    });

    function resetBuzzer() { 
        socket.emit('buzzer_reset'); 
    }
    
    function openBuzzerStandalone() { 
        socket.emit('start_buzzer', { domanda: 'ğŸµ Premi quando sai la risposta!' });
        console.log('ğŸµ Buzzer standalone attivato');
    }
    
    function closeBuzzer() { 
        socket.emit('buzzer_close');
        console.log('ğŸ”’ Buzzer chiuso');
    }

    function assignPoints(teamId, points) {
        // âœ… FIX: Usa 'assign_points' invece di 'admin_punti_manuali'
        socket.emit('assign_points', { teamId: teamId, points: points });
        console.log(`âœ… Assegnati ${points} punti a ${teamId}`);
        
        // Reset buzzer dopo assegnazione (per gioco musicale)
        setTimeout(() => {
            socket.emit('reset_buzzer');
        }, 500);
    }

    socket.on('update_teams', (teams) => {
        totalTeams = teams.length;
        const lb = document.getElementById('leaderboard-center');
        lb.innerHTML = '';
        const sorted = teams.sort((a, b) => b.score - a.score);
        sorted.forEach((t, i) => {
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            const medal = i < 3 ? medals[i] : `${i + 1}Â°`;
            lb.innerHTML += `
                <div class="bg-gray-800/70 rounded-lg p-2 flex items-center justify-between border border-gray-700">
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                        <span class="text-xl">${medal}</span>
                        <span class="font-bold text-white text-sm truncate">${t.name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-yellow-400 font-black text-sm">${t.score}</span>
                        <button onclick="adjustPoints('${t.id}', 50)" class="bg-green-600 hover:bg-green-500 text-white font-bold px-2 py-1 rounded text-xs">+</button>
                        <button onclick="adjustPoints('${t.id}', -50)" class="bg-red-600 hover:bg-red-500 text-white font-bold px-2 py-1 rounded text-xs">âˆ’</button>
                    </div>
                </div>
            `;
        });
    });

    // âœ… Funzione per aggiungere/togliere punti
    function adjustPoints(teamId, points) {
        socket.emit('assign_points', { teamId: teamId, points: points });
        console.log(`ğŸ’° ${points > 0 ? '+' : ''}${points} punti a ${teamId}`);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ¤ KARAOKE YOUTUBE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function playYoutubeKaraoke() {
        const videoId = document.getElementById('youtube-id-input').value.trim();
        if(!videoId) {
            alert('âŒ Inserisci un Video ID!');
            return;
        }
        socket.emit('play_youtube_karaoke', { videoId: videoId });
        console.log('ğŸ¤ Karaoke avviato:', videoId);
    }

    function playYoutubePreset(videoId) {
        socket.emit('play_youtube_karaoke', { videoId: videoId });
        document.getElementById('youtube-id-input').value = videoId;
        console.log('ğŸ¤ Preset karaoke:', videoId);
    }

    function stopKaraoke() {
        socket.emit('stop_karaoke');
        console.log('â¹ï¸ Karaoke fermato');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”Š EFFETTI AUDIO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let audioEnabled = true;

    function playSfx(effect, duration) {
        const data = { effect: effect };
        if (duration) data.duration = duration;
        
        // Invia al server per broadcast a tutti i display
        socket.emit('play_sfx', data);
        
        // Riproduci anche localmente nell'admin
        if (audioEnabled && typeof SipontoAudio !== 'undefined') {
            const fn = SipontoAudio[effect];
            if (typeof fn === 'function') {
                fn(duration);
            }
        }
        
        console.log('ğŸ”Š SFX inviato:', effect);
    }

    function toggleAudioEnabled() {
        audioEnabled = !audioEnabled;
        
        // Invia comando ai display
        socket.emit('audio_set_enabled', { enabled: audioEnabled });
        
        // Imposta anche localmente nell'admin
        if (typeof SipontoAudio !== 'undefined') {
            SipontoAudio.setEnabled(audioEnabled);
        }
        
        const btn = document.getElementById('audio-toggle-btn');
        if (audioEnabled) {
            btn.textContent = 'ğŸ”Š ON';
            btn.className = 'flex-1 btn-success text-white font-bold py-1.5 rounded text-xs';
        } else {
            btn.textContent = 'ğŸ”‡ OFF';
            btn.className = 'flex-1 btn-danger text-white font-bold py-1.5 rounded text-xs';
        }
        console.log('ğŸ”Š Audio:', audioEnabled ? 'ON' : 'OFF');
    }

    function setAudioVolume(val) {
        const volume = parseInt(val) / 100;
        
        // Invia comando ai display
        socket.emit('audio_set_volume', { volume: volume });
        
        // Imposta anche localmente nell'admin
        if (typeof SipontoAudio !== 'undefined') {
            SipontoAudio.setVolume(volume);
        }
        
        document.getElementById('audio-volume-label').textContent = val + '%';
        console.log('ğŸ”Š Volume:', val + '%');
    }

    // Ruota della Fortuna Functions
    let ruotaWinner = null;

    function ruotaStep(step) {
        switch(step) {
            case 1:
                // Spiega regole
                socket.emit('ruota_step', { step: 'explain' });
                console.log('ğŸ° Spiegazione Ruota');
                break;
            case 2:
                // Gira ruota e estrae squadra
                socket.emit('ruota_step', { step: 'spin' });
                console.log('ğŸ° Ruota gira...');
                break;
            case 3:
                // Mostra scelta al telefono
                if(!ruotaWinner) {
                    alert('âš ï¸ Prima gira la ruota!');
                    return;
                }
                socket.emit('ruota_step', { step: 'choice', teamId: ruotaWinner.id });
                console.log('ğŸ° Mostra scelta a:', ruotaWinner.name);
                break;
            case 4:
                // Lancia domanda sfida
                // âœ… FIX: Controllo migliorato - verifica sia squadra che domanda
                if(!ruotaWinner) {
                    alert('âš ï¸ Prima gira la ruota e aspetta che venga estratta una squadra!');
                    console.log('âŒ Errore: Nessuna squadra estratta');
                    return;
                }
                if(!selectedQ) {
                    alert('âš ï¸ Seleziona una domanda dalla lista prima di lanciarla!');
                    console.log('âŒ Errore: Nessuna domanda selezionata');
                    return;
                }
                console.log('ğŸ° Invio domanda sfida:', selectedQ.domanda, 'a squadra:', ruotaWinner.name);
                socket.emit('ruota_step', { step: 'challenge', question: selectedQ });
                console.log('âœ… Domanda sfida lanciata con successo');
                break;
        }
    }

    // Riceve squadra estratta dalla ruota
    socket.on('ruota_winner', (data) => {
        ruotaWinner = data.winner; // âœ… FIX: Accede a data.winner invece di data
        document.getElementById('ruota-winner-display').classList.remove('hidden');
        document.getElementById('ruota-winner-name').textContent = data.winner.name;
        console.log('ğŸ° ESTRATTO:', data.winner.name); // âœ… FIX: Console log piÃ¹ evidente
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”¥ DUELLO RUBA-PUNTI Functions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let duelloAttaccante = null;
    let duelloDifensore = null;
    let duelloCategoria = null;

    function duelloStep(step) {
        switch(step) {
            case 1:
                // Avvia duello - estrae attaccante
                socket.emit('duello_start');
                console.log('ğŸ”¥ Duello avviato');
                break;
            case 2:
                // Mostra scelta avversario
                if(!duelloAttaccante) {
                    alert('âš ï¸ Prima avvia il duello!');
                    return;
                }
                socket.emit('duello_show_opponent_choice');
                console.log('ğŸ”¥ Mostra scelta avversario');
                break;
            case 3:
                // Mostra scelta categoria
                if(!duelloDifensore) {
                    alert('âš ï¸ Prima scegli l\'avversario!');
                    return;
                }
                socket.emit('duello_show_category_choice');
                console.log('ğŸ”¥ Mostra scelta categoria');
                break;
            case 4:
                // Lancia domanda duello
                if(!duelloCategoria) {
                    alert('âš ï¸ Prima scegli la categoria!');
                    return;
                }
                if(!selectedQ) {
                    alert('âš ï¸ Seleziona una domanda dalla categoria ' + duelloCategoria + '!');
                    return;
                }
                socket.emit('duello_launch_question', { question: selectedQ });
                console.log('ğŸ”¥ Domanda duello lanciata');
                break;
        }
    }

    function duelloAnswerResult(correct) {
        socket.emit('duello_answer_result', { correct: correct });
        console.log('ğŸ”¥ Risposta:', correct ? 'CORRETTA' : 'SBAGLIATA');
    }

    // Riceve attaccante estratto
    socket.on('duello_attaccante', (data) => {
        duelloAttaccante = data.attaccante;
        document.getElementById('duello-attaccante-display').classList.remove('hidden');
        document.getElementById('duello-attaccante-name').textContent = data.attaccante.name;
        
        // Abilita step 2
        document.getElementById('duello-step-2').classList.remove('opacity-40', 'pointer-events-none');
        
        console.log('ğŸ”¥ Attaccante:', data.attaccante.name);
    });

    // Riceve difensore scelto
    socket.on('duello_difensore_scelto', (data) => {
        duelloDifensore = data.difensore;
        document.getElementById('duello-difensore-display').classList.remove('hidden');
        document.getElementById('duello-difensore-name').textContent = data.difensore.name;
        
        // Abilita step 3
        document.getElementById('duello-step-3').classList.remove('opacity-40', 'pointer-events-none');
        
        console.log('ğŸ”¥ Difensore:', data.difensore.name);
    });

    // Riceve categoria scelta
    socket.on('duello_categoria_scelta', (data) => {
        duelloCategoria = data.category;
        document.getElementById('duello-categoria-display').classList.remove('hidden');
        document.getElementById('duello-categoria-name').textContent = data.category.toUpperCase();
        
        // Abilita step 4 e mostra scoreboard
        document.getElementById('duello-step-4').classList.remove('opacity-40', 'pointer-events-none');
        document.getElementById('duello-scoreboard').classList.remove('hidden');
        
        console.log('ğŸ”¥ Categoria:', data.category);
    });

    // In attesa risposta (chi ha premuto buzzer)
    socket.on('duello_waiting_answer', (data) => {
        document.getElementById('duello-answer-buttons').classList.remove('hidden');
        document.getElementById('duello-current-answerer').textContent = data.teamName;
        console.log('ğŸ”¥ Risponde:', data.teamName, '| Risposta corretta:', data.correctAnswer);
    });

    // L'altro puÃ² rispondere (dopo sbagliata)
    socket.on('duello_other_can_answer', (data) => {
        document.getElementById('duello-current-answerer').textContent = data.teamName;
        console.log('ğŸ”¥ Ora risponde:', data.teamName, '| Risposta corretta:', data.correctAnswer);
    });

    // Punto segnato
    socket.on('duello_point_scored', (data) => {
        document.getElementById('duello-score-att').textContent = data.scoreAttaccante;
        document.getElementById('duello-score-dif').textContent = data.scoreDifensore;
        document.getElementById('duello-answer-buttons').classList.add('hidden');
        console.log('ğŸ”¥ Score:', data.scoreAttaccante, '-', data.scoreDifensore);
    });

    // Prossima domanda
    socket.on('duello_next_question', () => {
        alert('âœ… Punto segnato! Lancia la prossima domanda (2 o 3)');
        console.log('ğŸ”¥ Pronto per prossima domanda');
    });

    // Fine duello
    socket.on('duello_end', (data) => {
        alert(`ğŸ† ${data.winner.name} VINCE IL DUELLO!\n\n${data.pointsChange}`);
        
        // Reset UI duello
        duelloAttaccante = null;
        duelloDifensore = null;
        duelloCategoria = null;
        
        document.getElementById('duello-attaccante-display').classList.add('hidden');
        document.getElementById('duello-difensore-display').classList.add('hidden');
        document.getElementById('duello-categoria-display').classList.add('hidden');
        document.getElementById('duello-scoreboard').classList.add('hidden');
        document.getElementById('duello-answer-buttons').classList.add('hidden');
        
        document.getElementById('duello-step-2').classList.add('opacity-40', 'pointer-events-none');
        document.getElementById('duello-step-3').classList.add('opacity-40', 'pointer-events-none');
        document.getElementById('duello-step-4').classList.add('opacity-40', 'pointer-events-none');
        
        document.getElementById('duello-score-att').textContent = '0';
        document.getElementById('duello-score-dif').textContent = '0';
        
        console.log('ğŸ”¥ Duello terminato');
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ§  MEMORY GAME - ADMIN
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function startMemoryGame() {
        if(confirm('ğŸ§  Avviare Memory Game (3 manche)?')) {
            socket.emit('memory_start');
            document.getElementById('memory-status').classList.remove('hidden');
            console.log('ğŸ§  Memory avviato');
        }
    }

    function skipMemoryRound() {
        socket.emit('memory_skip_round');
        console.log('ğŸ§  Round saltata');
    }

    function stopMemoryGame() {
        if(confirm('ğŸ›‘ Fermare Memory Game?')) {
            socket.emit('memory_stop');
            document.getElementById('memory-status').classList.add('hidden');
            console.log('ğŸ§  Memory fermato');
        }
    }

    socket.on('memory_manche_intro', (data) => {
        document.getElementById('memory-manche-display').textContent = `${data.manche}/${data.totalManches}`;
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âœ… FIX COMPLETO: SFIDA FINALE - FUNZIONI
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showFinaleExplanation() {
        socket.emit('show_finale_explanation');
        setTimeout(() => activateStep(2), 20000);
        console.log('ğŸ”¥ Spiegazione finale inviata');
    }

    function startFinale() {
        if(confirm('ğŸ”¥ ATTENZIONE: Iniziare la SFIDA FINALE?\n\nLa classifica verrÃ  nascosta fino alla fine.')) {
            socket.emit('start_finale');
            finaleActive = true;
            finaleQuestionCount = 0;
            document.getElementById('finale-progress').classList.remove('hidden');
            activateStep(3);
            console.log('ğŸ”¥ Finale attivata');
        }
    }

    function prepareAllIn() {
        if(!selectedQ) {
            alert('âŒ Seleziona una domanda per ALL IN!');
            return;
        }
        
        // Modifica i punti della domanda per i pulsanti 100-500
        selectedQ.allInOptions = [100, 200, 300, 500];
        
        socket.emit('prepare_allin', selectedQ);
        activateStep(4);
        
        // Mostra contatore scommesse
        document.getElementById('allin-bets-status').classList.remove('hidden');
        document.getElementById('allin-counter').textContent = '0';
        
        const realTeams = Object.values(gameState.teams || {}).filter(t => !t.isPreview);
        document.getElementById('allin-total').textContent = realTeams.length;
        
        console.log('ğŸ’° ALL IN preparato con domanda:', selectedQ.domanda);
    }

    function showAllInResults() {
        socket.emit('admin_force_show_allin');
        console.log('ğŸ“Š Risultati ALL IN mostrati sul display');
        
        // Dopo 10 secondi, abilita elaborazione
        setTimeout(() => {
            activateStep(5);
            alert('âœ… Risultati mostrati sul display.\nOra clicca "5ï¸âƒ£ Elabora Punteggi" per aggiornare i punteggi.');
        }, 1000);
    }

    function processAllIn() {
        socket.emit('process_allin_results');
        activateStep(6);
        console.log('ğŸ’° Punteggi ALL IN in elaborazione...');
    }

    function revealWinner() {
        if(confirm('ğŸ† RIVELARE IL VINCITORE FINALE?\n\nLa classifica tornerÃ  visibile a tutti.')) {
            socket.emit('reveal_winner');
            finaleActive = false;
            document.getElementById('finale-progress').classList.add('hidden');
            activateStep(1);
            console.log('ğŸ† Vincitore finale rivelato');
        }
    }

    socket.on('allin_bet_placed', (data) => {
        document.getElementById('allin-counter').textContent = data.betsCount;
        
        // Se tutte le squadre hanno scommesso
        if(data.betsCount >= data.totalTeams) {
            document.getElementById('allin-bets-status').innerHTML = `
                <div class="bg-green-600 text-white p-1 rounded text-xs font-bold animate-pulse">
                    âœ… TUTTE LE ${data.totalTeams} SQUADRE HANNO SCOMMESSO!
                </div>
            `;
        }
        
        console.log(`ğŸ’° Scommessa: ${data.teamName} - ${data.bet} punti`);
    });

    socket.on('allin_results_processed', (data) => {
        alert(`âœ… RISULTATI ALL IN ELABORATI!\n\n${data.correctCount}/${data.totalBets} squadre corrette\n\nOra puoi lanciare le domande 2-5 (x2 punti).`);
        console.log('âœ… Risultati ALL IN elaborati:', data);
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CORREZIONI ADMIN.HTML - Aggiungere questi listener
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // âœ… FIX 1: LISTENER PER RISPOSTE (mostra chi ha risposto)
    socket.on('update_answers', (data) => {
        // âœ… FIX: Usa 'answers-list' invece di 'round-answers'
        const answersDiv = document.getElementById('answers-list');
        if (!answersDiv) {
            console.error('âŒ Elemento answers-list non trovato');
            return;
        }
        
        // Nascondi buzzer-monitor e mostra answers-list
        document.getElementById('buzzer-monitor').classList.add('hidden');
        answersDiv.classList.remove('hidden');
        
        // Aggiorna contatore
        document.getElementById('answers-count').textContent = `${data.answers ? data.answers.length : 0}/${data.totalTeams}`;
        
        answersDiv.innerHTML = '';
        
        if (data.answers && data.answers.length > 0) {
            data.answers.forEach((ans, idx) => {
                const icon = ans.corretta ? 'âœ…' : 'âŒ';
                const colorClass = ans.corretta ? 'bg-green-900/50' : 'bg-red-900/50';
                const borderClass = ans.corretta ? 'border-green-500' : 'border-red-500';
                
                const div = document.createElement('div');
                div.className = `${colorClass} p-2 rounded mb-1 border ${borderClass}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-xs">${icon} ${ans.teamName}</span>
                        <span class="text-xs text-gray-400">${ans.time}s</span>
                    </div>
                    <div class="text-xs text-gray-300 mt-1">
                        ${ans.risposta}
                        ${ans.corretta ? ` <span class="text-green-400 font-bold">+${ans.points}pt</span>` : ''}
                    </div>
                `;
                answersDiv.appendChild(div);
            });
            
            // Mostra risposta corretta nel preview
            if (data.correctAnswer) {
                const correctDiv = document.getElementById('correct-answer-preview');
                const correctText = document.getElementById('correct-answer-text');
                correctDiv.classList.remove('hidden');
                correctText.textContent = data.correctAnswer;
            }
        } else {
            answersDiv.innerHTML = '<p class="text-gray-500 text-xs text-center py-4">Nessuna risposta ancora...</p>';
        }
    });

    // Funzione per assegnare punti da buzzer
    function assignBuzzerPoints(teamId, points) {
        socket.emit('assign_points', { teamId: teamId, points: points });
        // Reset buzzer dopo assegnazione
        setTimeout(() => {
            socket.emit('reset_buzzer');
        }, 500);
    }

    // âœ… FIX 3: MOSTRA RISPOSTA CORRETTA PER DUELLO
    socket.on('duello_correct_answer', (data) => {
        const duelloInfo = document.getElementById('duello-info');
        if (!duelloInfo) return;
        
        duelloInfo.innerHTML += `
            <div class="mt-3 p-3 ${data.isCorrect ? 'bg-green-900' : 'bg-red-900'} rounded">
                <p class="font-bold">${data.teamName}: ${data.teamAnswer}</p>
                <p class="text-sm">Risposta corretta: ${data.correctAnswer}</p>
                <p class="text-lg">${data.isCorrect ? 'âœ… CORRETTO!' : 'âŒ SBAGLIATO!'}</p>
            </div>
        `;
    });

    // Accordion/Collapse Toggle
    function toggleSection(section) {
        const content = document.getElementById(`content-${section}`);
        const icon = document.getElementById(`icon-${section}`);
        
        if(content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.textContent = 'â–²';
        } else {
            content.classList.add('hidden');
            icon.textContent = 'â–¼';
        }
    }

    function regia(v) { socket.emit('regia_cmd', v); }
    function resetDisplays() { if(confirm("Reset?")) socket.emit('reset_displays'); }
    function resetGame() { if(confirm("âš ï¸ RESET TOTALE?")) socket.emit('reset_game'); }
    
    function mostraSoluzione() {
        if(selectedQ && selectedQ.corretta !== undefined) {
            // Invia la risposta corretta al server
            socket.emit('mostra_soluzione', { 
                soluzione: selectedQ.corretta 
            });
            console.log('ğŸ“º Soluzione inviata:', selectedQ.corretta);
        } else {
            alert('âŒ Seleziona una domanda prima!');
        }
    }

    function togglePause() {
        const btn = document.getElementById('pause-btn');
        if(isPaused) {
            socket.emit('resume_game');
            btn.innerHTML = 'â¸ï¸ PAUSA';
            btn.className = 'px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg font-bold text-sm';
            isPaused = false;
        } else {
            socket.emit('pause_game');
            btn.innerHTML = 'â–¶ï¸ RIPRENDI';
            btn.className = 'px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-bold text-sm';
            isPaused = true;
        }
    }

    function activateStep(stepNum) {
        for(let i = 1; i <= 7; i++) {
            const step = document.getElementById(`step-${i}`);
            if(step) {
                step.className = step.className.replace(' active', '');
                if(i === stepNum) step.className += ' active';
            }
        }
        
        // Gestione speciale per step 6 (div) e step-6-btn (button)
        if(stepNum === 6) {
            const step6Btn = document.getElementById('step-6-btn');
            if(step6Btn) {
                step6Btn.className = step6Btn.className.replace(' active', '');
                step6Btn.className += ' active';
            }
        }
    }

    function refreshPreview() {
        document.getElementById('mobile-preview').src = window.location.origin + '/preview';
    }

    // âœ… Ricevi e mostra la risposta corretta in anticipo
    socket.on('show_correct_answer_preview', (data) => {
        const preview = document.getElementById('correct-answer-preview');
        const text = document.getElementById('correct-answer-text');
        text.textContent = `${data.corretta}`;
        preview.classList.remove('hidden');
        console.log('âœ… Risposta corretta:', data.corretta);
    });

    // Nascondi quando cambia domanda
    socket.on('nuova_domanda', () => {
        document.getElementById('correct-answer-preview').classList.add('hidden');
    });

    // âœ… Ricevi dati delle domande all'avvio
    socket.on('questions_data', (data) => {
        dbStructure.categories = data.categories;
        dbStructure.questions = data.questions;
        populateCategories();
        console.log('ğŸ“š Categorie caricate:', data.categories);
    });

    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('mobile-preview').src = window.location.origin + '/preview';
        
        // Inizializza audio engine per l'admin
        if (typeof SipontoAudio !== 'undefined') {
            // Attiva al primo click sulla pagina
            document.addEventListener('click', function initAdminAudio() {
                SipontoAudio.init();
                console.log('âœ… Audio admin attivato');
            }, { once: true });
        }
    });

    document.addEventListener('keydown', (e) => {
        if(e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') return;
        if(e.code === 'Space') { e.preventDefault(); lanciaQuiz(); }
        if(e.code === 'KeyB') { e.preventDefault(); lanciaBuzzer(); }
        if(e.code === 'KeyP') { e.preventDefault(); togglePause(); }
    });

    // Layout Presets System
    function setLayout(type) {
        const left = document.getElementById('column-left');
        const center = document.getElementById('column-center');
        const right = document.getElementById('column-right');
        
        const layouts = {
            compact: ['15%', '35%', '50%'],   // Focus controlli
            balanced: ['20%', '40%', '40%'],  // Default
            preview: ['15%', '50%', '35%']    // Focus preview/risposte
        };
        
        const [l, c, r] = layouts[type];
        
        // Applica dimensioni con smooth transition
        left.style.width = l;
        center.style.width = c;
        right.style.width = r;
        
        // Aggiorna bottoni attivi
        document.querySelectorAll('[onclick^="setLayout"]').forEach(btn => {
            btn.className = 'px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-bold transition';
        });
        event.target.className = 'px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs font-bold transition';
        
        // Salva preferenza
        localStorage.setItem('preferredLayout', type);
        console.log(`ğŸ“ Layout: ${type.toUpperCase()} (${l} / ${c} / ${r})`);
    }
    
    // Carica layout salvato all'avvio
    window.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem('preferredLayout') || 'balanced';
        setTimeout(() => {
            const btn = document.querySelector(`[onclick="setLayout('${saved}')"]`);
            if(btn) btn.click();
        }, 100);
    });

    function updateFinaleProgress() {
        const dots = document.querySelectorAll('#finale-progress .progress-dot');
        dots.forEach((dot, i) => {
            dot.className = i < finaleQuestionCount ? 'progress-dot active' : 'progress-dot';
        });
    }

    // ============================================
    // ğŸ’€ IL PATTO COL DESTINO - FUNZIONI ADMIN
    // ============================================
    
    function pattoShowRegole() {
        socket.emit('admin_mostra_regole_patto');
    }
    
    function pattoAvvia() {
        socket.emit('admin_avvia_patto_destino');
    }
    
    function pattoReset() {
        socket.emit('admin_reset_patto');
    }
    
    // Aggiorna contatore utilizzi
    socket.on('patto_update_utilizzi', (data) => {
        document.getElementById('patto-usi').textContent = data.utilizzi;
        
        // Disabilita il pulsante se raggiunti i max utilizzi
        if (data.utilizzi >= data.max) {
            const btn = document.getElementById('patto-avvia-btn');
            btn.disabled = true;
            btn.className = 'w-full bg-gray-600 text-white font-bold py-2 rounded text-sm opacity-50 cursor-not-allowed';
            btn.textContent = 'ğŸš« MAX UTILIZZI';
        }
    });
    
    // Notifica quando viene ricevuta una scelta
    socket.on('patto_scelta_ricevuta', (data) => {
        const status = document.getElementById('patto-status');
        status.classList.remove('hidden');
        status.className = 'text-xs text-center py-2 bg-green-900/30 rounded font-bold text-green-400';
        status.textContent = `âœ… ${data.teamName} ha scelto`;
        
        setTimeout(() => {
            status.classList.add('hidden');
        }, 2000);
    });
    
    // Mostra errori
    socket.on('patto_max_utilizzi_raggiunto', () => {
        alert('âš ï¸ Hai giÃ  utilizzato Il Patto col Destino 2 volte!');
    });
    
    socket.on('patto_squadre_insufficienti', () => {
        alert('âš ï¸ Servono almeno 2 squadre per giocare!');
    });
    
    // ============================================
    // FINE FUNZIONI PATTO COL DESTINO
    // ============================================
</script>

</body>
</html>
