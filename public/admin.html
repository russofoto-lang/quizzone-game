<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>REGIA MASTER</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-800 p-2 h-screen flex flex-col text-sm">

    <div class="flex justify-between items-center bg-white p-2 rounded mb-2 shadow">
        <h1 class="font-bold text-gray-800 text-lg">üéõÔ∏è REGIA MASTER</h1>
        <div class="flex gap-4 items-center">
            <div class="bg-gray-200 rounded px-2 py-1 flex gap-2 items-center">
                <span class="font-bold text-xs text-gray-600">DISPLAY:</span>
                <button onclick="regia('logo')" class="bg-gray-600 text-white px-2 py-1 rounded text-xs hover:bg-gray-700">‚¨õ LOGO</button>
                <button onclick="regia('classifica_gen')" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs hover:bg-yellow-700">üèÜ GENERALE</button>
                <button onclick="regia('classifica_round')" class="bg-purple-600 text-white px-2 py-1 rounded text-xs hover:bg-purple-700">üìä PODIO ROUND</button>
                <button onclick="regia('gioco')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700">üéÆ GIOCO</button>
            </div>
            <div id="status" class="font-bold text-red-500 uppercase text-xs">Offline</div>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-2 flex-1 overflow-hidden">
        
        <div class="col-span-4 flex flex-col gap-2 overflow-y-auto">
            <div class="bg-white p-3 rounded shadow">
                <h2 class="font-bold text-gray-600 mb-2">1. Domande</h2>
                
                <select id="sel-tipo" class="w-full border-2 border-blue-500 p-2 rounded font-bold mb-2 text-blue-900">
                    <option value="">-- TIPO GIOCO --</option>
                    <option value="categorie">üìÇ CATEGORIE</option>
                    <option value="bonus">üí∞ BONUS</option>
                    <option value="raffica">‚ö° RAFFICA</option>
                </select>

                <select id="sel-cat" class="w-full border p-1 rounded mb-2 bg-gray-50 text-xs" disabled><option value="">-- Materia --</option></select>
                <select id="sel-dom" class="w-full border p-1 rounded bg-gray-50 text-xs" disabled><option value="">-- Domanda --</option></select>

                <div class="mt-2 flex gap-1">
                    <button onclick="lancia('classico')" class="flex-1 bg-blue-600 text-white font-bold py-2 rounded shadow hover:bg-blue-700 text-xs">QUIZ</button>
                    <button onclick="lancia('buzzer')" class="flex-1 bg-red-600 text-white font-bold py-2 rounded shadow hover:bg-red-700 text-xs">BUZZER</button>
                </div>
            </div>
            
            <div class="mt-auto pt-4">
                <button onclick="resetGame()" class="w-full bg-red-900 text-red-200 py-2 rounded border border-red-700 hover:bg-red-800 text-xs">‚ö†Ô∏è RESETTA TUTTO IL GIOCO</button>
            </div>
        </div>

        <div class="col-span-5 bg-gray-900 p-3 rounded shadow flex flex-col border border-gray-700">
            <h2 class="font-bold text-white mb-2 flex justify-between">
                MONITOR
                <span id="timer-badge" class="bg-gray-700 px-2 rounded text-xs">Attesa</span>
            </h2>
            
            <div id="buzzer-actions" class="hidden mb-2 bg-red-900/50 p-2 rounded border border-red-500 flex justify-between items-center">
                <span id="buzzer-who" class="text-white font-bold text-lg animate-pulse">Chi?</span>
                <button onclick="buzzerNext()" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-xs font-bold shadow">
                    ‚ùå SBAGLIATA / NEXT
                </button>
            </div>

            <div class="flex-1 overflow-y-auto bg-black/50 rounded p-1 mb-2">
                <table class="w-full text-left text-xs text-gray-300">
                    <tbody id="round-table">
                         <div class="text-center p-4 text-gray-500 italic">Pronto...</div>
                    </tbody>
                </table>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <button onclick="rivela()" class="bg-yellow-600 text-white py-3 rounded font-bold hover:bg-yellow-500 border-b-4 border-yellow-800 active:border-b-0">
                    üëÅÔ∏è SVELA RISPOSTA
                </button>
                <button onclick="assegnaAuto()" class="bg-green-600 text-white py-3 rounded font-bold hover:bg-green-500 animate-pulse border-b-4 border-green-800 active:border-b-0">
                    üèÜ ASSEGNA PUNTI
                </button>
            </div>
        </div>

        <div class="col-span-3 bg-white p-3 rounded shadow flex flex-col">
            <h2 class="font-bold text-gray-600 mb-2 border-b">Classifica Totale</h2>
            <div class="flex-1 overflow-y-auto">
                <table class="w-full text-xs">
                    <tbody id="team-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentQuestions = [];
        let selectedQ = null;
        let dbStructure = {};

        socket.on('connect', () => {
            document.getElementById('status').innerText = "ONLINE";
            document.getElementById('status').className = "font-bold text-green-500 uppercase text-xs";
            socket.emit('admin_connect');
        });

        socket.on('init_data', (data) => {
            dbStructure = data;
            updateTeams(data.teams);
        });
        
        socket.on('force_reload', () => window.location.reload());

        socket.on('receive_questions', (questions) => {
            currentQuestions = questions;
            const selDom = document.getElementById('sel-dom');
            selDom.disabled = false;
            selDom.innerHTML = '<option value="">-- Seleziona --</option>';
            questions.forEach((q, idx) => {
                let text = q.domanda.length > 40 ? q.domanda.substring(0,40) + "..." : q.domanda;
                selDom.innerHTML += `<option value="${idx}">${q.id}. ${text}</option>`;
            });
        });

        socket.on('update_round_monitor', (answers) => {
            const tbody = document.getElementById('round-table');
            tbody.innerHTML = '';
            
            // Nascondi il pannello buzzer action se qualcuno ha risposto
            if(answers.length > 0) document.getElementById('buzzer-actions').classList.add('hidden');

            answers.forEach((entry, idx) => {
                const color = entry.corretta ? 'text-green-400 font-bold' : 'text-red-400';
                const pos = idx + 1;
                let bonus = entry.corretta ? (pos === 1 ? '[150]' : (pos===2 ? '[125]' : '[100]')) : '';
                
                tbody.innerHTML += `
                    <tr class="border-b border-gray-800">
                        <td class="p-2 text-white">${pos}. ${entry.teamName}</td>
                        <td class="p-2 ${color}">${entry.risposta}</td>
                        <td class="p-2 text-gray-400">${entry.tempo}s</td>
                        <td class="p-2 text-right text-xs text-yellow-500">${bonus}</td>
                    </tr>`;
            });
        });

        socket.on('reset_round_monitor', () => {
            document.getElementById('round-table').innerHTML = '<div class="text-center p-4 text-gray-500">Gara in corso...</div>';
            document.getElementById('timer-badge').innerText = "LIVE";
            document.getElementById('timer-badge').className = "bg-green-600 px-2 rounded text-xs animate-pulse text-white";
            document.getElementById('buzzer-actions').classList.add('hidden');
        });

        socket.on('buzzer_admin_alert', (winner) => {
            // Mostra il pannello per gestire il turno
            const panel = document.getElementById('buzzer-actions');
            panel.classList.remove('hidden');
            document.getElementById('buzzer-who').innerText = "üîä " + winner;
            document.getElementById('timer-badge').innerText = "BUZZER";
            document.getElementById('timer-badge').className = "bg-red-600 px-2 rounded text-xs animate-pulse text-white";
        });

        socket.on('update_teams', updateTeams);
        function updateTeams(teams) {
            teams.sort((a,b) => b.score - a.score);
            const list = document.getElementById('team-list');
            list.innerHTML = '';
            teams.forEach(t => {
                list.innerHTML += `
                <tr class="border-b group hover:bg-gray-100">
                    <td class="py-1 font-bold">${t.name}</td>
                    <td class="text-right text-blue-600 font-bold">${t.score}</td>
                    <td class="text-right w-8 opacity-0 group-hover:opacity-100">
                        <button onclick="daiPunti('${t.id}', 50)" class="text-[10px] bg-green-200 text-green-800 px-1 rounded">+50</button>
                    </td>
                </tr>`;
            });
        }

        // LOGICA MENU
        document.getElementById('sel-tipo').addEventListener('change', (e) => {
            const type = e.target.value;
            const selCat = document.getElementById('sel-cat');
            selCat.innerHTML = '<option value="">-- Scegli --</option>';
            document.getElementById('sel-dom').innerHTML = '';
            
            if (type === 'categorie') {
                selCat.disabled = false;
                dbStructure.categories.forEach(c => selCat.innerHTML += `<option value="${c}">${c.toUpperCase()}</option>`);
            } else {
                selCat.disabled = true;
                socket.emit('get_questions', { type: type });
            }
        });

        document.getElementById('sel-cat').addEventListener('change', (e) => {
            if(e.target.value) socket.emit('get_questions', { type: 'categoria', key: e.target.value });
        });

        document.getElementById('sel-dom').addEventListener('change', (e) => {
            if (e.target.value !== "") selectedQ = currentQuestions[e.target.value];
        });

        // COMANDI
        function lancia(mode) {
            if(!selectedQ) return alert("Scegli domanda!");
            socket.emit('invia_domanda', { ...selectedQ, modalita: mode });
        }
        function rivela() { socket.emit('rivela_risposta'); }
        function assegnaAuto() { socket.emit('assegna_punti_auto'); }
        function regia(cmd) { socket.emit('regia_cmd', cmd); }
        function daiPunti(id, pts) { socket.emit('assegna_punti', { teamId: id, punti: pts }); }
        function buzzerNext() { socket.emit('buzzer_wrong_next'); }
        function resetGame() { if(confirm("Sicuro di voler cancellare tutto?")) socket.emit('reset_game'); }
    </script>
</body>
</html>
