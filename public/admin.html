<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Control Center - Siponto</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/audio-engine.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <style>
        body { background: #070b14; color: white; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        .font-display { font-family: 'Orbitron', 'Inter', sans-serif; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #6366f1); transition: all 0.15s; border: 1px solid rgba(99,102,241,0.3); }
        .btn-primary:hover { background: linear-gradient(135deg, #2563eb, #4f46e5); transform: scale(1.02); box-shadow: 0 0 16px rgba(59,130,246,0.4); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); border: 1px solid rgba(16,185,129,0.3); }
        .btn-success:hover { background: linear-gradient(135deg, #059669, #047857); box-shadow: 0 0 16px rgba(16,185,129,0.4); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); border: 1px solid rgba(245,158,11,0.3); }
        .btn-warning:hover { background: linear-gradient(135deg, #d97706, #b45309); box-shadow: 0 0 16px rgba(245,158,11,0.4); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); border: 1px solid rgba(239,68,68,0.3); }
        .btn-danger:hover { background: linear-gradient(135deg, #dc2626, #b91c1c); box-shadow: 0 0 16px rgba(239,68,68,0.4); }
        .btn-scene { background: rgba(31,41,55,0.8); transition: all 0.15s; padding: 8px; border-radius: 8px; cursor: pointer; border: 1px solid rgba(255,255,255,0.06); }
        .btn-scene:hover { background: rgba(55,65,81,0.8); transform: scale(1.05); border-color: rgba(255,255,255,0.12); }
        .btn-scene.active { background: rgba(16,185,129,0.3); border-color: #10b981; box-shadow: 0 0 16px rgba(16,185,129,0.3); }
        .progress-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin: 0 2px; background: #1e293b; }
        .progress-dot.active { background: #ef4444; box-shadow: 0 0 10px rgba(239,68,68,0.6); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .step-btn { opacity: 0.4; pointer-events: none; }
        .step-btn.active { opacity: 1; pointer-events: auto; }
        .preview-frame { background: #000; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .admin-panel { background: rgba(15,23,42,0.6); border: 1px solid rgba(255,255,255,0.06); border-radius: 0.5rem; }

        /* Toast Notification System */
        #toast-container { position: fixed; top: 12px; right: 12px; z-index: 9999; display: flex; flex-direction: column; gap: 6px; max-width: 340px; pointer-events: none; }
        .toast { pointer-events: auto; padding: 10px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; color: white; backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 20px rgba(0,0,0,0.4); animation: toastIn 0.25s ease-out; transition: opacity 0.3s, transform 0.3s; }
        .toast.removing { opacity: 0; transform: translateX(100%); }
        .toast-info { background: rgba(59,130,246,0.9); }
        .toast-success { background: rgba(16,185,129,0.9); }
        .toast-warning { background: rgba(245,158,11,0.9); }
        .toast-error { background: rgba(239,68,68,0.9); }
        @keyframes toastIn { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }

        /* Connection Status */
        .conn-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .conn-dot.connected { background: #10b981; box-shadow: 0 0 6px #10b981; }
        .conn-dot.disconnected { background: #ef4444; box-shadow: 0 0 6px #ef4444; animation: pulse 1s infinite; }
        .conn-dot.reconnecting { background: #f59e0b; box-shadow: 0 0 6px #f59e0b; animation: pulse 0.5s infinite; }

        /* Game mode badge */
        .mode-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Question search */
        .search-input { background: rgba(31,41,55,0.8); border: 1px solid rgba(255,255,255,0.1); color: white; font-size: 12px; padding: 4px 8px; border-radius: 4px; width: 100%; }
        .search-input:focus { outline: none; border-color: rgba(59,130,246,0.5); box-shadow: 0 0 8px rgba(59,130,246,0.2); }
        .search-input::placeholder { color: rgba(255,255,255,0.3); }

        /* Score change animation */
        @keyframes scoreUp { from { color: #10b981; transform: scale(1.2); } to { color: #facc15; transform: scale(1); } }
        @keyframes scoreDown { from { color: #ef4444; transform: scale(1.2); } to { color: #facc15; transform: scale(1); } }
        .score-changed-up { animation: scoreUp 0.5s ease-out; }
        .score-changed-down { animation: scoreDown 0.5s ease-out; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- HEADER MINIMAL -->
<div class="px-4 py-2 border-b border-white/10" style="background: linear-gradient(90deg, rgba(7,11,20,0.95), rgba(15,23,42,0.95));">
    <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
            <h1 class="font-display font-black text-xl text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-orange-400 to-red-500">CONTROL CENTER</h1>
            <div class="flex items-center gap-2">
                <span class="conn-dot disconnected" id="conn-status-dot"></span>
                <span id="conn-status-text" class="text-xs text-gray-500">Connessione...</span>
            </div>
            <span id="question-counter" class="text-lg font-bold text-gray-400">Q: 0</span>
            <span id="game-mode-badge" class="mode-badge bg-gray-700 text-gray-400 hidden">IDLE</span>
            <span id="teams-count" class="text-xs font-bold text-gray-500">0 squadre</span>
        </div>
        
        <!-- Layout Presets -->
        <div class="flex items-center gap-2">
            <div class="flex gap-1 mr-3 bg-gray-900/50 rounded-lg p-1 border border-gray-700">
                <button onclick="setLayout('compact')" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-bold transition">
                    üì± Compatto
                </button>
                <button onclick="setLayout('balanced')" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs font-bold transition" id="layout-balanced">
                    ‚öñÔ∏è Bilanciato
                </button>
                <button onclick="setLayout('preview')" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-bold transition">
                    üîç Preview
                </button>
            </div>
            
            <button onclick="togglePause()" id="pause-btn" class="px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg font-bold text-sm">‚è∏Ô∏è PAUSA</button>
            <button onclick="resetGame()" class="px-3 py-2 bg-red-900 hover:bg-red-800 rounded-lg font-bold text-xs opacity-60">Reset</button>
        </div>
    </div>
</div>

<!-- LAYOUT: 20-40-40 -->
<div class="flex-1 flex gap-2 p-2 overflow-hidden">
    
    <!-- COLONNA SINISTRA: MOTORE (20%) -->
    <div id="column-left" class="w-1/5 flex flex-col gap-2 transition-all duration-300">
        <!-- Selezione -->
        <div class="admin-panel p-2">
            <div class="text-sm font-bold text-blue-400 mb-1 uppercase">üìö Selezione</div>
            <select id="sel-tipo" class="w-full bg-gray-800 text-white p-2 rounded text-sm font-bold border border-gray-700 mb-1">
                <option value="">Tipo</option>
                <option value="categoria">üìö Categorie</option>
                <option value="stima">üî¢ Stima</option>
                <option value="anagramma">üî§ Anagramma</option>
                <option value="bonus">‚≠ê Bonus</option>
            </select>
            <select id="sel-cat" class="w-full bg-gray-800 text-white p-2 rounded text-sm font-bold border border-gray-700" disabled>
                <option value="">Categoria</option>
            </select>
        </div>

        <!-- Lista Domande -->
        <div class="flex-1 admin-panel p-2 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-1">
                <div class="text-sm font-bold text-blue-400 uppercase">üìã Domande</div>
                <span id="questions-count" class="text-[10px] text-gray-500 font-bold">0</span>
            </div>
            <input type="text" id="question-search" class="search-input mb-1" placeholder="Cerca domanda..." oninput="filterQuestions()">
            <div id="questions-container" class="overflow-y-auto flex-1 text-xs">
                <div class="text-gray-500 text-center py-4">Seleziona tipo...</div>
            </div>
        </div>

        <!-- Azioni Lancio -->
        <div class="admin-panel p-2">
            <button onclick="lanciaQuiz()" class="w-full btn-primary text-white font-bold py-3 rounded-lg mb-1 text-sm">
                üéØ LANCIA QUIZ
            </button>
            <button onclick="lanciaBuzzer()" class="w-full btn-danger text-white font-bold py-3 rounded-lg text-sm">
                ‚ö° LANCIA BUZZER
            </button>
        </div>
    </div>

    <!-- COLONNA CENTRO: PREVIEW + RISPOSTE + CLASSIFICA (40%) -->
    <div id="column-center" class="w-2/5 flex flex-col gap-2 transition-all duration-300">
        <!-- Preview Ridotta -->
        <div class="h-40 admin-panel p-2 overflow-hidden">
            <div class="flex justify-between items-center mb-1">
                <div class="text-sm font-bold text-purple-400 uppercase">üì± Preview</div>
                <button onclick="refreshPreview()" class="text-xs bg-gray-800 px-2 py-0.5 rounded hover:bg-gray-700 font-bold">üîÑ</button>
            </div>
            <div class="preview-frame h-full overflow-hidden">
                <iframe id="mobile-preview" src="" class="w-full h-full border-0 pointer-events-none" style="transform: scale(0.32); transform-origin: top left; width: 313%; height: 313%;"></iframe>
            </div>
        </div>

        <!-- Monitor Risposte - PI√ô GRANDE -->
        <div class="h-56 admin-panel p-2 overflow-hidden">
            <div class="flex justify-between items-center mb-1">
                <div class="text-sm font-bold text-green-400 uppercase">‚ö° Risposte</div>
                <span id="answers-count" class="text-xs bg-gray-800 px-2 py-0.5 rounded font-bold">0/10</span>
            </div>
            <div id="answers-list" class="overflow-y-auto h-48 space-y-1 text-sm"></div>
            <div id="buzzer-monitor" class="hidden overflow-y-auto h-48 space-y-1 text-sm"></div>
        </div>

        <!-- Risposta Corretta Preview -->
        <div id="correct-answer-preview" class="hidden bg-green-900/50 rounded-lg p-3 border border-green-500 mb-2">
            <div class="text-sm font-bold text-green-400 mb-1 uppercase">‚úÖ Risposta Corretta</div>
            <div id="correct-answer-text" class="text-lg font-black text-white"></div>
        </div>

        <!-- Classifica 2 Colonne - RIDOTTA -->
        <div class="flex-1 admin-panel p-2 overflow-hidden">
            <div class="text-sm font-bold text-yellow-400 mb-1 uppercase">üìä Classifica</div>
            <div id="leaderboard-center" class="grid grid-cols-2 gap-1 text-sm overflow-y-auto max-h-40"></div>
        </div>
    </div>

    <!-- COLONNA DESTRA: MIXER (40%) -->
    <div id="column-right" class="w-2/5 flex flex-col gap-2 overflow-y-auto transition-all duration-300">
        
        <!-- Scene/Display -->
        <div class="admin-panel p-2">
            <div class="text-sm font-bold text-blue-400 mb-2 uppercase">üì∫ Scene</div>
            <div class="grid grid-cols-4 gap-1 mb-2">
                <div onclick="regia('logo')" class="btn-scene text-center text-xs font-bold">
                    <div class="text-lg">üì±</div>
                    <div>QR</div>
                </div>
                <div onclick="regia('gioco')" class="btn-scene text-center text-xs font-bold">
                    <div class="text-lg">üéÆ</div>
                    <div>Game</div>
                </div>
                <div onclick="regia('classifica_round')" class="btn-scene text-center text-xs font-bold">
                    <div class="text-lg">üèÜ</div>
                    <div>Pod</div>
                </div>
                <div onclick="regia('classifica_gen')" class="btn-scene text-center text-xs font-bold">
                    <div class="text-lg">üìä</div>
                    <div>Cls</div>
                </div>
            </div>
            <div class="grid grid-cols-6 gap-1 mb-1">
                <div onclick="regia('benvenuto')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>üéâ</div>
                    <div>Ben</div>
                </div>
                <div onclick="regia('regole')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>üìã</div>
                    <div>Reg</div>
                </div>
                <div onclick="regia('punteggi')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>üéØ</div>
                    <div>Pun</div>
                </div>
                <div onclick="regia('prossima')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>‚è∞</div>
                    <div>Pros</div>
                </div>
                <div onclick="regia('logo_forever')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>üéÆ</div>
                    <div>Logo</div>
                </div>
                <!-- BOTTONE MOSTRA VINCITORE -->
                <div onclick="socket.emit('show_winner')" class="btn-scene text-center text-[9px] font-bold py-1">
                    <div>üëë</div>
                    <div>Win</div>
                </div>
            </div>
            <!-- ‚úÖ NUOVO: Reset Round per podio -->
            <button onclick="regia('reset_round')" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-1 rounded text-[10px]">
                üîÑ Reset Round
            </button>
        </div>

        <!-- Azioni Rapide -->
        <div class="admin-panel p-2">
            <div class="text-sm font-bold text-green-400 mb-2 uppercase">‚ö° Azioni</div>
            <div class="grid grid-cols-2 gap-1">
                <!-- BOTTONE SOLUZIONE CORRETTO -->
                <button onclick="mostraSoluzione()" class="btn-warning text-white font-bold py-2 rounded text-sm">
                    üì∫ Soluzione
                </button>
                <button onclick="resetDisplays()" class="btn-danger text-white font-bold py-2 rounded text-sm">
                    üîÑ Reset Disp
                </button>
            </div>
        </div>

        <!-- Buzzer Musicale - COLLAPSIBLE -->
        <div class="bg-purple-900/20 rounded-lg border border-purple-700">
            <button onclick="toggleSection('musicale')" class="w-full flex justify-between items-center p-2 hover:bg-purple-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-purple-300 uppercase">üéµ Gioco Musicale</div>
                <span id="icon-musicale" class="text-purple-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-musicale" class="hidden p-2 pt-0">
                <div class="grid grid-cols-3 gap-1 mb-2">
                    <button onclick="openBuzzerStandalone()" class="btn-success text-white font-bold py-2 rounded text-sm">
                        üîì Apri
                    </button>
                    <button onclick="closeBuzzer()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 rounded text-sm">
                        üîí Blocca
                    </button>
                    <button onclick="resetBuzzer()" class="btn-primary text-white font-bold py-2 rounded text-sm">
                        üîÑ Reset
                    </button>
            </div>
                <div id="buzzer-queue-admin" class="hidden space-y-1 text-sm max-h-24 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Karaoke YouTube - COLLAPSIBLE -->
        <div class="bg-pink-900/20 rounded-lg border border-pink-700">
            <button onclick="toggleSection('karaoke')" class="w-full flex justify-between items-center p-2 hover:bg-pink-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-pink-300 uppercase">üé§ Karaoke YouTube</div>
                <span id="icon-karaoke" class="text-pink-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-karaoke" class="hidden p-2 pt-0">
                <!-- Input Libero -->
                <div class="mb-2">
                    <input type="text" id="youtube-id-input" placeholder="ID Video (es: dQw4w9WgXcQ)" 
                           class="w-full bg-gray-800 text-white text-xs p-2 rounded border border-gray-700 mb-1">
                    <div class="grid grid-cols-2 gap-1">
                        <button onclick="playYoutubeKaraoke()" class="btn-success text-white font-bold py-2 rounded text-sm">
                            ‚ñ∂Ô∏è Play
                        </button>
                        <button onclick="stopKaraoke()" class="btn-danger text-white font-bold py-2 rounded text-sm">
                            ‚èπÔ∏è Stop
                        </button>
                    </div>
                </div>
                
                <!-- Preset Videos -->
                <div class="text-xs text-gray-400 mb-1">Preset:</div>
                <div class="space-y-1">
                    <button onclick="playYoutubePreset('fKo44V64XnA')" class="w-full bg-pink-800 hover:bg-pink-700 text-white font-bold py-1.5 rounded text-xs">
                        üéµ Come Mai - 883
                    </button>
                    <button onclick="playYoutubePreset('xHKfX5299kc')" class="w-full bg-pink-800 hover:bg-pink-700 text-white font-bold py-1.5 rounded text-xs">
                        üéµ Pi√π Bella Cosa - Ramazzotti
                    </button>
                    <button onclick="playYoutubePreset('aVli1cR51sM')" class="w-full bg-pink-800 hover:bg-pink-700 text-white font-bold py-1.5 rounded text-xs">
                        üéµ Felicit√† - Albano
                    </button>
                </div>
            </div>
        </div>

        <!-- üîä EFFETTI AUDIO - COLLAPSIBLE -->
        <div class="bg-cyan-900/20 rounded-lg border border-cyan-700">
            <button onclick="toggleSection('audio')" class="w-full flex justify-between items-center p-2 hover:bg-cyan-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-cyan-300 uppercase">üîä Effetti Audio</div>
                <span id="icon-audio" class="text-cyan-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-audio" class="hidden p-2 pt-0">
                <!-- Toggle + Volume -->
                <div class="flex items-center gap-2 mb-2">
                    <button onclick="toggleAudioEnabled()" id="audio-toggle-btn" class="flex-1 btn-success text-white font-bold py-1.5 rounded text-xs">
                        üîä ON
                    </button>
                    <input type="range" id="audio-volume" min="0" max="100" value="50"
                           class="flex-1 h-2 accent-cyan-400" onchange="setAudioVolume(this.value)">
                    <span id="audio-volume-label" class="text-xs text-gray-400 w-8">50%</span>
                </div>

                <!-- Pulsanti Effetti Rapidi -->
                <div class="text-xs text-gray-400 mb-1">Effetti manuali:</div>
                <div class="grid grid-cols-3 gap-1 mb-1">
                    <button onclick="playSfx('gong')" class="bg-cyan-800 hover:bg-cyan-700 text-white font-bold py-1.5 rounded text-xs">
                        üîî Gong
                    </button>
                    <button onclick="playSfx('fanfare')" class="bg-cyan-800 hover:bg-cyan-700 text-white font-bold py-1.5 rounded text-xs">
                        üé∫ Fanfare
                    </button>
                    <button onclick="playSfx('drumroll', 3)" class="bg-cyan-800 hover:bg-cyan-700 text-white font-bold py-1.5 rounded text-xs">
                        ü•Å Rullo
                    </button>
                </div>
                <div class="grid grid-cols-3 gap-1 mb-1">
                    <button onclick="playSfx('correct')" class="bg-green-800 hover:bg-green-700 text-white font-bold py-1.5 rounded text-xs">
                        ‚úÖ Corretto
                    </button>
                    <button onclick="playSfx('wrong')" class="bg-red-800 hover:bg-red-700 text-white font-bold py-1.5 rounded text-xs">
                        ‚ùå Sbagliato
                    </button>
                    <button onclick="playSfx('buzzer')" class="bg-yellow-800 hover:bg-yellow-700 text-white font-bold py-1.5 rounded text-xs">
                        ‚ö° Buzzer
                    </button>
                </div>
                <div class="grid grid-cols-3 gap-1 mb-1">
                    <button onclick="playSfx('timesUp')" class="bg-orange-800 hover:bg-orange-700 text-white font-bold py-1.5 rounded text-xs">
                        ‚è∞ Tempo!
                    </button>
                    <button onclick="playSfx('suspense', 5)" class="bg-purple-800 hover:bg-purple-700 text-white font-bold py-1.5 rounded text-xs">
                        üò± Suspense
                    </button>
                    <button onclick="playSfx('reveal')" class="bg-indigo-800 hover:bg-indigo-700 text-white font-bold py-1.5 rounded text-xs">
                        üé≠ Reveal
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-1">
                    <button onclick="playSfx('countdownBeeps', 5)" class="bg-red-900 hover:bg-red-800 text-white font-bold py-1.5 rounded text-xs">
                        ‚è≥ Countdown 5s
                    </button>
                    <button onclick="playSfx('wheelSpin', 4)" class="bg-yellow-900 hover:bg-yellow-800 text-white font-bold py-1.5 rounded text-xs">
                        üé∞ Ruota Spin
                    </button>
                </div>
            </div>
        </div>

        <!-- Ruota della Fortuna - COLLAPSIBLE -->
        <div class="bg-yellow-900/20 rounded-lg border border-yellow-700">
            <button onclick="toggleSection('ruota')" class="w-full flex justify-between items-center p-2 hover:bg-yellow-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-yellow-300 uppercase">üé∞ Ruota Fortuna</div>
                <span id="icon-ruota" class="text-yellow-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-ruota" class="hidden p-2 pt-0">
                <div class="space-y-1">
                    <button onclick="ruotaStep(1)" class="w-full btn-primary text-white font-bold py-2 rounded text-sm">
                        1Ô∏è‚É£ Spiega Regole
                    </button>
                    <button onclick="ruotaStep(2)" class="w-full btn-warning text-white font-bold py-2 rounded text-sm">
                        2Ô∏è‚É£ Gira Ruota
                    </button>
                    <button onclick="ruotaStep(3)" class="w-full btn-success text-white font-bold py-2 rounded text-sm">
                        3Ô∏è‚É£ Mostra Scelta
                    </button>
                    <div id="ruota-winner-display" class="hidden text-xs text-center py-2 bg-yellow-900/30 rounded font-bold">
                        Estratto: <span id="ruota-winner-name">---</span>
                    </div>
                    <button onclick="ruotaStep(4)" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 rounded text-sm">
                        4Ô∏è‚É£ Lancia Domanda Sfida
                    </button>
                </div>
            </div>
        </div>

        <!-- DUELLO RUBA-PUNTI - COLLAPSIBLE -->
        <div class="bg-red-900/20 rounded-lg border border-red-700">
            <button onclick="toggleSection('duello')" class="w-full flex justify-between items-center p-2 hover:bg-red-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-red-300 uppercase">üî• Duello Ruba-Punti</div>
                <span id="icon-duello" class="text-red-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-duello" class="hidden p-2 pt-0">
                <div class="space-y-1">
                    <button onclick="duelloStep(1)" id="duello-step-1" class="w-full btn-primary text-white font-bold py-2 rounded text-sm">
                        1Ô∏è‚É£ Avvia Duello
                    </button>
                    <div id="duello-attaccante-display" class="hidden text-xs text-center py-2 bg-red-900/40 rounded font-bold border border-red-700">
                        <div class="text-yellow-400">ATTACCANTE:</div>
                        <div id="duello-attaccante-name" class="text-white text-sm">---</div>
                    </div>
                    <button onclick="duelloStep(2)" id="duello-step-2" class="w-full btn-warning text-white font-bold py-2 rounded text-sm opacity-40 pointer-events-none">
                        2Ô∏è‚É£ Scelta Avversario
                    </button>
                    <div id="duello-difensore-display" class="hidden text-xs text-center py-2 bg-blue-900/40 rounded font-bold border border-blue-700">
                        <div class="text-blue-400">DIFENSORE:</div>
                        <div id="duello-difensore-name" class="text-white text-sm">---</div>
                    </div>
                    <button onclick="duelloStep(3)" id="duello-step-3" class="w-full btn-success text-white font-bold py-2 rounded text-sm opacity-40 pointer-events-none">
                        3Ô∏è‚É£ Scelta Categoria
                    </button>
                    <div id="duello-categoria-display" class="hidden text-xs text-center py-2 bg-purple-900/40 rounded font-bold border border-purple-700">
                        <div class="text-purple-400">CATEGORIA:</div>
                        <div id="duello-categoria-name" class="text-white text-sm">---</div>
                    </div>
                    <div class="border-t border-red-700 my-2 pt-2">
                        <div class="text-xs text-center text-gray-400 mb-1">DOMANDA DUELLO</div>
                        <button onclick="duelloStep(4)" id="duello-step-4" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 rounded text-sm opacity-40 pointer-events-none">
                            üéØ Lancia Domanda
                        </button>
                    </div>
                    <div id="duello-scoreboard" class="hidden text-center py-2 bg-black/40 rounded border border-gray-700">
                        <div class="flex justify-center items-center gap-3 text-2xl font-black">
                            <span id="duello-score-att" class="text-yellow-400">0</span>
                            <span class="text-white">-</span>
                            <span id="duello-score-dif" class="text-blue-400">0</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">Primo a 2 vince</div>
                    </div>
                    <div id="duello-answer-buttons" class="hidden space-y-1 border-t border-red-700 pt-2">
                        <div class="text-xs text-center text-yellow-400 mb-1">
                            Risponde: <span id="duello-current-answerer">---</span>
                        </div>
                        <div class="grid grid-cols-2 gap-1">
                            <button onclick="duelloAnswerResult(true)" class="btn-success text-white font-bold py-2 rounded text-sm">
                                ‚úÖ CORRETTO
                            </button>
                            <button onclick="duelloAnswerResult(false)" class="btn-danger text-white font-bold py-2 rounded text-sm">
                                ‚ùå SBAGLIATO
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MEMORY GAME - COLLAPSIBLE -->
        <div class="bg-purple-900/20 rounded-lg border border-purple-700">
            <button onclick="toggleSection('memory')" class="w-full flex justify-between items-center p-2 hover:bg-purple-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-purple-300 uppercase">üß† Memory Game</div>
                <span id="icon-memory" class="text-purple-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-memory" class="hidden p-2 pt-0">
                <div class="space-y-1">
                    <button onclick="startMemoryGame()" class="w-full btn-primary text-white font-bold py-2 rounded text-sm">
                        üéÆ AVVIA MEMORY
                    </button>
                    <div id="memory-status" class="hidden text-xs text-center py-2 bg-purple-900/30 rounded font-bold">
                        Manche: <span id="memory-manche-display">1/3</span>
                    </div>
                    <div class="grid grid-cols-2 gap-1">
                        <button onclick="skipMemoryRound()" class="btn-warning text-white font-bold py-2 rounded text-sm">
                            ‚è≠Ô∏è Skip Round
                        </button>
                        <button onclick="stopMemoryGame()" class="btn-danger text-white font-bold py-2 rounded text-sm">
                            üõë Stop
                        </button>
                        </div>
                </div>
            </div>
        </div>

        <!-- ‚úÖ FIX COMPLETO: Sfida Finale - COLLAPSIBLE -->
        <div class="bg-red-900/20 rounded-lg border border-red-700">
            <button onclick="toggleSection('finale')" class="w-full flex justify-between items-center p-2 hover:bg-red-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-red-300 uppercase">üî• Sfida Finale</div>
                <span id="icon-finale" class="text-red-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-finale" class="hidden p-2 pt-0">
                <div class="space-y-1">
                    <button onclick="showFinaleExplanation()" id="step-1" class="step-btn active w-full btn-primary text-white font-bold py-2 rounded text-sm">
                        1Ô∏è‚É£ Spiega Regole
                    </button>
                    <button onclick="startFinale()" id="step-2" class="step-btn w-full btn-danger text-white font-bold py-2 rounded text-sm">
                        2Ô∏è‚É£ Attiva Finale
                    </button>
                    <button onclick="prepareAllIn()" id="step-3" class="step-btn w-full btn-warning text-white font-bold py-2 rounded text-sm">
                        3Ô∏è‚É£ Prepara ALL IN
                    </button>
                    <div id="allin-bets-status" class="hidden text-xs text-center text-yellow-400 py-1 font-bold">
                        üí∞ <span id="allin-counter">0</span>/<span id="allin-total">0</span> squadre
                    </div>
                    <button onclick="showAllInResults()" id="step-4" class="step-btn w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 rounded text-sm">
                        4Ô∏è‚É£ Mostra Risultati
                    </button>
                    <button onclick="processAllIn()" id="step-5" class="step-btn w-full btn-success text-white font-bold py-2 rounded text-sm">
                        5Ô∏è‚É£ Elabora Punteggi
                    </button>
                    <div id="step-6" class="step-btn text-xs text-gray-400 text-center py-1">
                        6Ô∏è‚É£ Lancia domande 2-5 (x2)
                    </div>
                    <button onclick="revealWinner()" id="step-6-btn" class="step-btn w-full btn-warning text-white font-bold py-2 rounded text-sm">
                        7Ô∏è‚É£ RIVELA VINCITORE üëë
                    </button>
                    <div id="finale-progress" class="hidden text-center py-1">
                        <span class="progress-dot"></span>
                        <span class="progress-dot"></span>
                        <span class="progress-dot"></span>
                        <span class="progress-dot"></span>
                        <span class="progress-dot"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- üíÄ IL PATTO COL DESTINO - COLLAPSIBLE -->
        <div class="bg-purple-900/20 rounded-lg border border-purple-700">
            <button onclick="toggleSection('patto')" class="w-full flex justify-between items-center p-2 hover:bg-purple-900/30 transition rounded-lg">
                <div class="text-sm font-bold text-purple-300 uppercase">üíÄ Il Patto col Destino</div>
                <span id="icon-patto" class="text-purple-300 font-bold text-lg">‚ñº</span>
            </button>
            <div id="content-patto" class="hidden p-2 pt-0">
                <div class="space-y-1">
                    <button onclick="pattoShowRegole()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded text-sm">
                        üìú Spiega Regole
                    </button>
                    <button onclick="pattoAvvia()" id="patto-avvia-btn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 rounded text-sm">
                        üé≤ AVVIA PATTO
                    </button>
                    <div id="patto-utilizzi-display" class="text-xs text-center py-2 bg-purple-900/30 rounded font-bold">
                        Utilizzi: <span id="patto-usi">0</span>/2
                    </div>
                    <div id="patto-status" class="hidden text-xs text-center py-2 rounded font-bold">
                        <!-- Popolato dinamicamente -->
                    </div>
                    <div id="patto-scelte-status" class="hidden text-xs space-y-1">
                        <!-- Mostra chi ha scelto -->
                    </div>
                    <button onclick="pattoReset()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-1.5 rounded text-xs">
                        üîÑ Reset
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Ottimizzazione Socket.io: preferisci WebSocket, compressione, riconnessione veloce
    const socket = io({
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionAttempts: Infinity,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      timeout: 10000
    });
    let currentQuestions = [], selectedQ = null, dbStructure = {};
    let isPaused = false, finaleActive = false, finaleQuestionCount = 0;
    let totalQuestionsAsked = 0, allInPrepared = false, totalTeams = 0;
    let gameState = { teams: {} };
    let previousScores = {}; // Per animazione cambio punteggio
    let currentGameMode = 'idle'; // Traccia modalit√† corrente

    // ============================================
    // TOAST NOTIFICATION SYSTEM (sostituisce alert)
    // ============================================
    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('removing');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // ============================================
    // CONNECTION STATUS
    // ============================================
    function updateConnectionStatus(status) {
        const dot = document.getElementById('conn-status-dot');
        const text = document.getElementById('conn-status-text');
        dot.className = 'conn-dot ' + status;
        const labels = { connected: 'Connesso', disconnected: 'Disconnesso', reconnecting: 'Riconnessione...' };
        text.textContent = labels[status] || status;
        text.className = 'text-xs ' + (status === 'connected' ? 'text-green-400' : status === 'disconnected' ? 'text-red-400' : 'text-yellow-400');
    }

    socket.on('connect', () => {
        updateConnectionStatus('connected');
        socket.emit('admin_connect');
        showToast('Connesso al server', 'success', 2000);
    });
    socket.on('disconnect', () => {
        updateConnectionStatus('disconnected');
        showToast('Connessione persa! Riconnessione...', 'error', 4000);
    });
    socket.on('reconnect_attempt', (n) => {
        updateConnectionStatus('reconnecting');
    });
    socket.on('reconnect', () => {
        updateConnectionStatus('connected');
        socket.emit('admin_connect');
        showToast('Riconnesso!', 'success', 2000);
    });

    // ============================================
    // GAME MODE STATUS
    // ============================================
    function setGameMode(mode) {
        currentGameMode = mode;
        const badge = document.getElementById('game-mode-badge');
        const modes = {
            idle: { text: 'IDLE', bg: 'bg-gray-700', color: 'text-gray-400' },
            quiz: { text: 'QUIZ', bg: 'bg-blue-600', color: 'text-white' },
            buzzer: { text: 'BUZZER', bg: 'bg-red-600', color: 'text-white' },
            memory: { text: 'MEMORY', bg: 'bg-purple-600', color: 'text-white' },
            duello: { text: 'DUELLO', bg: 'bg-orange-600', color: 'text-white' },
            finale: { text: 'FINALE', bg: 'bg-red-700', color: 'text-white' },
            ruota: { text: 'RUOTA', bg: 'bg-yellow-600', color: 'text-black' },
            patto: { text: 'PATTO', bg: 'bg-purple-700', color: 'text-white' }
        };
        const m = modes[mode] || modes.idle;
        badge.textContent = m.text;
        badge.className = `mode-badge ${m.bg} ${m.color}`;
        badge.classList.remove('hidden');
    }

    socket.on('init_data', (d) => {
        dbStructure = d;
        totalTeams = d.teams.length;
        updateTeams(d.teams);
        populateCategories();
        refreshPreview();
    });

    function populateCategories() {
        const sc = document.getElementById('sel-cat');
        sc.innerHTML = '<option value="">Categoria</option>';
        if(dbStructure.categories) {
            dbStructure.categories.forEach(c => {
                sc.innerHTML += `<option value="${c}">${c.replace(/_/g,' ')}</option>`;
            });
        }
    }

    document.getElementById('sel-tipo').addEventListener('change', (e) => {
        const t = e.target.value;
        const sc = document.getElementById('sel-cat');
        if(t === 'categoria') {
            sc.disabled = false;
        } else {
            sc.disabled = true;
            if(t) socket.emit('get_questions', {type: t});
        }
    });

    document.getElementById('sel-cat').addEventListener('change', (e) => {
        if(e.target.value) socket.emit('get_questions', {type: 'categoria', category: e.target.value});
    });

    socket.on('questions_list', (q) => {  // ‚úÖ FIX: Era 'receive_questions'
        currentQuestions = q;
        showQuestionsList(q);
    });

    function showQuestionsList(questions) {
        const container = document.getElementById('questions-container');
        const countEl = document.getElementById('questions-count');
        container.innerHTML = '';
        countEl.textContent = questions.length;

        // Usa DocumentFragment per performance DOM
        const fragment = document.createDocumentFragment();
        questions.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'p-2 bg-gray-800 rounded mb-1 cursor-pointer hover:bg-gray-700 border border-gray-700';
            div.dataset.index = i;
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-bold text-blue-400">Q${i+1}</span>
                    <span class="text-[9px] text-gray-500">${item.punti || 100}pt</span>
                </div>
                <div class="leading-tight mt-0.5">${item.domanda.substring(0,60)}${item.domanda.length > 60 ? '...' : ''}</div>
            `;
            div.onclick = () => selectQuestion(i);
            fragment.appendChild(div);
        });
        container.appendChild(fragment);

        // Reset search
        document.getElementById('question-search').value = '';
    }

    function filterQuestions() {
        const query = document.getElementById('question-search').value.toLowerCase().trim();
        const container = document.getElementById('questions-container');
        const items = container.children;
        let visibleCount = 0;

        for (let i = 0; i < items.length; i++) {
            const text = items[i].textContent.toLowerCase();
            const match = !query || text.includes(query);
            items[i].style.display = match ? '' : 'none';
            if (match) visibleCount++;
        }

        document.getElementById('questions-count').textContent = query ? `${visibleCount}/${currentQuestions.length}` : currentQuestions.length;
    }

    function selectQuestion(index) {
        selectedQ = currentQuestions[index];
        document.querySelectorAll('#questions-container > div').forEach((el, i) => {
            el.className = i === index ? 
                'p-2 bg-blue-600 rounded mb-1 cursor-pointer border-2 border-blue-400' : 
                'p-2 bg-gray-800 rounded mb-1 cursor-pointer hover:bg-gray-700 border border-gray-700';
        });
    }

    function lanciaQuiz() { if(selectedQ) lancia('quiz'); else showToast('Seleziona una domanda!', 'error'); }
    function lanciaBuzzer() { if(selectedQ) lancia('buzzer'); else showToast('Seleziona una domanda prima!', 'error'); }

    function lancia(m) {
        totalQuestionsAsked++;
        document.getElementById('question-counter').textContent = `Q: ${totalQuestionsAsked}`;
        setGameMode(m === 'buzzer' ? 'buzzer' : finaleActive ? 'finale' : 'quiz');

        if(finaleActive) {
            finaleQuestionCount++;
            updateFinaleProgress();
            socket.emit('invia_domanda_finale', {...selectedQ, modalita: m});
            if(finaleQuestionCount >= 5) activateStep(6);
        } else {
            socket.emit('invia_domanda', {...selectedQ, modalita: m});
        }
    }

    socket.on('update_round_monitor', (data) => {
        document.getElementById('answers-count').textContent = `${data.length}/${totalTeams}`;
        const list = document.getElementById('answers-list');
        list.innerHTML = '';
        
        data.forEach((res) => {
            const div = document.createElement('div');
            div.className = `p-2 rounded ${res.corretta ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`;
            div.innerHTML = `
                <span class="font-bold">${res.teamName}</span>
                <span class="float-right font-bold">${res.corretta ? '+' : ''}${res.punti || 0}</span>
            `;
            list.appendChild(div);
        });
    });

    socket.on('reset_round_monitor', () => {
        document.getElementById('answers-list').innerHTML = '';
        document.getElementById('answers-list').classList.remove('hidden');
        document.getElementById('buzzer-monitor').classList.add('hidden');
        document.getElementById('buzzer-monitor').innerHTML = '';
    });

    socket.on('buzzer_queue_full', (d) => {
        const isMusicBuzzer = d.standalone || false;
        
        if(isMusicBuzzer) {
            const queueDiv = document.getElementById('buzzer-queue-admin');
            queueDiv.classList.remove('hidden');
            queueDiv.innerHTML = '';
            
            if(d.queue && d.queue.length > 0) {
                d.queue.forEach((player, idx) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const div = document.createElement('div');
                    div.className = 'bg-black/30 rounded p-2 mb-1';
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold">${medals[idx] || (idx+1)+'.'} ${player.name}</span>
                            <span class="text-yellow-400 text-xs">${player.time}s</span>
                        </div>
                        <div class="grid grid-cols-3 gap-1">
                            <button onclick="assignPoints('${player.id}', 100)" class="bg-green-600 hover:bg-green-500 text-white text-xs py-1 rounded font-bold">+100</button>
                            <button onclick="assignPoints('${player.id}', 50)" class="bg-blue-600 hover:bg-blue-500 text-white text-xs py-1 rounded font-bold">+50</button>
                            <button onclick="assignPoints('${player.id}', -50)" class="bg-red-600 hover:bg-red-500 text-white text-xs py-1 rounded font-bold">-50</button>
                        </div>
                    `;
                    queueDiv.appendChild(div);
                });
            }
        } else {
            const monitorDiv = document.getElementById('buzzer-monitor');
            const answersList = document.getElementById('answers-list');
            
            monitorDiv.classList.remove('hidden');
            answersList.classList.add('hidden');
            monitorDiv.innerHTML = '';
            
            document.getElementById('answers-count').textContent = `${d.queue.length}/10`;
            
            if(d.queue && d.queue.length > 0) {
                d.queue.forEach((player, idx) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const medal = medals[idx] || `${idx + 1}¬∞`;
                    
                    const div = document.createElement('div');
                    div.className = 'bg-black/30 rounded p-2 mb-1';
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold">${medal} ${player.name}</span>
                            <span class="text-yellow-400 text-xs">${player.time}s</span>
                        </div>
                        <div class="grid grid-cols-3 gap-1">
                            <button onclick="assignPoints('${player.id}', 100)" class="bg-green-600 hover:bg-green-500 text-white text-xs py-1 rounded font-bold">+100</button>
                            <button onclick="assignPoints('${player.id}', 50)" class="bg-blue-600 hover:bg-blue-500 text-white text-xs py-1 rounded font-bold">+50</button>
                            <button onclick="assignPoints('${player.id}', -50)" class="bg-red-600 hover:bg-red-500 text-white text-xs py-1 rounded font-bold">-50</button>
                        </div>
                    `;
                    monitorDiv.appendChild(div);
                });
            }
        }
    });

    socket.on('reset_buzzer_admin', () => {
        document.getElementById('buzzer-queue-admin').classList.add('hidden');
        document.getElementById('buzzer-queue-admin').innerHTML = '';
    });

    function resetBuzzer() { 
        socket.emit('buzzer_reset'); 
    }
    
    function openBuzzerStandalone() {
        socket.emit('start_buzzer', { domanda: 'üéµ Premi quando sai la risposta!' });
        setGameMode('buzzer');
        console.log('üéµ Buzzer standalone attivato');
    }
    
    function closeBuzzer() { 
        socket.emit('buzzer_close');
        console.log('üîí Buzzer chiuso');
    }

    function assignPoints(teamId, points) {
        // ‚úÖ FIX: Usa 'assign_points' invece di 'admin_punti_manuali'
        socket.emit('assign_points', { teamId: teamId, points: points });
        console.log(`‚úÖ Assegnati ${points} punti a ${teamId}`);
        
        // Reset buzzer dopo assegnazione (per gioco musicale)
        setTimeout(() => {
            socket.emit('reset_buzzer');
        }, 500);
    }

    socket.on('update_teams', (teams) => {
        totalTeams = teams.length;
        document.getElementById('teams-count').textContent = `${teams.length} squadre`;

        const lb = document.getElementById('leaderboard-center');
        const sorted = [...teams].sort((a, b) => b.score - a.score);

        // Usa DocumentFragment per ridurre reflow DOM
        const fragment = document.createDocumentFragment();
        sorted.forEach((t, i) => {
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            const medal = i < 3 ? medals[i] : `${i + 1}¬∞`;

            // Rileva cambio punteggio per animazione
            const prevScore = previousScores[t.id];
            let scoreClass = 'text-yellow-400 font-black text-sm';
            if (prevScore !== undefined && prevScore !== t.score) {
                scoreClass += t.score > prevScore ? ' score-changed-up' : ' score-changed-down';
            }
            previousScores[t.id] = t.score;

            const div = document.createElement('div');
            div.className = 'bg-gray-800/70 rounded-lg p-2 flex items-center justify-between border border-gray-700';
            div.innerHTML = `
                <div class="flex items-center gap-2 flex-1 min-w-0">
                    <span class="text-xl">${medal}</span>
                    <span class="font-bold text-white text-sm truncate">${t.name}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="${scoreClass}">${t.score}</span>
                    <button onclick="adjustPoints('${t.id}', 50)" class="bg-green-600 hover:bg-green-500 text-white font-bold px-2 py-1 rounded text-xs">+</button>
                    <button onclick="adjustPoints('${t.id}', -50)" class="bg-red-600 hover:bg-red-500 text-white font-bold px-2 py-1 rounded text-xs">‚àí</button>
                </div>
            `;
            fragment.appendChild(div);
        });
        lb.innerHTML = '';
        lb.appendChild(fragment);
    });

    // ‚úÖ Funzione per aggiungere/togliere punti
    function adjustPoints(teamId, points) {
        socket.emit('assign_points', { teamId: teamId, points: points });
        console.log(`üí∞ ${points > 0 ? '+' : ''}${points} punti a ${teamId}`);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üé§ KARAOKE YOUTUBE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function playYoutubeKaraoke() {
        const videoId = document.getElementById('youtube-id-input').value.trim();
        if(!videoId) {
            showToast('Inserisci un Video ID!', 'error');
            return;
        }
        socket.emit('play_youtube_karaoke', { videoId: videoId });
        console.log('üé§ Karaoke avviato:', videoId);
    }

    function playYoutubePreset(videoId) {
        socket.emit('play_youtube_karaoke', { videoId: videoId });
        document.getElementById('youtube-id-input').value = videoId;
        console.log('üé§ Preset karaoke:', videoId);
    }

    function stopKaraoke() {
        socket.emit('stop_karaoke');
        console.log('‚èπÔ∏è Karaoke fermato');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üîä EFFETTI AUDIO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let audioEnabled = true;

    function playSfx(effect, duration) {
        const data = { effect: effect };
        if (duration) data.duration = duration;
        
        // Invia al server per broadcast a tutti i display
        socket.emit('play_sfx', data);
        
        // Riproduci anche localmente nell'admin
        if (audioEnabled && typeof SipontoAudio !== 'undefined') {
            const fn = SipontoAudio[effect];
            if (typeof fn === 'function') {
                fn(duration);
            }
        }
        
        console.log('üîä SFX inviato:', effect);
    }

    function toggleAudioEnabled() {
        audioEnabled = !audioEnabled;
        
        // Invia comando ai display
        socket.emit('audio_set_enabled', { enabled: audioEnabled });
        
        // Imposta anche localmente nell'admin
        if (typeof SipontoAudio !== 'undefined') {
            SipontoAudio.setEnabled(audioEnabled);
        }
        
        const btn = document.getElementById('audio-toggle-btn');
        if (audioEnabled) {
            btn.textContent = 'üîä ON';
            btn.className = 'flex-1 btn-success text-white font-bold py-1.5 rounded text-xs';
        } else {
            btn.textContent = 'üîá OFF';
            btn.className = 'flex-1 btn-danger text-white font-bold py-1.5 rounded text-xs';
        }
        console.log('üîä Audio:', audioEnabled ? 'ON' : 'OFF');
    }

    function setAudioVolume(val) {
        const volume = parseInt(val) / 100;
        
        // Invia comando ai display
        socket.emit('audio_set_volume', { volume: volume });
        
        // Imposta anche localmente nell'admin
        if (typeof SipontoAudio !== 'undefined') {
            SipontoAudio.setVolume(volume);
        }
        
        document.getElementById('audio-volume-label').textContent = val + '%';
        console.log('üîä Volume:', val + '%');
    }

    // Ruota della Fortuna Functions
    let ruotaWinner = null;

    function ruotaStep(step) {
        switch(step) {
            case 1:
                // Spiega regole
                socket.emit('ruota_step', { step: 'explain' });
                setGameMode('ruota');
                console.log('üé∞ Spiegazione Ruota');
                break;
            case 2:
                // Gira ruota e estrae squadra
                socket.emit('ruota_step', { step: 'spin' });
                console.log('üé∞ Ruota gira...');
                break;
            case 3:
                // Mostra scelta al telefono
                if(!ruotaWinner) {
                    showToast('Prima gira la ruota!', 'warning');
                    return;
                }
                socket.emit('ruota_step', { step: 'choice', teamId: ruotaWinner.id });
                console.log('üé∞ Mostra scelta a:', ruotaWinner.name);
                break;
            case 4:
                // Lancia domanda sfida
                // ‚úÖ FIX: Controllo migliorato - verifica sia squadra che domanda
                if(!ruotaWinner) {
                    showToast('Prima gira la ruota e aspetta l\'estrazione!', 'warning');
                    return;
                }
                if(!selectedQ) {
                    showToast('Seleziona una domanda dalla lista!', 'warning');
                    return;
                }
                console.log('üé∞ Invio domanda sfida:', selectedQ.domanda, 'a squadra:', ruotaWinner.name);
                socket.emit('ruota_step', { step: 'challenge', question: selectedQ });
                console.log('‚úÖ Domanda sfida lanciata con successo');
                break;
        }
    }

    // Riceve squadra estratta dalla ruota
    socket.on('ruota_winner', (data) => {
        ruotaWinner = data.winner; // ‚úÖ FIX: Accede a data.winner invece di data
        document.getElementById('ruota-winner-display').classList.remove('hidden');
        document.getElementById('ruota-winner-name').textContent = data.winner.name;
        console.log('üé∞ ESTRATTO:', data.winner.name); // ‚úÖ FIX: Console log pi√π evidente
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üî• DUELLO RUBA-PUNTI Functions
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    let duelloAttaccante = null;
    let duelloDifensore = null;
    let duelloCategoria = null;

    function duelloStep(step) {
        switch(step) {
            case 1:
                // Avvia duello - estrae attaccante
                socket.emit('duello_start');
                setGameMode('duello');
                console.log('üî• Duello avviato');
                break;
            case 2:
                // Mostra scelta avversario
                if(!duelloAttaccante) {
                    showToast('Prima avvia il duello!', 'warning');
                    return;
                }
                socket.emit('duello_show_opponent_choice');
                console.log('üî• Mostra scelta avversario');
                break;
            case 3:
                // Mostra scelta categoria
                if(!duelloDifensore) {
                    showToast('Prima scegli l\'avversario!', 'warning');
                    return;
                }
                socket.emit('duello_show_category_choice');
                console.log('üî• Mostra scelta categoria');
                break;
            case 4:
                // Lancia domanda duello
                if(!duelloCategoria) {
                    showToast('Prima scegli la categoria!', 'warning');
                    return;
                }
                if(!selectedQ) {
                    showToast('Seleziona una domanda dalla categoria ' + duelloCategoria + '!', 'warning');
                    return;
                }
                socket.emit('duello_launch_question', { question: selectedQ });
                console.log('üî• Domanda duello lanciata');
                break;
        }
    }

    function duelloAnswerResult(correct) {
        socket.emit('duello_answer_result', { correct: correct });
        console.log('üî• Risposta:', correct ? 'CORRETTA' : 'SBAGLIATA');
    }

    // Riceve attaccante estratto
    socket.on('duello_attaccante', (data) => {
        duelloAttaccante = data.attaccante;
        document.getElementById('duello-attaccante-display').classList.remove('hidden');
        document.getElementById('duello-attaccante-name').textContent = data.attaccante.name;
        
        // Abilita step 2
        document.getElementById('duello-step-2').classList.remove('opacity-40', 'pointer-events-none');
        
        console.log('üî• Attaccante:', data.attaccante.name);
    });

    // Riceve difensore scelto
    socket.on('duello_difensore_scelto', (data) => {
        duelloDifensore = data.difensore;
        document.getElementById('duello-difensore-display').classList.remove('hidden');
        document.getElementById('duello-difensore-name').textContent = data.difensore.name;
        
        // Abilita step 3
        document.getElementById('duello-step-3').classList.remove('opacity-40', 'pointer-events-none');
        
        console.log('üî• Difensore:', data.difensore.name);
    });

    // Riceve categoria scelta
    socket.on('duello_categoria_scelta', (data) => {
        duelloCategoria = data.category;
        document.getElementById('duello-categoria-display').classList.remove('hidden');
        document.getElementById('duello-categoria-name').textContent = data.category.toUpperCase();
        
        // Abilita step 4 e mostra scoreboard
        document.getElementById('duello-step-4').classList.remove('opacity-40', 'pointer-events-none');
        document.getElementById('duello-scoreboard').classList.remove('hidden');
        
        console.log('üî• Categoria:', data.category);
    });

    // In attesa risposta (chi ha premuto buzzer)
    socket.on('duello_waiting_answer', (data) => {
        document.getElementById('duello-answer-buttons').classList.remove('hidden');
        document.getElementById('duello-current-answerer').textContent = data.teamName;
        console.log('üî• Risponde:', data.teamName, '| Risposta corretta:', data.correctAnswer);
    });

    // L'altro pu√≤ rispondere (dopo sbagliata)
    socket.on('duello_other_can_answer', (data) => {
        document.getElementById('duello-current-answerer').textContent = data.teamName;
        console.log('üî• Ora risponde:', data.teamName, '| Risposta corretta:', data.correctAnswer);
    });

    // Punto segnato
    socket.on('duello_point_scored', (data) => {
        document.getElementById('duello-score-att').textContent = data.scoreAttaccante;
        document.getElementById('duello-score-dif').textContent = data.scoreDifensore;
        document.getElementById('duello-answer-buttons').classList.add('hidden');
        console.log('üî• Score:', data.scoreAttaccante, '-', data.scoreDifensore);
    });

    // Prossima domanda
    socket.on('duello_next_question', () => {
        showToast('Punto segnato! Lancia la prossima domanda', 'success');
        console.log('üî• Pronto per prossima domanda');
    });

    // Fine duello
    socket.on('duello_end', (data) => {
        showToast(`${data.winner.name} VINCE IL DUELLO!`, 'success', 5000);
        setGameMode('idle');

        // Reset UI duello
        duelloAttaccante = null;
        duelloDifensore = null;
        duelloCategoria = null;
        
        document.getElementById('duello-attaccante-display').classList.add('hidden');
        document.getElementById('duello-difensore-display').classList.add('hidden');
        document.getElementById('duello-categoria-display').classList.add('hidden');
        document.getElementById('duello-scoreboard').classList.add('hidden');
        document.getElementById('duello-answer-buttons').classList.add('hidden');
        
        document.getElementById('duello-step-2').classList.add('opacity-40', 'pointer-events-none');
        document.getElementById('duello-step-3').classList.add('opacity-40', 'pointer-events-none');
        document.getElementById('duello-step-4').classList.add('opacity-40', 'pointer-events-none');
        
        document.getElementById('duello-score-att').textContent = '0';
        document.getElementById('duello-score-dif').textContent = '0';
        
        console.log('üî• Duello terminato');
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üß† MEMORY GAME - ADMIN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function startMemoryGame() {
        if(confirm('Avviare Memory Game (3 round)?')) {
            socket.emit('memory_start');
            setGameMode('memory');
            document.getElementById('memory-status').classList.remove('hidden');
            console.log('üß† Memory avviato');
        }
    }

    function skipMemoryRound() {
        socket.emit('memory_skip_round');
        console.log('üß† Round saltata');
    }

    function stopMemoryGame() {
        if(confirm('Fermare Memory Game?')) {
            socket.emit('memory_stop');
            setGameMode('idle');
            document.getElementById('memory-status').classList.add('hidden');
            console.log('üß† Memory fermato');
        }
    }

    socket.on('memory_manche_intro', (data) => {
        document.getElementById('memory-manche-display').textContent = `${data.manche}/${data.totalManches}`;
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚úÖ FIX COMPLETO: SFIDA FINALE - FUNZIONI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function showFinaleExplanation() {
        socket.emit('show_finale_explanation');
        setTimeout(() => activateStep(2), 20000);
        console.log('üî• Spiegazione finale inviata');
    }

    function startFinale() {
        if(confirm('ATTENZIONE: Iniziare la SFIDA FINALE?\nLa classifica verr√† nascosta.')) {
            socket.emit('start_finale');
            finaleActive = true;
            setGameMode('finale');
            finaleQuestionCount = 0;
            document.getElementById('finale-progress').classList.remove('hidden');
            activateStep(3);
            console.log('üî• Finale attivata');
        }
    }

    function prepareAllIn() {
        if(!selectedQ) {
            showToast('Seleziona una domanda per ALL IN!', 'error');
            return;
        }
        
        // Modifica i punti della domanda per i pulsanti 100-500
        selectedQ.allInOptions = [100, 200, 300, 500];
        
        socket.emit('prepare_allin', selectedQ);
        activateStep(4);
        
        // Mostra contatore scommesse
        document.getElementById('allin-bets-status').classList.remove('hidden');
        document.getElementById('allin-counter').textContent = '0';
        
        const realTeams = Object.values(gameState.teams || {}).filter(t => !t.isPreview);
        document.getElementById('allin-total').textContent = realTeams.length;
        
        console.log('üí∞ ALL IN preparato con domanda:', selectedQ.domanda);
    }

    function showAllInResults() {
        socket.emit('admin_force_show_allin');
        console.log('üìä Risultati ALL IN mostrati sul display');
        
        // Dopo 10 secondi, abilita elaborazione
        setTimeout(() => {
            activateStep(5);
            showToast('Risultati mostrati! Clicca "Elabora Punteggi"', 'info', 4000);
        }, 1000);
    }

    function processAllIn() {
        socket.emit('process_allin_results');
        activateStep(6);
        console.log('üí∞ Punteggi ALL IN in elaborazione...');
    }

    function revealWinner() {
        if(confirm('RIVELARE IL VINCITORE FINALE?')) {
            socket.emit('reveal_winner');
            finaleActive = false;
            setGameMode('idle');
            document.getElementById('finale-progress').classList.add('hidden');
            activateStep(1);
            console.log('üèÜ Vincitore finale rivelato');
        }
    }

    socket.on('allin_bet_placed', (data) => {
        document.getElementById('allin-counter').textContent = data.betsCount;
        
        // Se tutte le squadre hanno scommesso
        if(data.betsCount >= data.totalTeams) {
            document.getElementById('allin-bets-status').innerHTML = `
                <div class="bg-green-600 text-white p-1 rounded text-xs font-bold animate-pulse">
                    ‚úÖ TUTTE LE ${data.totalTeams} SQUADRE HANNO SCOMMESSO!
                </div>
            `;
        }
        
        console.log(`üí∞ Scommessa: ${data.teamName} - ${data.bet} punti`);
    });

    socket.on('allin_results_processed', (data) => {
        showToast(`ALL IN: ${data.correctCount}/${data.totalBets} corrette. Lancia domande 2-5 (x2)`, 'success', 5000);
        console.log('‚úÖ Risultati ALL IN elaborati:', data);
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CORREZIONI ADMIN.HTML - Aggiungere questi listener
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ‚úÖ FIX 1: LISTENER PER RISPOSTE (mostra chi ha risposto)
    socket.on('update_answers', (data) => {
        // ‚úÖ FIX: Usa 'answers-list' invece di 'round-answers'
        const answersDiv = document.getElementById('answers-list');
        if (!answersDiv) {
            console.error('‚ùå Elemento answers-list non trovato');
            return;
        }
        
        // Nascondi buzzer-monitor e mostra answers-list
        document.getElementById('buzzer-monitor').classList.add('hidden');
        answersDiv.classList.remove('hidden');
        
        // Aggiorna contatore
        document.getElementById('answers-count').textContent = `${data.answers ? data.answers.length : 0}/${data.totalTeams}`;
        
        answersDiv.innerHTML = '';
        
        if (data.answers && data.answers.length > 0) {
            data.answers.forEach((ans, idx) => {
                const icon = ans.corretta ? '‚úÖ' : '‚ùå';
                const colorClass = ans.corretta ? 'bg-green-900/50' : 'bg-red-900/50';
                const borderClass = ans.corretta ? 'border-green-500' : 'border-red-500';
                
                const div = document.createElement('div');
                div.className = `${colorClass} p-2 rounded mb-1 border ${borderClass}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-xs">${icon} ${ans.teamName}</span>
                        <span class="text-xs text-gray-400">${ans.time}s</span>
                    </div>
                    <div class="text-xs text-gray-300 mt-1">
                        ${ans.risposta}
                        ${ans.corretta ? ` <span class="text-green-400 font-bold">+${ans.points}pt</span>` : ''}
                    </div>
                `;
                answersDiv.appendChild(div);
            });
            
            // Mostra risposta corretta nel preview
            if (data.correctAnswer) {
                const correctDiv = document.getElementById('correct-answer-preview');
                const correctText = document.getElementById('correct-answer-text');
                correctDiv.classList.remove('hidden');
                correctText.textContent = data.correctAnswer;
            }
        } else {
            answersDiv.innerHTML = '<p class="text-gray-500 text-xs text-center py-4">Nessuna risposta ancora...</p>';
        }
    });

    // Funzione per assegnare punti da buzzer
    function assignBuzzerPoints(teamId, points) {
        socket.emit('assign_points', { teamId: teamId, points: points });
        // Reset buzzer dopo assegnazione
        setTimeout(() => {
            socket.emit('reset_buzzer');
        }, 500);
    }

    // ‚úÖ FIX 3: MOSTRA RISPOSTA CORRETTA PER DUELLO
    socket.on('duello_correct_answer', (data) => {
        const duelloInfo = document.getElementById('duello-info');
        if (!duelloInfo) return;
        
        duelloInfo.innerHTML += `
            <div class="mt-3 p-3 ${data.isCorrect ? 'bg-green-900' : 'bg-red-900'} rounded">
                <p class="font-bold">${data.teamName}: ${data.teamAnswer}</p>
                <p class="text-sm">Risposta corretta: ${data.correctAnswer}</p>
                <p class="text-lg">${data.isCorrect ? '‚úÖ CORRETTO!' : '‚ùå SBAGLIATO!'}</p>
            </div>
        `;
    });

    // Accordion/Collapse Toggle
    function toggleSection(section) {
        const content = document.getElementById(`content-${section}`);
        const icon = document.getElementById(`icon-${section}`);
        
        if(content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.textContent = '‚ñ≤';
        } else {
            content.classList.add('hidden');
            icon.textContent = '‚ñº';
        }
    }

    function regia(v) { socket.emit('regia_cmd', v); }
    function resetDisplays() { if(confirm("Reset?")) socket.emit('reset_displays'); }
    function resetGame() { if(confirm("‚ö†Ô∏è RESET TOTALE?")) socket.emit('reset_game'); }
    
    function mostraSoluzione() {
        if(selectedQ && selectedQ.corretta !== undefined) {
            // Invia la risposta corretta al server
            socket.emit('mostra_soluzione', { 
                soluzione: selectedQ.corretta 
            });
            console.log('üì∫ Soluzione inviata:', selectedQ.corretta);
        } else {
            showToast('Seleziona una domanda prima!', 'error');
        }
    }

    function togglePause() {
        const btn = document.getElementById('pause-btn');
        if(isPaused) {
            socket.emit('resume_game');
            btn.innerHTML = '‚è∏Ô∏è PAUSA';
            btn.className = 'px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg font-bold text-sm';
            isPaused = false;
        } else {
            socket.emit('pause_game');
            btn.innerHTML = '‚ñ∂Ô∏è RIPRENDI';
            btn.className = 'px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-bold text-sm';
            isPaused = true;
        }
    }

    function activateStep(stepNum) {
        for(let i = 1; i <= 7; i++) {
            const step = document.getElementById(`step-${i}`);
            if(step) {
                step.className = step.className.replace(' active', '');
                if(i === stepNum) step.className += ' active';
            }
        }
        
        // Gestione speciale per step 6 (div) e step-6-btn (button)
        if(stepNum === 6) {
            const step6Btn = document.getElementById('step-6-btn');
            if(step6Btn) {
                step6Btn.className = step6Btn.className.replace(' active', '');
                step6Btn.className += ' active';
            }
        }
    }

    function refreshPreview() {
        document.getElementById('mobile-preview').src = window.location.origin + '/preview';
    }

    // ‚úÖ Ricevi e mostra la risposta corretta in anticipo
    socket.on('show_correct_answer_preview', (data) => {
        const preview = document.getElementById('correct-answer-preview');
        const text = document.getElementById('correct-answer-text');
        text.textContent = `${data.corretta}`;
        preview.classList.remove('hidden');
        console.log('‚úÖ Risposta corretta:', data.corretta);
    });

    // Nascondi quando cambia domanda
    socket.on('nuova_domanda', () => {
        document.getElementById('correct-answer-preview').classList.add('hidden');
    });

    // Team connect/disconnect notifications
    socket.on('team_joined', (data) => {
        if (!data.isPreview) {
            showToast(`${data.name} si √® unito!`, 'success', 2500);
        }
    });
    socket.on('team_left', (data) => {
        showToast(`${data.name} disconnesso`, 'warning', 2500);
    });

    // ‚úÖ Ricevi dati delle domande all'avvio
    socket.on('questions_data', (data) => {
        dbStructure.categories = data.categories;
        dbStructure.questions = data.questions;
        populateCategories();
        console.log('üìö Categorie caricate:', data.categories);
    });

    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('mobile-preview').src = window.location.origin + '/preview';
        
        // Inizializza audio engine per l'admin
        if (typeof SipontoAudio !== 'undefined') {
            // Attiva al primo click sulla pagina
            document.addEventListener('click', function initAdminAudio() {
                SipontoAudio.init();
                console.log('‚úÖ Audio admin attivato');
            }, { once: true });
        }
    });

    document.addEventListener('keydown', (e) => {
        if(e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') return;
        if(e.code === 'Space') { e.preventDefault(); lanciaQuiz(); }
        if(e.code === 'KeyB') { e.preventDefault(); lanciaBuzzer(); }
        if(e.code === 'KeyP') { e.preventDefault(); togglePause(); }
    });

    // Layout Presets System
    function setLayout(type) {
        const left = document.getElementById('column-left');
        const center = document.getElementById('column-center');
        const right = document.getElementById('column-right');
        
        const layouts = {
            compact: ['15%', '35%', '50%'],   // Focus controlli
            balanced: ['20%', '40%', '40%'],  // Default
            preview: ['15%', '50%', '35%']    // Focus preview/risposte
        };
        
        const [l, c, r] = layouts[type];
        
        // Applica dimensioni con smooth transition
        left.style.width = l;
        center.style.width = c;
        right.style.width = r;
        
        // Aggiorna bottoni attivi
        document.querySelectorAll('[onclick^="setLayout"]').forEach(btn => {
            btn.className = 'px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-bold transition';
        });
        event.target.className = 'px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs font-bold transition';
        
        // Salva preferenza
        localStorage.setItem('preferredLayout', type);
        console.log(`üìê Layout: ${type.toUpperCase()} (${l} / ${c} / ${r})`);
    }
    
    // Carica layout salvato all'avvio
    window.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem('preferredLayout') || 'balanced';
        setTimeout(() => {
            const btn = document.querySelector(`[onclick="setLayout('${saved}')"]`);
            if(btn) btn.click();
        }, 100);
    });

    function updateFinaleProgress() {
        const dots = document.querySelectorAll('#finale-progress .progress-dot');
        dots.forEach((dot, i) => {
            dot.className = i < finaleQuestionCount ? 'progress-dot active' : 'progress-dot';
        });
    }

    // ============================================
    // üíÄ IL PATTO COL DESTINO - FUNZIONI ADMIN
    // ============================================
    
    function pattoShowRegole() {
        socket.emit('admin_mostra_regole_patto');
    }
    
    function pattoAvvia() {
        socket.emit('admin_avvia_patto_destino');
        setGameMode('patto');
    }
    
    function pattoReset() {
        socket.emit('admin_reset_patto');
    }
    
    // Aggiorna contatore utilizzi
    socket.on('patto_update_utilizzi', (data) => {
        document.getElementById('patto-usi').textContent = data.utilizzi;
        
        // Disabilita il pulsante se raggiunti i max utilizzi
        if (data.utilizzi >= data.max) {
            const btn = document.getElementById('patto-avvia-btn');
            btn.disabled = true;
            btn.className = 'w-full bg-gray-600 text-white font-bold py-2 rounded text-sm opacity-50 cursor-not-allowed';
            btn.textContent = 'üö´ MAX UTILIZZI';
        }
    });
    
    // Notifica quando viene ricevuta una scelta
    socket.on('patto_scelta_ricevuta', (data) => {
        const status = document.getElementById('patto-status');
        status.classList.remove('hidden');
        status.className = 'text-xs text-center py-2 bg-green-900/30 rounded font-bold text-green-400';
        status.textContent = `‚úÖ ${data.teamName} ha scelto`;
        
        setTimeout(() => {
            status.classList.add('hidden');
        }, 2000);
    });
    
    // Mostra errori
    socket.on('patto_max_utilizzi_raggiunto', () => {
        showToast('Max utilizzi Patto col Destino raggiunto!', 'warning');
    });
    
    socket.on('patto_squadre_insufficienti', () => {
        showToast('Servono almeno 2 squadre per giocare!', 'warning');
    });
    
    // ============================================
    // FINE FUNZIONI PATTO COL DESTINO
    // ============================================
</script>

</body>
</html>
