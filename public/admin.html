<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>CONTROL CENTER - Siponto</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        .quadrant { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); }
        .btn-primary { transition: all 0.2s; }
        .btn-primary:hover { transform: scale(1.05); }
        .btn-primary:active { transform: scale(0.95); }
        .progress-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; margin: 0 3px; }
        .progress-dot.active { background: #ef4444; box-shadow: 0 0 10px #ef4444; animation: pulse 1s infinite; }
        .progress-dot.inactive { background: #374151; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .step-indicator { opacity: 0.5; pointer-events: none; }
        .step-indicator.active { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <div class="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 p-4 border-b border-gray-700 shadow-xl">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-6">
                <h1 class="font-black text-3xl text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-orange-500 to-red-600 uppercase">Control Center</h1>
                <span id="question-counter" class="text-2xl font-bold text-gray-300">Domanda 0</span>
            </div>
            <div class="flex gap-2">
                <button onclick="togglePause()" id="pause-btn" class="px-6 py-3 bg-orange-600 hover:bg-orange-500 text-white rounded-xl font-bold text-lg btn-primary">‚è∏Ô∏è PAUSA</button>
                <button onclick="resetGame()" class="px-4 py-3 bg-red-900 hover:bg-red-800 text-white rounded-xl font-bold opacity-60 text-sm">Reset Totale</button>
            </div>
        </div>
    </div>

    <!-- QUADRANTI 2x2 -->
    <div class="flex-1 grid grid-cols-2 grid-rows-2 gap-3 p-3 overflow-hidden">
        
        <!-- Q1: LANCIA DOMANDA (Top-Left) -->
        <div class="quadrant rounded-2xl p-4 flex flex-col overflow-hidden">
            <div class="flex justify-between items-center mb-3">
                <h2 class="font-black text-xl uppercase tracking-wide text-blue-400">üéÆ Lancia Domanda</h2>
                <div class="flex gap-2">
                    <button onclick="lanciaQuiz()" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-lg btn-primary">üéØ QUIZ</button>
                    <button onclick="lanciaBuzzer()" class="px-6 py-3 bg-red-600 hover:bg-red-500 rounded-xl font-bold text-lg btn-primary">‚ö° BUZZER</button>
                </div>
            </div>
            
            <div class="space-y-2 mb-3">
                <select id="sel-tipo" class="w-full bg-gray-800 text-white p-3 rounded-xl font-bold border border-gray-700">
                    <option value="">-- TIPO GIOCO --</option>
                    <option value="categoria">üìö CATEGORIE</option>
                    <option value="stima">üî¢ STIMA</option>
                    <option value="anagramma">üî§ ANAGRAMMA</option>
                    <option value="bonus">‚≠ê BONUS</option>
                </select>

                <select id="sel-cat" class="w-full bg-gray-800 text-white p-3 rounded-xl font-bold border border-gray-700" disabled>
                    <option value="">-- SCEGLI CATEGORIA --</option>
                </select>
            </div>

            <div id="questions-container" class="flex-1 bg-gray-900 rounded-xl p-3 overflow-y-auto border border-gray-700">
                <div class="text-sm text-gray-500 text-center py-4">Seleziona tipo e categoria...</div>
            </div>
        </div>

        <!-- Q2: CONTROLLI DISPLAY (Top-Right) -->
        <div class="quadrant rounded-2xl p-4 flex flex-col overflow-hidden">
            <h2 class="font-black text-xl uppercase tracking-wide text-green-400 mb-4">üì∫ Controlli Display</h2>
            
            <div class="space-y-2 overflow-y-auto flex-1">
                <!-- Viste Principali -->
                <div class="bg-gray-900 rounded-xl p-3 border border-gray-700">
                    <div class="text-xs font-bold text-gray-400 mb-2 uppercase">Viste Principali</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="regia('logo')" class="px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold text-sm btn-primary">üì± QR Code</button>
                        <button onclick="regia('gioco')" class="px-4 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-sm btn-primary">üéÆ Gioco</button>
                        <button onclick="regia('classifica_round')" class="px-4 py-3 bg-purple-600 hover:bg-purple-500 rounded-lg font-bold text-sm btn-primary">üèÜ Podio Round</button>
                        <button onclick="regia('classifica_gen')" class="px-4 py-3 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-bold text-sm btn-primary">üìä Classifica Gen</button>
                    </div>
                </div>

                <!-- Schermate Speciali -->
                <div class="bg-gray-900 rounded-xl p-3 border border-gray-700">
                    <div class="text-xs font-bold text-gray-400 mb-2 uppercase">Schermate Speciali</div>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="regia('benvenuto')" class="px-3 py-2 bg-pink-600 hover:bg-pink-500 rounded-lg font-bold text-xs btn-primary">üéâ Benvenuto</button>
                        <button onclick="regia('regole')" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-xs btn-primary">üìã Regole</button>
                        <button onclick="regia('punteggi')" class="px-3 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-bold text-xs btn-primary">üéØ Punteggi</button>
                        <button onclick="regia('prossima')" class="px-3 py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-bold text-xs btn-primary">‚è∞ Prossima</button>
                        <button onclick="regia('logo_forever')" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-bold text-xs btn-primary">üéÆ Logo FY</button>
                        <button onclick="showWinnerButton()" class="px-3 py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-bold text-xs btn-primary">üëë Vincitore</button>
                    </div>
                </div>

                <!-- Azioni -->
                <div class="bg-gray-900 rounded-xl p-3 border border-gray-700">
                    <div class="text-xs font-bold text-gray-400 mb-2 uppercase">Azioni</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="mostraSoluzioneSuDisplay()" class="px-4 py-3 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-bold text-sm btn-primary">üì∫ Mostra Soluzione</button>
                        <button onclick="resetDisplays()" class="px-4 py-3 bg-red-600 hover:bg-red-500 rounded-lg font-bold text-sm btn-primary">üîÑ Reset Display</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Q3: MONITOR GIOCO (Bottom-Left) -->
        <div class="quadrant rounded-2xl p-4 flex flex-col overflow-hidden">
            <h2 class="font-black text-xl uppercase tracking-wide text-orange-400 mb-3">‚ö° Monitor & Controlli</h2>
            
            <div class="flex-1 overflow-y-auto space-y-3">
                <!-- Monitor Risposte Normale -->
                <div id="normal-monitor" class="bg-gray-900 rounded-xl p-3 border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-bold text-gray-400 uppercase">Risposte Live</span>
                        <span id="answers-count" class="text-xs bg-gray-800 px-2 py-1 rounded">0/10</span>
                    </div>
                    <div id="answers-list" class="space-y-1 max-h-32 overflow-y-auto"></div>
                </div>

                <!-- Buzzer Musicale -->
                <div class="bg-purple-900/30 rounded-xl p-3 border border-purple-700">
                    <div class="text-sm font-bold text-purple-300 mb-2 uppercase">üéµ Gioco Musicale</div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button onclick="openBuzzerStandalone()" class="px-3 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-bold text-sm btn-primary">üîì Apri Buzzer</button>
                        <button onclick="resetBuzzer()" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-sm btn-primary">üîÑ Reset</button>
                    </div>
                    <div id="buzzer-queue-admin" class="hidden space-y-1 max-h-24 overflow-y-auto"></div>
                </div>

                <!-- Sfida Finale -->
                <div class="bg-red-900/30 rounded-xl p-3 border border-red-700">
                    <div class="text-sm font-bold text-red-300 mb-2 uppercase">üî• Sfida Finale</div>
                    
                    <div class="space-y-2 text-sm">
                        <!-- Step 1 -->
                        <div class="step-indicator active" id="step-1">
                            <button onclick="showFinaleExplanation()" class="w-full px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-xs btn-primary">
                                1Ô∏è‚É£ Mostra Spiegazione
                            </button>
                        </div>

                        <!-- Step 2 -->
                        <div class="step-indicator" id="step-2">
                            <button onclick="startFinale()" id="start-finale-btn" class="w-full px-3 py-2 bg-red-600 hover:bg-red-500 rounded-lg font-bold text-xs btn-primary">
                                2Ô∏è‚É£ Attiva Modalit√† Finale
                            </button>
                        </div>

                        <!-- Step 3 -->
                        <div class="step-indicator" id="step-3">
                            <button onclick="prepareAllIn()" id="prepare-allin-btn" class="w-full px-3 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg font-bold text-xs btn-primary">
                                3Ô∏è‚É£ Prepara ALL IN
                            </button>
                            <div id="allin-bets-status" class="hidden text-xs text-center mt-1 text-yellow-400"></div>
                        </div>

                        <!-- Step 4 -->
                        <div class="step-indicator" id="step-4">
                            <button onclick="showAllInQuestion()" id="show-allin-btn" class="w-full px-3 py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-bold text-xs btn-primary">
                                4Ô∏è‚É£ Mostra Domanda ALL IN
                            </button>
                        </div>

                        <!-- Step 5 -->
                        <div class="step-indicator" id="step-5">
                            <div class="text-xs text-gray-400 text-center mb-1">
                                5Ô∏è‚É£ Lancia domande 2-5 (punti x2)
                            </div>
                        </div>

                        <!-- Step 6 -->
                        <div class="step-indicator" id="step-6">
                            <button onclick="revealWinner()" id="reveal-winner-btn" class="w-full px-3 py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-bold text-xs btn-primary">
                                6Ô∏è‚É£ RIVELA VINCITORE üëë
                            </button>
                        </div>

                        <!-- Progress -->
                        <div id="finale-progress" class="hidden text-center py-2">
                            <div class="text-xs text-gray-400 mb-1">Domande Finale:</div>
                            <div>
                                <span class="progress-dot inactive"></span>
                                <span class="progress-dot inactive"></span>
                                <span class="progress-dot inactive"></span>
                                <span class="progress-dot inactive"></span>
                                <span class="progress-dot inactive"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Q4: CLASSIFICA + PREVIEW (Bottom-Right) -->
        <div class="quadrant rounded-2xl p-4 flex flex-col overflow-hidden">
            <h2 class="font-black text-xl uppercase tracking-wide text-yellow-400 mb-3">üìä Classifica & Preview</h2>
            
            <div class="flex-1 overflow-y-auto space-y-3">
                <!-- Classifica -->
                <div class="bg-gray-900 rounded-xl p-3 border border-gray-700">
                    <div class="text-sm font-bold text-gray-400 mb-2 uppercase">Top Squadre</div>
                    <div id="leaderboard" class="space-y-2"></div>
                </div>

                <!-- Preview Cellulare -->
                <div class="bg-gray-900 rounded-xl p-3 border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-bold text-gray-400 uppercase">üì± Preview</span>
                        <button onclick="refreshPreview()" class="text-xs bg-gray-800 px-2 py-1 rounded hover:bg-gray-700 btn-primary">üîÑ</button>
                    </div>
                    <div class="bg-black rounded-lg overflow-hidden h-40 border border-gray-700">
                        <iframe id="mobile-preview" src="" class="w-full h-full border-0 pointer-events-none" style="transform: scale(0.35); transform-origin: top left; width: 286%; height: 286%;"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentQuestions = [], selectedQ = null, dbStructure = {};
        let isPaused = false, finaleActive = false, finaleQuestionCount = 0;
        let totalQuestionsAsked = 0;
        let allInPrepared = false, allInBetsReceived = 0, totalTeams = 0;

        socket.on('connect', () => { socket.emit('admin_connect'); });
        
        socket.on('init_data', (d) => { 
            dbStructure = d; 
            totalTeams = d.teams.length;
            updateTeams(d.teams); 
            populateCategories();
        });

        function populateCategories() {
            const sc = document.getElementById('sel-cat');
            sc.innerHTML = '<option value="">-- SCEGLI CATEGORIA --</option>';
            if(dbStructure.categories) {
                dbStructure.categories.forEach(c => {
                    sc.innerHTML += `<option value="${c}">${c.replace(/_/g,' ').toUpperCase()}</option>`;
                });
            }
        }

        // Caricamento domande
        document.getElementById('sel-tipo').addEventListener('change', (e) => {
            const t = e.target.value;
            const sc = document.getElementById('sel-cat');
            if(t === 'categoria') {
                sc.disabled = false;
                populateCategories();
            } else {
                sc.disabled = true;
                if(t) socket.emit('get_questions', {type: t});
            }
        });

        document.getElementById('sel-cat').addEventListener('change', (e) => {
            if(e.target.value) socket.emit('get_questions', {type: 'categoria', key: e.target.value});
        });

        socket.on('receive_questions', (q) => {
            currentQuestions = q;
            showQuestionsList(q);
        });

        function showQuestionsList(questions) {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            
            questions.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-gray-800 rounded-lg mb-2 cursor-pointer hover:bg-gray-700 transition border border-gray-700';
                div.innerHTML = `
                    <div class="font-bold text-xs text-blue-400">Q${i+1}</div>
                    <div class="text-sm mt-1">${item.domanda.substring(0,70)}...</div>
                `;
                div.onclick = () => selectQuestion(i);
                container.appendChild(div);
            });
        }

        function selectQuestion(index) {
            selectedQ = currentQuestions[index];
            document.querySelectorAll('#questions-container > div').forEach((el, i) => {
                el.className = i === index ? 
                    'p-3 bg-blue-600 rounded-lg mb-2 cursor-pointer border-2 border-blue-400' : 
                    'p-3 bg-gray-800 rounded-lg mb-2 cursor-pointer hover:bg-gray-700 transition border border-gray-700';
            });
        }

        function lanciaQuiz() { if(selectedQ) lancia('quiz'); }
        function lanciaBuzzer() { if(selectedQ) lancia('buzzer'); }

        function lancia(m) {
            if(!selectedQ) return alert('‚ùå Seleziona una domanda prima!');
            
            totalQuestionsAsked++;
            document.getElementById('question-counter').textContent = `Domanda ${totalQuestionsAsked}`;
            
            if(finaleActive) {
                finaleQuestionCount++;
                updateFinaleProgress();
                socket.emit('invia_domanda_finale', {...selectedQ, modalita: m});
                
                if(finaleQuestionCount === 1 && allInPrepared) {
                    // ALL IN gi√† preparato, non fare nulla
                } else if(finaleQuestionCount >= 5) {
                    activateStep(6);
                }
            } else {
                socket.emit('invia_domanda', {...selectedQ, modalita: m});
            }
        }

        // Monitor risposte
        socket.on('update_round_monitor', (data) => {
            document.getElementById('answers-count').textContent = `${data.length}/${totalTeams}`;
            const list = document.getElementById('answers-list');
            list.innerHTML = '';
            
            data.forEach((res) => {
                const div = document.createElement('div');
                div.className = `p-2 rounded text-xs ${res.corretta ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`;
                div.innerHTML = `
                    <span class="font-bold">${res.teamName}</span>
                    <span class="ml-2">${res.corretta ? '‚úÖ' : '‚ùå'}</span>
                    <span class="float-right font-bold">${res.corretta ? '+' : ''}${res.punti || 0}</span>
                `;
                list.appendChild(div);
            });
        });

        socket.on('reset_round_monitor', () => {
            document.getElementById('answers-list').innerHTML = '';
            document.getElementById('answers-count').textContent = "0/" + totalTeams;
        });

        // Buzzer
        socket.on('buzzer_queue_full', (d) => {
            const queueDiv = document.getElementById('buzzer-queue-admin');
            queueDiv.classList.remove('hidden');
            queueDiv.innerHTML = '';
            
            if(d.queue && d.queue.length > 0) {
                d.queue.forEach((player, idx) => {
                    queueDiv.innerHTML += `
                        <div class="bg-black/30 rounded p-1 text-xs flex justify-between">
                            <span>${idx+1}. ${player.name}</span>
                            <span class="text-yellow-400">${player.time}s</span>
                        </div>
                    `;
                });
            }
        });

        socket.on('reset_buzzer_admin', () => {
            document.getElementById('buzzer-queue-admin').classList.add('hidden');
        });

        function resetBuzzer() { socket.emit('buzzer_reset'); }
        function openBuzzerStandalone() { socket.emit('open_buzzer_standalone'); }

        // Classifica
        socket.on('update_teams', (t) => {
            totalTeams = t.length;
            updateTeams(t);
        });
        
        function updateTeams(t) {
            t.sort((a,b) => b.score - a.score);
            const lb = document.getElementById('leaderboard');
            lb.innerHTML = '';
            
            t.slice(0, 8).forEach((x, i) => {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const medal = medals[i] || `${i + 1}¬∞`;
                
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-gray-800/50 rounded text-sm';
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${medal}</span>
                        <span class="font-bold">${x.name}</span>
                    </div>
                    <span class="font-black text-yellow-400">${x.score}</span>
                `;
                lb.appendChild(div);
            });
        }

        // Controlli
        function regia(v) { socket.emit('regia_cmd', v); }
        function resetDisplays() { if(confirm("Reset display?")) socket.emit('reset_displays'); }
        function resetGame() { if(confirm("‚ö†Ô∏è RESET TOTALE della sessione?")) socket.emit('reset_game'); }
        function showWinnerButton() { socket.emit('show_winner'); }
        
        function mostraSoluzioneSuDisplay() {
            if(selectedQ && selectedQ.corretta !== undefined) {
                let soluzione = selectedQ.corretta;
                if(typeof selectedQ.corretta === 'number' && selectedQ.risposte) {
                    soluzione = selectedQ.risposte[selectedQ.corretta];
                }
                socket.emit('mostra_soluzione', { soluzione: soluzione, risultati: [] });
            } else {
                alert('‚ùå Seleziona una domanda prima!');
            }
        }

        function togglePause() {
            const btn = document.getElementById('pause-btn');
            if(isPaused) {
                socket.emit('resume_game');
                btn.innerHTML = '‚è∏Ô∏è PAUSA';
                btn.className = 'px-6 py-3 bg-orange-600 hover:bg-orange-500 text-white rounded-xl font-bold text-lg btn-primary';
                isPaused = false;
            } else {
                socket.emit('pause_game');
                btn.innerHTML = '‚ñ∂Ô∏è RIPRENDI';
                btn.className = 'px-6 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold text-lg btn-primary';
                isPaused = true;
            }
        }

        // FINALE - Step by step
        function activateStep(stepNum) {
            for(let i = 1; i <= 6; i++) {
                const step = document.getElementById(`step-${i}`);
                if(step) {
                    step.className = i === stepNum ? 'step-indicator active' : 'step-indicator';
                }
            }
        }

        function showFinaleExplanation() {
            socket.emit('show_finale_explanation');
            setTimeout(() => activateStep(2), 20000); // Dopo 20s attiva step 2
        }

        function startFinale() {
            if(confirm('üî• Iniziare la SFIDA FINALE (5 domande)?')) {
                socket.emit('start_finale');
                finaleActive = true;
                finaleQuestionCount = 0;
                document.getElementById('finale-progress').classList.remove('hidden');
                activateStep(3);
            }
        }

        function prepareAllIn() {
            if(!selectedQ) return alert('‚ùå Seleziona prima la domanda 1 per ALL IN!');
            
            allInPrepared = true;
            allInBetsReceived = 0;
            
            // Invia domanda ma blocca display
            socket.emit('invia_domanda_finale', {...selectedQ, modalita: 'quiz'});
            
            document.getElementById('allin-bets-status').classList.remove('hidden');
            document.getElementById('allin-bets-status').textContent = `üí∞ Scommesse: 0/${totalTeams}`;
            
            activateStep(4);
        }

        function showAllInQuestion() {
            socket.emit('admin_force_show_allin');
            allInPrepared = false;
            activateStep(5);
        }

        socket.on('allin_bet_placed', (data) => {
            allInBetsReceived = data.betsCount;
            document.getElementById('allin-bets-status').textContent = `üí∞ Scommesse: ${data.betsCount}/${data.totalTeams}`;
            
            if(data.betsCount >= data.totalTeams) {
                document.getElementById('allin-bets-status').textContent = `‚úÖ Tutti hanno scommesso!`;
            }
        });

        function revealWinner() {
            socket.emit('reveal_winner');
            finaleActive = false;
            document.getElementById('finale-progress').classList.add('hidden');
            activateStep(1); // Reset
        }

        function updateFinaleProgress() {
            const dots = document.querySelectorAll('#finale-progress .progress-dot');
            dots.forEach((dot, i) => {
                dot.className = i < finaleQuestionCount ? 'progress-dot active' : 'progress-dot inactive';
            });
        }

        // Preview
        function refreshPreview() {
            document.getElementById('mobile-preview').src = window.location.origin + '/preview';
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('mobile-preview').src = window.location.origin + '/preview';
        });
    </script>
</body>
</html>
