<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>REGIA MASTER - Il Quizzone</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-800 p-2 h-screen flex flex-col text-sm">

    <div class="flex justify-between items-center bg-white p-2 rounded mb-2 shadow">
        <h1 class="font-bold text-gray-800 text-lg">üéõÔ∏è REGIA</h1>
        <div id="status" class="font-bold text-red-500 uppercase text-xs">Offline</div>
    </div>

    <div class="grid grid-cols-12 gap-2 flex-1 overflow-hidden">
        
        <div class="col-span-4 flex flex-col gap-2 overflow-y-auto">
            <div class="bg-white p-3 rounded shadow">
                <h2 class="font-bold text-gray-600 mb-2">1. Selezione</h2>
                
                <select id="sel-tipo" class="w-full border-2 border-blue-500 p-2 rounded font-bold mb-2 text-blue-900">
                    <option value="">-- TIPO GIOCO --</option>
                    <option value="categorie">üìÇ CATEGORIE</option>
                    <option value="bonus">üí∞ BONUS</option>
                    <option value="raffica">‚ö° RAFFICA</option>
                </select>

                <select id="sel-cat" class="w-full border p-1 rounded mb-2 bg-gray-50 text-xs" disabled>
                    <option value="">-- Materia --</option>
                </select>

                <select id="sel-dom" class="w-full border p-1 rounded bg-gray-50 text-xs" disabled>
                    <option value="">-- Domanda --</option>
                </select>

                <div id="preview" class="mt-2 p-2 bg-blue-50 border border-blue-100 rounded text-xs text-gray-600 h-20 overflow-y-auto">
                    ...
                </div>

                <div class="mt-2 flex gap-1">
                    <button onclick="lancia('classico')" class="flex-1 bg-blue-600 text-white font-bold py-2 rounded shadow hover:bg-blue-700 text-xs">
                        QUIZ (Opzioni)
                    </button>
                    <button onclick="lancia('buzzer')" class="flex-1 bg-red-600 text-white font-bold py-2 rounded shadow hover:bg-red-700 text-xs">
                        BUZZER (Rosso)
                    </button>
                </div>
            </div>
            
            <div class="bg-white p-3 rounded shadow text-center">
                <button onclick="rivela()" class="w-full bg-green-500 text-white py-2 rounded font-bold shadow animate-pulse hover:bg-green-600">
                    SVELA RISPOSTA
                </button>
            </div>
        </div>

        <div class="col-span-5 bg-gray-900 p-3 rounded shadow flex flex-col border border-gray-700">
            <h2 class="font-bold text-white mb-2 flex justify-between">
                MONITOR ROUND
                <span id="timer-badge" class="bg-gray-700 px-2 rounded text-xs">In attesa...</span>
            </h2>
            
            <div class="flex-1 overflow-y-auto bg-black/50 rounded p-1">
                <table class="w-full text-left text-xs text-gray-300">
                    <thead class="border-b border-gray-700 text-gray-500">
                        <tr>
                            <th class="p-1">Squadra</th>
                            <th class="p-1">Risp</th>
                            <th class="p-1">Sec</th>
                            <th class="p-1 text-right">Punti</th>
                        </tr>
                    </thead>
                    <tbody id="round-table">
                        </tbody>
                </table>
                <div id="round-msg" class="text-center text-gray-500 mt-4 italic">Nessuna risposta ricevuta</div>
            </div>
        </div>

        <div class="col-span-3 bg-white p-3 rounded shadow flex flex-col">
            <h2 class="font-bold text-gray-600 mb-2 border-b">Classifica</h2>
            <div class="flex-1 overflow-y-auto">
                <table class="w-full text-xs">
                    <tbody id="team-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentQuestions = [];
        let selectedQ = null;
        let dbStructure = {};

        socket.on('connect', () => {
            document.getElementById('status').innerText = "ONLINE";
            document.getElementById('status').className = "font-bold text-green-500 uppercase text-xs";
            socket.emit('admin_connect');
        });

        // --- INIT ---
        socket.on('init_data', (data) => {
            dbStructure = data;
            updateTeams(data.teams);
        });

        // --- GESTIONE DOMANDE ---
        socket.on('receive_questions', (questions) => {
            currentQuestions = questions;
            const selDom = document.getElementById('sel-dom');
            selDom.disabled = false;
            selDom.innerHTML = '<option value="">-- Seleziona Domanda --</option>';
            questions.forEach((q, idx) => {
                let text = q.domanda.length > 40 ? q.domanda.substring(0,40) + "..." : q.domanda;
                selDom.innerHTML += `<option value="${idx}">${q.id}. ${text}</option>`;
            });
        });

        // --- MONITOR ROUND (CUORE DEL FIX) ---
        
        socket.on('update_round_monitor', (answers) => {
            const tbody = document.getElementById('round-table');
            const msg = document.getElementById('round-msg');
            msg.style.display = 'none';
            tbody.innerHTML = '';

            answers.forEach(entry => {
                const tr = document.createElement('tr');
                // Colore riga: Verde se corretto, Rosso se sbagliato
                const colorClass = entry.corretta ? 'text-green-400 font-bold' : 'text-red-400';
                const statusIcon = entry.corretta ? '‚úÖ' : '‚ùå';
                
                tr.className = "border-b border-gray-800 hover:bg-white/5";
                tr.innerHTML = `
                    <td class="p-2 text-white">${entry.teamName}</td>
                    <td class="p-2 ${colorClass}">${entry.risposta}</td>
                    <td class="p-2 text-gray-400 font-mono">${entry.tempo}s</td>
                    <td class="p-2 text-right">
                        ${entry.corretta ? 
                            `<button onclick="daiPunti('${entry.teamId}', 100)" class="bg-green-600 text-white px-2 rounded text-[10px] hover:bg-green-500">+100</button>` 
                            : `<span class="text-gray-600">-</span>`
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        });

        socket.on('reset_round_monitor', () => {
            document.getElementById('round-table').innerHTML = '';
            document.getElementById('round-msg').style.display = 'block';
            document.getElementById('round-msg').innerText = "Domanda lanciata. Attendo risposte...";
            document.getElementById('timer-badge').innerText = "GARA APERTA";
            document.getElementById('timer-badge').className = "bg-green-600 text-white px-2 rounded text-xs animate-pulse";
        });

        socket.on('buzzer_admin_alert', (winnerName) => {
            document.getElementById('round-msg').innerHTML = `<span class="text-red-400 font-bold text-lg animate-bounce">üö® HA PRENOTATO: ${winnerName}</span>`;
            document.getElementById('timer-badge').innerText = "BUZZER BLOCCATO";
            document.getElementById('timer-badge').className = "bg-red-600 text-white px-2 rounded text-xs";
        });

        // --- CLASSIFICA ---
        socket.on('update_teams', updateTeams);
        function updateTeams(teams) {
            teams.sort((a,b) => b.score - a.score);
            const list = document.getElementById('team-list');
            list.innerHTML = '';
            document.getElementById('team-cnt').innerText = teams.length;
            teams.forEach(t => {
                list.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-1 font-bold truncate max-w-[80px]">${t.name}</td>
                        <td class="text-right text-blue-600 font-mono font-bold">${t.score}</td>
                    </tr>`;
            });
        }

        // --- MENU LOGIC ---
        document.getElementById('sel-tipo').addEventListener('change', (e) => {
            const type = e.target.value;
            const selCat = document.getElementById('sel-cat');
            selCat.innerHTML = '<option value="">-- Scegli --</option>';
            document.getElementById('sel-dom').innerHTML = '';
            document.getElementById('sel-dom').disabled = true;

            if (type === 'categorie') {
                selCat.disabled = false;
                dbStructure.categories.forEach(c => selCat.innerHTML += `<option value="${c}">${c.toUpperCase()}</option>`);
            } else if (type === 'bonus' || type === 'raffica') {
                selCat.disabled = true;
                socket.emit('get_questions', { type: type });
            }
        });

        document.getElementById('sel-cat').addEventListener('change', (e) => {
            if(e.target.value) socket.emit('get_questions', { type: 'categoria', key: e.target.value });
        });

        document.getElementById('sel-dom').addEventListener('change', (e) => {
            const idx = e.target.value;
            if (idx !== "") {
                selectedQ = currentQuestions[idx];
                let rispHTML = selectedQ.risposte ? selectedQ.risposte.map((r, i) => i === selectedQ.corretta ? `<b class='text-green-600'>${r}</b>` : r).join(', ') : '';
                document.getElementById('preview').innerHTML = `<b>${selectedQ.domanda}</b><br><span class='text-[10px]'>${rispHTML}</span>`;
            }
        });

        // --- COMANDI ---
        function lancia(mode) {
            if(!selectedQ) return alert("Scegli domanda!");
            socket.emit('invia_domanda', { ...selectedQ, modalita: mode });
        }
        function rivela() { socket.emit('rivela_risposta'); }
        function daiPunti(id, pts) { socket.emit('assegna_punti', { teamId: id, punti: pts }); }
    </script>
</body>
</html>
