<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Control Center - Siponto</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack.min.css" rel="stylesheet"/>
    <style>
        body { background: #0a0e1a; color: white; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        .btn-primary { background: #3b82f6; transition: all 0.15s; }
        .btn-primary:hover { background: #2563eb; transform: scale(1.02); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: #f59e0b; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .btn-scene { background: #1f2937; transition: all 0.15s; padding: 8px; border-radius: 6px; cursor: pointer; }
        .btn-scene:hover { background: #374151; transform: scale(1.05); }
        .btn-scene.active { background: #10b981; box-shadow: 0 0 12px #10b981; }
        .progress-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin: 0 2px; background: #374151; }
        .progress-dot.active { background: #ef4444; box-shadow: 0 0 8px #ef4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .step-btn { opacity: 0.4; pointer-events: none; }
        .step-btn.active { opacity: 1; pointer-events: auto; }
        .preview-frame { background: #000; border: 2px solid #374151; border-radius: 12px; }
        .grid-stack-item-content { background: #1f2937; border-radius: 6px; }
        .grid-stack { background: #0a0e1a; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- HEADER MINIMAL -->
    <div class="bg-gradient-to-r from-gray-900 to-gray-800 px-4 py-2 border-b border-gray-700 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <h1 class="font-black text-xl text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-red-600">CONTROL CENTER</h1>
            <span id="question-counter" class="text-lg font-bold text-gray-400">Q: 0</span>
        </div>
        <div class="flex gap-2">
            <button onclick="togglePause()" id="pause-btn" class="px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg font-bold text-sm">‚è∏Ô∏è PAUSA</button>
            <button onclick="resetGame()" class="px-3 py-2 bg-red-900 hover:bg-red-800 rounded-lg font-bold text-xs opacity-60">Reset</button>
        </div>
    </div>

    <!-- GRIDSTACK CONTAINER -->
    <div class="flex-1 p-2 overflow-hidden">
        <div class="grid-stack"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack-all.js"></script>
    <script>
        const socket = io();
        let currentQuestions = [], selectedQ = null, dbStructure = {};
        let isPaused = false, finaleActive = false, finaleQuestionCount = 0;
        let totalQuestionsAsked = 0, allInPrepared = false, totalTeams = 0;

        document.addEventListener('DOMContentLoaded', function() {
            // Inizializza GridStack
            const grid = GridStack.init({
                float: true,
                cellHeight: '70px',
                minRow: 1,
                acceptWidgets: true
            });

            // Aggiungi i riquadri come widget
            grid.addWidget({
                w: 4, h: 10, x: 0, y: 0,
                content: `
                    <div class="p-2 h-full bg-gray-900/50 rounded-lg border border-gray-800">
                        <div class="text-sm font-bold text-blue-400 mb-2">üìö Selezione</div>
                        <select id="sel-tipo" class="w-full bg-gray-800 text-white p-2 rounded text-sm font-bold border border-gray-700 mb-1">
                            <option value="">Tipo</option>
                            <option value="categoria">üìö Categorie</option>
                            <option value="stima">üî¢ Stima</option>
                            <option value="anagramma">üî§ Anagramma</option>
                            <option value="bonus">‚≠ê Bonus</option>
                        </select>
                        <select id="sel-cat" class="w-full bg-gray-800 text-white p-2 rounded text-sm font-bold border border-gray-700 mb-2" disabled>
                            <option value="">Categoria</option>
                        </select>
                        <div class="flex-1 bg-gray-800/50 rounded p-1 border border-gray-700 overflow-hidden mb-2">
                            <div class="text-xs font-bold text-blue-400 mb-1 uppercase">üìã Domande</div>
                            <div id="questions-container" class="overflow-y-auto h-24 text-xs"></div>
                        </div>
                        <button onclick="lanciaQuiz()" class="w-full btn-primary text-white font-bold py-2 rounded-lg mb-1 text-sm">
                            üéØ LANCIA QUIZ
                        </button>
                        <button onclick="lanciaBuzzer()" class="w-full btn-danger text-white font-bold py-2 rounded-lg text-sm">
                            ‚ö° LANCIA BUZZER
                        </button>
                    </div>
                `
            });

            grid.addWidget({
                w: 6, h: 12, x: 4, y: 0,
                content: `
                    <div class="p-2 h-full bg-gray-900/50 rounded-lg border border-gray-800">
                        <div class="text-sm font-bold text-purple-400 mb-2">üì± Preview & Risposte</div>
                        <div class="h-24 bg-gray-800 rounded mb-2 p-1 overflow-hidden">
                            <div class="text-xs font-bold text-purple-400 mb-1">üì± Preview</div>
                            <div class="preview-frame h-16 overflow-hidden">
                                <iframe id="mobile-preview" src="" class="w-full h-full border-0 pointer-events-none" style="transform: scale(0.32); transform-origin: top left; width: 313%; height: 313%;"></iframe>
                            </div>
                        </div>
                        <div class="h-32 bg-gray-800 rounded mb-2 p-1 overflow-hidden">
                            <div class="flex justify-between items-center mb-1">
                                <div class="text-xs font-bold text-green-400 uppercase">‚ö° Risposte</div>
                                <span id="answers-count" class="text-xs bg-gray-700 px-2 py-0.5 rounded font-bold">0/10</span>
                            </div>
                            <div id="answers-list" class="overflow-y-auto h-20 space-y-1 text-xs"></div>
                            <div id="buzzer-monitor" class="hidden overflow-y-auto h-20 space-y-1 text-xs"></div>
                        </div>
                        <div class="flex-1 bg-gray-800 rounded p-1 border border-gray-700 overflow-hidden">
                            <div class="text-xs font-bold text-yellow-400 mb-1 uppercase">üìä Classifica</div>
                            <div id="leaderboard-center" class="grid grid-cols-2 gap-1 text-xs overflow-y-auto max-h-20"></div>
                        </div>
                    </div>
                `
            });

            grid.addWidget({
                w: 5, h: 12, x: 10, y: 0,
                content: `
                    <div class="p-2 h-full bg-gray-900/50 rounded-lg border border-gray-800">
                        <div class="text-sm font-bold text-red-400 mb-2">üéõÔ∏è Mixer</div>
                        <div class="bg-gray-800 rounded p-2 mb-2 border border-gray-700">
                            <div class="text-xs font-bold text-blue-400 mb-1 uppercase">üì∫ Scene</div>
                            <div class="grid grid-cols-4 gap-1 mb-2">
                                <div onclick="regia('logo')" class="btn-scene text-center text-[10px] font-bold py-1">
                                    <div class="text-lg">üì±</div>
                                    <div>QR</div>
                                </div>
                                <div onclick="regia('gioco')" class="btn-scene text-center text-[10px] font-bold py-1">
                                    <div class="text-lg">üéÆ</div>
                                    <div>Game</div>
                                </div>
                                <div onclick="regia('classifica_round')" class="btn-scene text-center text-[10px] font-bold py-1">
                                    <div class="text-lg">üèÜ</div>
                                    <div>Pod</div>
                                </div>
                                <div onclick="regia('classifica_gen')" class="btn-scene text-center text-[10px] font-bold py-1">
                                    <div class="text-lg">üìä</div>
                                    <div>Cls</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-6 gap-1">
                                <div onclick="regia('benvenuto')" class="btn-scene text-center text-[8px] font-bold py-1">
                                    <div>üéâ</div>
                                    <div>Ben</div>
                                </div>
                                <div onclick="regia('regole')" class="btn-scene text-center text-[8px] font-bold py-1">
                                    <div>üìã</div>
                                    <div>Reg</div>
                                </div>
                                <div onclick="regia('punteggi')" class="btn-scene text-center text-[8px] font-bold py-1">
                                    <div>üéØ</div>
                                    <div>Pun</div>
                                </div>
                                <div onclick="regia('prossima')" class="btn-scene text-center text-[8px] font-bold py-1">
                                    <div>‚è∞</div>
                                    <div>Pros</div>
                                </div>
                                <div onclick="regia('logo_forever')" class="btn-scene text-center text-[8px] font-bold py-1">
                                    <div>üéÆ</div>
                                    <div>Logo</div>
                                </div>
                                <div onclick="showWinnerButton()" class="btn-scene text-center text-[8px] font-bold py-1">
                                    <div>üëë</div>
                                    <div>Win</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-800 rounded p-2 mb-2 border border-gray-700">
                            <div class="text-xs font-bold text-green-400 mb-1 uppercase">‚ö° Azioni</div>
                            <div class="grid grid-cols-2 gap-1">
                                <button onclick="mostraSoluzioneSuDisplay()" class="btn-warning text-white font-bold py-1 rounded text-[10px]">
                                    üì∫ Soluzione
                                </button>
                                <button onclick="resetDisplays()" class="btn-danger text-white font-bold py-1 rounded text-[10px]">
                                    üîÑ Reset Disp
                                </button>
                            </div>
                        </div>
                        <div class="bg-purple-900/20 rounded p-2 border border-purple-700">
                            <div class="text-xs font-bold text-purple-300 mb-1 uppercase">üéµ Gioco Musicale</div>
                            <div class="grid grid-cols-3 gap-1 mb-2">
                                <button onclick="openBuzzerStandalone()" class="btn-success text-white font-bold py-1 rounded text-[10px]">
                                    üîì Apri
                                </button>
                                <button onclick="closeBuzzer()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 rounded text-[10px]">
                                    üîí Blocca
                                </button>
                                <button onclick="resetBuzzer()" class="btn-primary text-white font-bold py-1 rounded text-[10px]">
                                    üîÑ Reset
                                </button>
                            </div>
                            <div id="buzzer-queue-admin" class="hidden space-y-1 text-[10px] max-h-16 overflow-y-auto"></div>
                        </div>
                        <div class="bg-red-900/20 rounded p-2 border border-red-700">
                            <div class="text-xs font-bold text-red-300 mb-1 uppercase">üî• Sfida Finale</div>
                            <div class="space-y-1">
                                <button onclick="showFinaleExplanation()" id="step-1" class="step-btn active w-full btn-primary text-white font-bold py-1 rounded text-[10px]">
                                    1Ô∏è‚É£ Spiega Regole
                                </button>
                                <button onclick="startFinale()" id="step-2" class="step-btn w-full btn-danger text-white font-bold py-1 rounded text-[10px]">
                                    2Ô∏è‚É£ Attiva Finale
                                </button>
                                <button onclick="prepareAllIn()" id="step-3" class="step-btn w-full btn-warning text-white font-bold py-1 rounded text-[10px]">
                                    3Ô∏è‚É£ Prepara ALL IN
                                </button>
                                <div id="allin-bets-status" class="hidden text-[10px] text-center text-yellow-400 py-1 font-bold"></div>
                                <button onclick="showAllInQuestion()" id="step-4" class="step-btn w-full btn-warning text-white font-bold py-1 rounded text-[10px]">
                                    4Ô∏è‚É£ Mostra Domanda
                                </button>
                                <div id="step-5" class="step-btn text-[10px] text-gray-400 text-center py-1">
                                    5Ô∏è‚É£ Lancia domande 2-5 (x2)
                                </div>
                                <button onclick="revealWinner()" id="step-6" class="step-btn w-full btn-warning text-white font-bold py-1 rounded text-[10px]">
                                    6Ô∏è‚É£ RIVELA VINCITORE üëë
                                </button>
                                <div id="finale-progress" class="hidden text-center py-1">
                                    <span class="progress-dot"></span>
                                    <span class="progress-dot"></span>
                                    <span class="progress-dot"></span>
                                    <span class="progress-dot"></span>
                                    <span class="progress-dot"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            });

            // Salva la disposizione dei riquadri
            grid.on('change', function(event, items) {
                const layout = grid.save(false);
                localStorage.setItem('gridLayout', JSON.stringify(layout));
            });

            // Carica la disposizione salvata
            const savedLayout = localStorage.getItem('gridLayout');
            if (savedLayout) {
                grid.load(JSON.parse(savedLayout));
            }

            // Inizializza Socket.IO e altre funzioni
            socket.on('connect', () => { socket.emit('admin_connect'); });

            socket.on('init_data', (d) => {
                dbStructure = d;
                totalTeams = d.teams.length;
                updateTeams(d.teams);
                populateCategories();
            });

            function populateCategories() {
                const sc = document.getElementById('sel-cat');
                sc.innerHTML = '<option value="">Categoria</option>';
                if(dbStructure.categories) {
                    dbStructure.categories.forEach(c => {
                        sc.innerHTML += `<option value="${c}">${c.replace(/_/g,' ')}</option>`;
                    });
                }
            }

            document.getElementById('sel-tipo').addEventListener('change', (e) => {
                const t = e.target.value;
                const sc = document.getElementById('sel-cat');
                if(t === 'categoria') {
                    sc.disabled = false;
                } else {
                    sc.disabled = true;
                    if(t) socket.emit('get_questions', {type: t});
                }
            });

            document.getElementById('sel-cat').addEventListener('change', (e) => {
                if(e.target.value) socket.emit('get_questions', {type: 'categoria', key: e.target.value});
            });

            socket.on('receive_questions', (q) => {
                currentQuestions = q;
                showQuestionsList(q);
            });

            function showQuestionsList(questions) {
                const container = document.getElementById('questions-container');
                container.innerHTML = '';
                questions.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'p-2 bg-gray-700 rounded mb-1 cursor-pointer hover:bg-gray-600 border border-gray-600';
                    div.innerHTML = `
                        <div class="font-bold text-blue-400 text-[10px]">Q${i+1}</div>
                        <div class="leading-tight mt-0.5 text-[10px]">${item.domanda.substring(0,50)}...</div>
                    `;
                    div.onclick = () => selectQuestion(i);
                    container.appendChild(div);
                });
            }

            function selectQuestion(index) {
                selectedQ = currentQuestions[index];
                document.querySelectorAll('#questions-container > div').forEach((el, i) => {
                    el.className = i === index ?
                        'p-2 bg-blue-600 rounded mb-1 cursor-pointer border-2 border-blue-400' :
                        'p-2 bg-gray-700 rounded mb-1 cursor-pointer hover:bg-gray-600 border border-gray-600';
                });
            }

            function lanciaQuiz() { if(selectedQ) lancia('quiz'); else alert('‚ùå Seleziona domanda!'); }
            function lanciaBuzzer() { if(selectedQ) lancia('buzzer'); else alert('‚ùå Seleziona domanda!'); }

            function lancia(m) {
                totalQuestionsAsked++;
                document.getElementById('question-counter').textContent = `Q: ${totalQuestionsAsked}`;
                if(finaleActive) {
                    finaleQuestionCount++;
                    updateFinaleProgress();
                    socket.emit('invia_domanda_finale', {...selectedQ, modalita: m});
                    if(finaleQuestionCount >= 5) activateStep(6);
                } else {
                    socket.emit('invia_domanda', {...selectedQ, modalita: m});
                }
            }

            socket.on('update_round_monitor', (data) => {
                document.getElementById('answers-count').textContent = `${data.length}/${totalTeams}`;
                const list = document.getElementById('answers-list');
                list.innerHTML = '';
                data.forEach((res) => {
                    const div = document.createElement('div');
                    div.className = `p-2 rounded ${res.corretta ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`;
                    div.innerHTML = `
                        <span class="font-bold text-[10px]">${res.teamName}</span>
                        <span class="float-right font-bold text-[10px]">${res.corretta ? '+' : ''}${res.punti || 0}</span>
                    `;
                    list.appendChild(div);
                });
            });

            socket.on('reset_round_monitor', () => {
                document.getElementById('answers-list').innerHTML = '';
                document.getElementById('answers-list').classList.remove('hidden');
                document.getElementById('buzzer-monitor').classList.add('hidden');
                document.getElementById('buzzer-monitor').innerHTML = '';
            });

            socket.on('buzzer_queue_full', (d) => {
                const isMusicBuzzer = d.standalone || false;
                if(isMusicBuzzer) {
                    const queueDiv = document.getElementById('buzzer-queue-admin');
                    queueDiv.classList.remove('hidden');
                    queueDiv.innerHTML = '';
                    if(d.queue && d.queue.length > 0) {
                        d.queue.forEach((player, idx) => {
                            const medals = ['ü•á', 'ü•à', 'ü•â'];
                            const div = document.createElement('div');
                            div.className = 'bg-black/30 rounded p-1 mb-1';
                            div.innerHTML = `
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-[10px]">${medals[idx] || (idx+1)+'.'} ${player.name}</span>
                                    <span class="text-yellow-400 text-[10px]">${player.time}s</span>
                                </div>
                                <div class="grid grid-cols-3 gap-1">
                                    <button onclick="assignPoints('${player.id}', 100)" class="bg-green-600 hover:bg-green-500 text-white text-[9px] py-0.5 rounded font-bold">+100</button>
                                    <button onclick="assignPoints('${player.id}', 50)" class="bg-blue-600 hover:bg-blue-500 text-white text-[9px] py-0.5 rounded font-bold">+50</button>
                                    <button onclick="assignPoints('${player.id}', -50)" class="bg-red-600 hover:bg-red-500 text-white text-[9px] py-0.5 rounded font-bold">-50</button>
                                </div>
                            `;
                            queueDiv.appendChild(div);
                        });
                    }
                } else {
                    const monitorDiv = document.getElementById('buzzer-monitor');
                    const answersList = document.getElementById('answers-list');
                    monitorDiv.classList.remove('hidden');
                    answersList.classList.add('hidden');
                    monitorDiv.innerHTML = '';
                    document.getElementById('answers-count').textContent = `${d.queue.length}/10`;
                    if(d.queue && d.queue.length > 0) {
                        d.queue.forEach((player, idx) => {
                            const medals = ['ü•á', 'ü•à', 'ü•â'];
                            const div = document.createElement('div');
                            div.className = 'bg-black/30 rounded p-1 mb-1';
                            div.innerHTML = `
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-[10px]">${medals[idx] || (idx+1)+'.'} ${player.name}</span>
                                    <span class="text-yellow-400 text-[10px]">${player.time}s</span>
                                </div>
                                <div class="grid grid-cols-3 gap-1">
                                    <button onclick="assignPoints('${player.id}', 100)" class="bg-green-600 hover:bg-green-500 text-white text-[9px] py-0.5 rounded font-bold">+100</button>
                                    <button onclick="assignPoints('${player.id}', 50)" class="bg-blue-600 hover:bg-blue-500 text-white text-[9px] py-0.5 rounded font-bold">+50</button>
                                    <button onclick="assignPoints('${player.id}', -50)" class="bg-red-600 hover:bg-red-500 text-white text-[9px] py-0.5 rounded font-bold">-50</button>
                                </div>
                            `;
                            monitorDiv.appendChild(div);
                        });
                    }
                }
            });

            socket.on('reset_buzzer_admin', () => {
                document.getElementById('buzzer-queue-admin').classList.add('hidden');
                document.getElementById('buzzer-queue-admin').innerHTML = '';
            });

            function resetBuzzer() {
                socket.emit('buzzer_reset');
            }

            function openBuzzerStandalone() {
                socket.emit('open_buzzer_standalone');
            }

            function closeBuzzer() {
                socket.emit('buzzer_close');
                document.getElementById('buzzer-queue-admin').classList.add('hidden');
                document.getElementById('buzzer-queue-admin').innerHTML = '';
            }

            function assignPoints(teamId, points) {
                socket.emit('admin_punti_manuali', { id: teamId, punti: points });
                console.log(`Assegnati ${points} punti a ${teamId}`);
            }

            socket.on('update_teams', (t) => {
                totalTeams = t.length;
                updateTeams(t);
            });

            function updateTeams(t) {
                t.sort((a,b) => b.score - a.score);
                const realTeams = t.filter(x => !x.isPreview);
                const lb = document.getElementById('leaderboard-center');
                lb.innerHTML = '';
                realTeams.forEach((x, i) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const medal = medals[i] || `${i+1}¬∞`;
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700/50 rounded px-1 py-0.5 flex items-center justify-between gap-1';
                    div.innerHTML = `
                        <span class="text-[9px] flex-shrink-0">${medal}</span>
                        <span class="font-bold text-[9px] truncate flex-1">${x.name}</span>
                        <span class="font-black text-yellow-400 text-[9px] flex-shrink-0">${x.score}</span>
                        <button onclick="adjustPoints('${x.id}', 50)" class="bg-green-600 hover:bg-green-500 text-white text-[8px] px-1 py-0.5 rounded font-bold flex-shrink-0">+</button>
                        <button onclick="adjustPoints('${x.id}', -50)" class="bg-red-600 hover:bg-red-500 text-white text-[8px] px-1 py-0.5 rounded font-bold flex-shrink-0">-</button>
                    `;
                    lb.appendChild(div);
                });
            }

            function adjustPoints(teamId, points) {
                socket.emit('admin_punti_manuali', { id: teamId, punti: points });
                console.log(`Punti ${points > 0 ? '+' : ''}${points} assegnati a ${teamId}`);
            }

            function regia(v) { socket.emit('regia_cmd', v); }
            function resetDisplays() { if(confirm("Reset?")) socket.emit('reset_displays'); }
            function resetGame() { if(confirm("‚ö†Ô∏è RESET TOTALE?")) socket.emit('reset_game'); }
            function showWinnerButton() { socket.emit('show_winner'); }

            function mostraSoluzioneSuDisplay() {
                if(selectedQ && selectedQ.corretta !== undefined) {
                    let soluzione = selectedQ.corretta;
                    if(typeof selectedQ.corretta === 'number' && selectedQ.risposte) {
                        soluzione = selectedQ.risposte[selectedQ.corretta];
                    }
                    socket.emit('mostra_soluzione', { soluzione: soluzione });
                } else {
                    alert('‚ùå Seleziona domanda!');
                }
            }

            function togglePause() {
                const btn = document.getElementById('pause-btn');
                if(isPaused) {
                    socket.emit('resume_game');
                    btn.innerHTML = '‚è∏Ô∏è PAUSA';
                    btn.className = 'px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg font-bold text-sm';
                    isPaused = false;
                } else {
                    socket.emit('pause_game');
                    btn.innerHTML = '‚ñ∂Ô∏è RIPRENDI';
                    btn.className = 'px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-bold text-sm';
                    isPaused = true;
                }
            }

            function activateStep(stepNum) {
                for(let i = 1; i <= 6; i++) {
                    const step = document.getElementById(`step-${i}`);
                    if(step) {
                        step.className = step.className.replace(' active', '');
                        if(i === stepNum) step.className += ' active';
                    }
                }
            }

            function showFinaleExplanation() {
                socket.emit('show_finale_explanation');
                setTimeout(() => activateStep(2), 20000);
            }

            function startFinale() {
                if(confirm('üî• Iniziare FINALE?')) {
                    socket.emit('start_finale');
                    finaleActive = true;
                    finaleQuestionCount = 0;
                    document.getElementById('finale-progress').classList.remove('hidden');
                    activateStep(3);
                }
            }

            function prepareAllIn() {
                if(!selectedQ) return alert('‚ùå Seleziona domanda 1!');
                allInPrepared = true;
                socket.emit('invia_domanda_finale', {...selectedQ, modalita: 'quiz'});
                document.getElementById('allin-bets-status').classList.remove('hidden');
                document.getElementById('allin-bets-status').textContent = `üí∞ 0/${totalTeams}`;
                activateStep(4);
            }

            function showAllInQuestion() {
                socket.emit('admin_force_show_allin');
                allInPrepared = false;
                activateStep(5);
            }

            socket.on('allin_bet_placed', (data) => {
                document.getElementById('allin-bets-status').textContent = `üí∞ ${data.betsCount}/${data.totalTeams}`;
                if(data.betsCount >= data.totalTeams) {
                    document.getElementById('allin-bets-status').textContent = `‚úÖ Tutti!`;
                }
            });

            function revealWinner() {
                socket.emit('reveal_winner');
                finaleActive = false;
                document.getElementById('finale-progress').classList.add('hidden');
                activateStep(1);
            }

            function updateFinaleProgress() {
                const dots = document.querySelectorAll('#finale-progress .progress-dot');
                dots.forEach((dot, i) => {
                    dot.className = i < finaleQuestionCount ? 'progress-dot active' : 'progress-dot';
                });
            }

            function refreshPreview() {
                document.getElementById('mobile-preview').src = window.location.origin + '/preview';
            }

            window.addEventListener('DOMContentLoaded', () => {
                document.getElementById('mobile-preview').src = window.location.origin + '/preview';
            });

            document.addEventListener('keydown', (e) => {
                if(e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') return;
                if(e.code === 'Space') { e.preventDefault(); lanciaQuiz(); }
                if(e.code === 'KeyB') { e.preventDefault(); lanciaBuzzer(); }
                if(e.code === 'KeyP') { e.preventDefault(); togglePause(); }
            });
        });
    </script>
</body>
</html>
