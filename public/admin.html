<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Il Quizzone - Game Show Multiplayer</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(147, 51, 234, 0.5); }
      50% { box-shadow: 0 0 40px rgba(147, 51, 234, 0.8); }
    }
    .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    .shake { animation: shake 0.5s ease-in-out; }

    @keyframes buzzer-flash {
      0%, 100% { background-color: rgb(239 68 68); }
      50% { background-color: rgb(220 38 38); }
    }
    .buzzer-active { animation: buzzer-flash 0.5s ease-in-out infinite; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Utility per emoji categorie
    const getCategoryEmoji = (cat) => {
      const emojis = {
        'cultura_generale': 'üìö',
        'storia': 'üìú',
        'sport': '‚öΩ',
        'gossip': 'üí¨',
        'cinema': 'üé¨',
        'musica': 'üéµ',
        'geografia': 'üåç'
      };
      return emojis[cat] || '‚ùì';
    };

    const getModeEmoji = (mode) => {
      const emojis = {
        'classico': 'üìù',
        'raffica': '‚ö°',
        'buzzer': 'üîî',
        'bonus': 'üí∞'
      };
      return emojis[mode] || 'üéÆ';
    };

    // ============ COMPONENTE ADMIN ============
    function AdminPanel() {
      const [socket, setSocket] = useState(null);
      const [teams, setTeams] = useState({});
      const [scores, setScores] = useState({});
      const [domande, setDomande] = useState(null);
      const [currentMode, setCurrentMode] = useState(null);
      const [currentQuestion, setCurrentQuestion] = useState(null);
      const [answers, setAnswers] = useState([]);
      const [showResults, setShowResults] = useState(false);
      const [results, setResults] = useState([]);
      const [selectedCategory, setSelectedCategory] = useState('cultura_generale');
      const [activeTab, setActiveTab] = useState('classico');
      
      // Stati per raffica
      const [rafficaProgress, setRafficaProgress] = useState(null);
      
      // Stati per buzzer
      const [buzzerPressed, setBuzzerPressed] = useState(null);
      const [buzzerAnswer, setBuzzerAnswer] = useState(null);

      useEffect(() => {
        // Carica domande
        fetch('/domande.json')
          .then(res => res.json())
          .then(data => setDomande(data))
          .catch(err => console.error('Errore caricamento domande:', err));

        // Connetti socket
        const newSocket = io();
        newSocket.emit('admin_connect');
        
        newSocket.on('team_joined', (teamsData) => {
          setTeams(teamsData);
        });

        newSocket.on('team_left', ({ teamId }) => {
          setTeams(prev => {
            const updated = { ...prev };
            delete updated[teamId];
            return updated;
          });
        });

        newSocket.on('answer_received', (answerData) => {
          setAnswers(prev => [...prev, answerData]);
        });

        newSocket.on('scores_update', (scoresData) => {
          setScores(scoresData);
        });

        // Buzzer events
        newSocket.on('buzzer_pressed', (data) => {
          setBuzzerPressed(data);
        });

        newSocket.on('buzzer_answer_received', (data) => {
          setBuzzerAnswer(data);
        });

        setSocket(newSocket);

        return () => newSocket.close();
      }, []);

      // ===== MODALIT√Ä CLASSICA =====
      const startClassico = (question) => {
        setCurrentMode('classico');
        setCurrentQuestion(question);
        setAnswers([]);
        setShowResults(false);
        setResults([]);
        socket.emit('start_question', question);
      };

      // ===== MODALIT√Ä RAFFICA =====
      const startRaffica = (raffica) => {
        setCurrentMode('raffica');
        setCurrentQuestion(null);
        setAnswers([]);
        setShowResults(false);
        setRafficaProgress({ current: 0, total: raffica.domande.length });
        socket.emit('start_raffica', raffica);
        
        socket.on('raffica_results', (data) => {
          setResults(data.results);
          setScores(data.scores);
          setShowResults(true);
          setRafficaProgress(null);
          setCurrentMode(null);
        });
      };

      const nextRafficaQuestion = () => {
        setAnswers([]);
        socket.emit('next_raffica_question');
        setRafficaProgress(prev => ({ ...prev, current: prev.current + 1 }));
      };

      // ===== MODALIT√Ä BUZZER =====
      const startBuzzer = (question) => {
        setCurrentMode('buzzer');
        setCurrentQuestion(question);
        setAnswers([]);
        setShowResults(false);
        setBuzzerPressed(null);
        setBuzzerAnswer(null);
        socket.emit('start_buzzer', question);
      };

      const revealBuzzer = (isCorrect) => {
        socket.emit('buzzer_reveal', {
          teamId: buzzerPressed.teamId,
          isCorrect
        });
        
        socket.once('buzzer_results', (data) => {
          setResults([data]);
          setScores(data.scores);
          setShowResults(true);
        });
      };

      // ===== MODALIT√Ä BONUS =====
      const startBonus = (question) => {
        setCurrentMode('bonus');
        setCurrentQuestion(question);
        setAnswers([]);
        setShowResults(false);
        setResults([]);
        socket.emit('start_bonus', question);
      };

      // ===== RIVELA RISPOSTA (classico e bonus) =====
      const revealAnswer = () => {
        socket.emit('reveal_answer', currentQuestion.corretta);
        setShowResults(true);
        
        socket.once('question_results', (data) => {
          setResults(data.results);
          setScores(data.scores);
        });
      };

      const resetGame = () => {
        if (confirm('Vuoi resettare il gioco? Tutti i punteggi verranno azzerati.')) {
          socket.emit('reset_game');
          setTeams({});
          setScores({});
          setCurrentQuestion(null);
          setCurrentMode(null);
          setAnswers([]);
          setShowResults(false);
          setResults([]);
          setRafficaProgress(null);
          setBuzzerPressed(null);
          setBuzzerAnswer(null);
        }
      };

      if (!domande) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-900 to-indigo-900 flex items-center justify-center">
            <div className="text-white text-2xl">Caricamento domande...</div>
          </div>
        );
      }

      const teamsList = Object.values(teams);
      const scoresList = Object.entries(scores)
        .map(([teamId, score]) => ({
          teamId,
          name: teams[teamId]?.name || 'Unknown',
          score
        }))
        .sort((a, b) => b.score - a.score);

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-900 to-indigo-900 p-4">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="bg-white rounded-lg shadow-2xl p-4 mb-4">
              <div className="flex justify-between items-center mb-3">
                <h1 className="text-3xl font-bold text-purple-900">üéÆ Pannello Admin - Il Quizzone</h1>
                <button 
                  onClick={resetGame}
                  className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition"
                >
                  Reset Gioco
                </button>
              </div>
              
              <div className="grid grid-cols-4 gap-3">
                <div className="bg-blue-100 p-3 rounded">
                  <div className="text-xs text-blue-600">Squadre Connesse</div>
                  <div className="text-2xl font-bold text-blue-900">{teamsList.length}</div>
                </div>
                <div className="bg-green-100 p-3 rounded">
                  <div className="text-xs text-green-600">Modalit√†</div>
                  <div className="text-2xl font-bold text-green-900">
                    {currentMode ? getModeEmoji(currentMode) : '-'}
                  </div>
                </div>
                <div className="bg-purple-100 p-3 rounded">
                  <div className="text-xs text-purple-600">Risposte</div>
                  <div className="text-2xl font-bold text-purple-900">{answers.length}</div>
                </div>
                <div className="bg-yellow-100 p-3 rounded">
                  <div className="text-xs text-yellow-600">In Gioco</div>
                  <div className="text-2xl font-bold text-yellow-900">
                    {currentMode ? 'üî¥ LIVE' : '‚ö™ Off'}
                  </div>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-12 gap-4">
              {/* Colonna Sinistra: Selezione Modalit√† e Domande */}
              <div className="col-span-3 space-y-4">
                {/* Tabs Modalit√† */}
                <div className="bg-white rounded-lg shadow-xl p-4">
                  <h2 className="text-xl font-bold mb-3 text-gray-800">üéØ Modalit√†</h2>
                  <div className="space-y-2">
                    {['classico', 'raffica', 'buzzer', 'bonus'].map(mode => (
                      <button
                        key={mode}
                        onClick={() => setActiveTab(mode)}
                        className={`w-full p-3 rounded font-semibold transition ${
                          activeTab === mode
                            ? 'bg-purple-600 text-white'
                            : 'bg-gray-100 text-gray-700 hover:bg-purple-100'
                        }`}
                      >
                        {getModeEmoji(mode)} {mode.charAt(0).toUpperCase() + mode.slice(1)}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Lista Domande/Sfide */}
                <div className="bg-white rounded-lg shadow-xl p-4 max-h-[600px] overflow-y-auto">
                  {activeTab === 'classico' && (
                    <>
                      <h3 className="font-bold mb-3">üìù Quiz Classico</h3>
                      <select 
                        value={selectedCategory}
                        onChange={(e) => setSelectedCategory(e.target.value)}
                        className="w-full p-2 border rounded mb-3"
                      >
                        {Object.keys(domande.categorie).map(cat => (
                          <option key={cat} value={cat}>
                            {getCategoryEmoji(cat)} {cat.replace('_', ' ')}
                          </option>
                        ))}
                      </select>
                      <div className="space-y-2">
                        {domande.categorie[selectedCategory]?.map(q => (
                          <button
                            key={q.id}
                            onClick={() => startClassico(q)}
                            className="w-full text-left p-2 rounded bg-gray-100 hover:bg-purple-100 transition text-sm"
                          >
                            <div className="font-semibold">#{q.id}</div>
                            <div className="text-xs">{q.domanda}</div>
                          </button>
                        ))}
                      </div>
                    </>
                  )}

                  {activeTab === 'raffica' && (
                    <>
                      <h3 className="font-bold mb-3">‚ö° Sfida a Raffica</h3>
                      <div className="space-y-2">
                        {domande.raffica?.map(r => (
                          <button
                            key={r.id}
                            onClick={() => startRaffica(r)}
                            className="w-full text-left p-3 rounded bg-gradient-to-r from-orange-100 to-red-100 hover:from-orange-200 hover:to-red-200 transition"
                          >
                            <div className="font-bold">{r.nome}</div>
                            <div className="text-xs text-gray-600">
                              {r.domande.length} domande ‚Ä¢ {r.puntiBase} pt/domanda
                            </div>
                          </button>
                        ))}
                      </div>
                    </>
                  )}

                  {activeTab === 'buzzer' && (
                    <>
                      <h3 className="font-bold mb-3">üîî Buzzer Game</h3>
                      <select 
                        value={selectedCategory}
                        onChange={(e) => setSelectedCategory(e.target.value)}
                        className="w-full p-2 border rounded mb-3"
                      >
                        {Object.keys(domande.categorie).map(cat => (
                          <option key={cat} value={cat}>
                            {getCategoryEmoji(cat)} {cat.replace('_', ' ')}
                          </option>
                        ))}
                      </select>
                      <div className="space-y-2">
                        {domande.categorie[selectedCategory]?.map(q => (
                          <button
                            key={q.id}
                            onClick={() => startBuzzer(q)}
                            className="w-full text-left p-2 rounded bg-blue-100 hover:bg-blue-200 transition text-sm"
                          >
                            <div className="font-semibold">#{q.id}</div>
                            <div className="text-xs">{q.domanda}</div>
                          </button>
                        ))}
                      </div>
                    </>
                  )}

                  {activeTab === 'bonus' && (
                    <>
                      <h3 className="font-bold mb-3">üí∞ Domande Bonus</h3>
                      <div className="space-y-2">
                        {domande.bonus?.map(q => (
                          <button
                            key={q.id}
                            onClick={() => startBonus(q)}
                            className="w-full text-left p-3 rounded bg-gradient-to-r from-yellow-100 to-amber-100 hover:from-yellow-200 hover:to-amber-200 transition"
                          >
                            <div className="font-bold text-amber-900">{q.domanda}</div>
                            <div className="text-xs text-amber-700">
                              {q.punti} punti ‚Ä¢ {q.timerSecondi}s
                            </div>
                          </button>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              </div>

              {/* Colonna Centrale: Domanda Attiva */}
              <div className="col-span-6 bg-white rounded-lg shadow-xl p-6">
                <h2 className="text-2xl font-bold mb-4 text-gray-800">
                  {currentMode ? `${getModeEmoji(currentMode)} ${currentMode.toUpperCase()}` : '‚ùì Nessuna Domanda Attiva'}
                </h2>

                {!currentMode && (
                  <div className="text-center py-12 text-gray-500">
                    <div className="text-6xl mb-4">üéÆ</div>
                    <div className="text-xl">Seleziona una modalit√† e una domanda per iniziare</div>
                  </div>
                )}

                {/* CLASSICO/BONUS */}
                {(currentMode === 'classico' || currentMode === 'bonus') && currentQuestion && (
                  <div>
                    <div className={`p-4 rounded mb-4 ${
                      currentMode === 'bonus' ? 'bg-gradient-to-r from-yellow-50 to-amber-50' : 'bg-purple-50'
                    }`}>
                      <div className="text-sm text-purple-600 mb-2">
                        Domanda #{currentQuestion.id}
                        {currentQuestion.categoria && ` ‚Ä¢ ${getCategoryEmoji(currentQuestion.categoria)} ${currentQuestion.categoria}`}
                        {currentMode === 'bonus' && ` ‚Ä¢ üí∞ ${currentQuestion.punti} PUNTI`}
                      </div>
                      <div className="text-xl font-bold text-purple-900 mb-4">
                        {currentQuestion.domanda}
                      </div>
                      <div className="grid grid-cols-2 gap-2">
                        {currentQuestion.risposte.map((risposta, idx) => (
                          <div 
                            key={idx}
                            className={`p-3 rounded font-semibold ${
                              showResults && idx === currentQuestion.corretta
                                ? 'bg-green-500 text-white'
                                : 'bg-white border-2 border-gray-200'
                            }`}
                          >
                            {String.fromCharCode(65 + idx)}. {risposta}
                          </div>
                        ))}
                      </div>
                    </div>

                    {!showResults && (
                      <button
                        onClick={revealAnswer}
                        className="w-full bg-green-600 text-white py-3 rounded font-bold hover:bg-green-700 transition text-lg"
                      >
                        Rivela Risposta Corretta
                      </button>
                    )}

                    <div className="mt-4">
                      <h3 className="font-bold mb-2">Risposte Ricevute ({answers.length}):</h3>
                      <div className="space-y-2 max-h-48 overflow-y-auto">
                        {answers.map((ans, idx) => (
                          <div key={idx} className="bg-gray-100 p-2 rounded text-sm flex justify-between">
                            <span><strong>{ans.teamName}</strong>: Risposta {String.fromCharCode(65 + ans.answer)}</span>
                            <span className="text-gray-600">{ans.timeElapsed}s</span>
                          </div>
                        ))}
                      </div>
                    </div>

                    {showResults && results.length > 0 && (
                      <div className="mt-4">
                        <h3 className="font-bold mb-2 text-green-700">üìä Risultati:</h3>
                        <div className="space-y-2">
                          {results.map((res, idx) => (
                            <div 
                              key={idx}
                              className={`p-3 rounded ${
                                res.isCorrect ? 'bg-green-100' : 'bg-red-100'
                              }`}
                            >
                              <div className="flex justify-between items-center">
                                <div>
                                  <strong>{res.teamName}</strong>
                                  <div className="text-sm">
                                    Risposta {String.fromCharCode(65 + res.answer)} in {res.timeElapsed}s
                                  </div>
                                </div>
                                <div className={`font-bold text-xl ${
                                  res.isCorrect ? 'text-green-700' : 'text-red-700'
                                }`}>
                                  {res.isCorrect ? `+${res.points}` : '0'} pt
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* RAFFICA */}
                {currentMode === 'raffica' && (
                  <div>
                    {rafficaProgress && (
                      <div className="mb-4">
                        <div className="flex justify-between mb-2">
                          <span className="font-bold">Domanda {rafficaProgress.current + 1} di {rafficaProgress.total}</span>
                          <span className="text-purple-600">‚ö° Raffica in corso</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-3">
                          <div 
                            className="bg-gradient-to-r from-orange-500 to-red-500 h-3 rounded-full transition-all"
                            style={{ width: `${((rafficaProgress.current + 1) / rafficaProgress.total) * 100}%` }}
                          />
                        </div>
                      </div>
                    )}

                    {!showResults && rafficaProgress && rafficaProgress.current < rafficaProgress.total && (
                      <div className="mt-4">
                        <h3 className="font-bold mb-2">Risposte ({answers.length}/{teamsList.length}):</h3>
                        <div className="space-y-2 max-h-32 overflow-y-auto mb-4">
                          {answers.map((ans, idx) => (
                            <div key={idx} className={`p-2 rounded text-sm ${
                              ans.isCorrect ? 'bg-green-100' : 'bg-red-100'
                            }`}>
                              <strong>{ans.teamName}</strong>: {ans.isCorrect ? '‚úì' : '‚úó'} {ans.timeElapsed}s
                            </div>
                          ))}
                        </div>
                        <button
                          onClick={nextRafficaQuestion}
                          className="w-full bg-orange-600 text-white py-3 rounded font-bold hover:bg-orange-700 transition"
                        >
                          Prossima Domanda ‚Üí
                        </button>
                      </div>
                    )}

                    {showResults && (
                      <div>
                        <h3 className="font-bold mb-3 text-orange-700 text-xl">üèÅ Raffica Completata!</h3>
                        <div className="space-y-2">
                          {results.map((res, idx) => (
                            <div key={idx} className="bg-gradient-to-r from-orange-100 to-red-100 p-4 rounded">
                              <div className="flex justify-between items-center">
                                <div>
                                  <div className="font-bold text-lg">{res.teamName}</div>
                                  <div className="text-sm">
                                    {res.correctCount}/5 corrette ‚Ä¢ Tempo medio: {res.avgTime}s
                                  </div>
                                </div>
                                <div className="text-2xl font-bold text-orange-700">
                                  +{res.points} pt
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* BUZZER */}
                {currentMode === 'buzzer' && currentQuestion && (
                  <div>
                    <div className="bg-blue-50 p-4 rounded mb-4">
                      <div className="text-sm text-blue-600 mb-2">
                        üîî Buzzer Game ‚Ä¢ #{currentQuestion.id}
                      </div>
                      <div className="text-xl font-bold text-blue-900 mb-4">
                        {currentQuestion.domanda}
                      </div>
                    </div>

                    {!buzzerPressed && (
                      <div className="text-center py-8">
                        <div className="text-6xl mb-4 buzzer-active inline-block px-8 py-4 rounded-full">
                          üîî
                        </div>
                        <div className="text-xl font-bold text-gray-700">
                          In attesa che qualcuno schiacci il buzzer...
                        </div>
                      </div>
                    )}

                    {buzzerPressed && !buzzerAnswer && (
                      <div className="bg-yellow-100 border-2 border-yellow-500 p-6 rounded-lg text-center">
                        <div className="text-3xl font-bold text-yellow-900 mb-2">
                          üîî {buzzerPressed.teamName}
                        </div>
                        <div className="text-sm text-yellow-700">
                          Ha premuto per primo/a in {(buzzerPressed.time / 1000).toFixed(2)}s
                        </div>
                        <div className="text-gray-600 mt-2">In attesa della risposta...</div>
                      </div>
                    )}

                    {buzzerAnswer && (
                      <div>
                        <div className="bg-blue-100 p-4 rounded mb-4">
                          <div className="font-bold mb-2">Risposta data:</div>
                          <div className="text-lg">
                            {String.fromCharCode(65 + buzzerAnswer.answer)}. {currentQuestion.risposte[buzzerAnswer.answer]}
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <button
                            onClick={() => revealBuzzer(true)}
                            className="bg-green-600 text-white py-4 rounded font-bold hover:bg-green-700 text-lg"
                          >
                            ‚úì CORRETTA
                          </button>
                          <button
                            onClick={() => revealBuzzer(false)}
                            className="bg-red-600 text-white py-4 rounded font-bold hover:bg-red-700 text-lg"
                          >
                            ‚úó SBAGLIATA
                          </button>
                        </div>

                        <div className="mt-4 p-3 bg-gray-100 rounded text-sm">
                          <strong>Risposta corretta:</strong> {String.fromCharCode(65 + currentQuestion.corretta)}. {currentQuestion.risposte[currentQuestion.corretta]}
                        </div>
                      </div>
                    )}

                    {showResults && results.length > 0 && (
                      <div className="mt-4 p-4 rounded bg-blue-100">
                        <h3 className="font-bold mb-2">Risultato:</h3>
                        <div className={`p-3 rounded ${
                          results[0].isCorrect ? 'bg-green-200' : 'bg-red-200'
                        }`}>
                          <div className="flex justify-between items-center">
                            <span className="font-bold">{results[0].teamName}</span>
                            <span className="text-xl font-bold">
                              {results[0].isCorrect ? `+${results[0].points} pt` : '0 pt'}
                            </span>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Colonna Destra: Squadre e Classifica */}
              <div className="col-span-3 space-y-4">
                <div className="bg-white rounded-lg shadow-xl p-4">
                  <h2 className="text-xl font-bold mb-3 text-gray-800">üë• Squadre ({teamsList.length})</h2>
                  {teamsList.length > 0 ? (
                    <div className="space-y-2 max-h-64 overflow-y-auto">
                      {teamsList.map((team) => (
                        <div key={team.id} className="bg-gradient-to-r from-blue-50 to-purple-50 p-3 rounded">
                          <div className="font-semibold">{team.name}</div>
                          <div className="text-xs text-gray-600">
                            {scores[team.id] || 0} punti
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-gray-500 text-center py-6 text-sm">
                      Nessuna squadra connessa
                    </div>
                  )}
                </div>

                <div className="bg-white rounded-lg shadow-xl p-4">
                  <h2 className="text-xl font-bold mb-3 text-gray-800">üèÜ Classifica</h2>
                  {scoresList.length > 0 ? (
                    <div className="space-y-2">
                      {scoresList.map((team, idx) => (
                        <div 
                          key={team.teamId}
                          className={`p-3 rounded flex justify-between items-center ${
                            idx === 0 ? 'bg-gradient-to-r from-yellow-200 to-amber-200' :
                            idx === 1 ? 'bg-gradient-to-r from-gray-200 to-gray-300' :
                            idx === 2 ? 'bg-gradient-to-r from-orange-200 to-orange-300' :
                            'bg-gray-100'
                          }`}
                        >
                          <div className="flex items-center gap-3">
                            <div className="text-2xl">
                              {idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `${idx + 1}.`}
                            </div>
                            <div>
                              <div className="font-semibold">{team.name}</div>
                            </div>
                          </div>
                          <div className="text-2xl font-bold text-purple-900">
                            {team.score}
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-gray-500 text-center py-6 text-sm">
                      Nessun punteggio ancora
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ============ COMPONENTE GIOCATORE ============
    function PlayerPanel() {
      const [socket, setSocket] = useState(null);
      const [teamName, setTeamName] = useState('');
      const [isRegistered, setIsRegistered] = useState(false);
      const [teamId, setTeamId] = useState('');
      const [currentMode, setCurrentMode] = useState(null);
      const [currentQuestion, setCurrentQuestion] = useState(null);
      const [selectedAnswer, setSelectedAnswer] = useState(null);
      const [hasAnswered, setHasAnswered] = useState(false);
      const [showResults, setShowResults] = useState(false);
      const [results, setResults] = useState(null);
      const [scores, setScores] = useState({});
      const [timeLeft, setTimeLeft] = useState(null);
      
      // Raffica
      const [rafficaProgress, setRafficaProgress] = useState(null);
      const [rafficaAnswers, setRafficaAnswers] = useState([]);
      
      // Buzzer
      const [buzzerLocked, setBuzzerLocked] = useState(false);
      const [buzzerWinner, setBuzzerWinner] = useState(null);
      const [canAnswerBuzzer, setCanAnswerBuzzer] = useState(false);

      useEffect(() => {
        const newSocket = io();
        
        newSocket.on('registration_success', (data) => {
          setTeamId(data.teamId);
          setIsRegistered(true);
        });

        // CLASSICO/BONUS
        newSocket.on('new_question', (question) => {
          setCurrentMode('classico');
          setCurrentQuestion(question);
          setSelectedAnswer(null);
          setHasAnswered(false);
          setShowResults(false);
          setResults(null);
          setTimeLeft(20);
        });

        newSocket.on('bonus_question', (question) => {
          setCurrentMode('bonus');
          setCurrentQuestion(question);
          setSelectedAnswer(null);
          setHasAnswered(false);
          setShowResults(false);
          setResults(null);
          setTimeLeft(question.timerSecondi);
        });

        // RAFFICA
        newSocket.on('raffica_question', (data) => {
          setCurrentMode('raffica');
          setCurrentQuestion(data);
          setSelectedAnswer(null);
          setHasAnswered(false);
          setShowResults(false);
          setTimeLeft(15);
          setRafficaProgress({ current: data.index, total: data.total });
        });

        newSocket.on('raffica_results', (data) => {
          const myResult = data.results.find(r => r.teamId === teamId);
          setResults(myResult);
          setScores(data.scores);
          setShowResults(true);
          setCurrentMode(null);
          setRafficaProgress(null);
          setRafficaAnswers([]);
        });

        // BUZZER
        newSocket.on('buzzer_question', (question) => {
          setCurrentMode('buzzer');
          setCurrentQuestion(question);
          setSelectedAnswer(null);
          setHasAnswered(false);
          setShowResults(false);
          setBuzzerLocked(false);
          setBuzzerWinner(null);
          setCanAnswerBuzzer(false);
        });

        newSocket.on('buzzer_locked', (data) => {
          setBuzzerLocked(true);
          setBuzzerWinner(data);
          if (data.teamId === teamId) {
            setCanAnswerBuzzer(true);
          }
        });

        newSocket.on('buzzer_results', (data) => {
          setResults(data);
          setScores(data.scores);
          setShowResults(true);
          setTimeout(() => {
            setCurrentMode(null);
            setBuzzerLocked(false);
            setBuzzerWinner(null);
            setCanAnswerBuzzer(false);
          }, 3000);
        });

        // GENERALI
        newSocket.on('answer_submitted', () => {
          setHasAnswered(true);
        });

        newSocket.on('question_results', (data) => {
          setShowResults(true);
          setResults(data);
        });

        newSocket.on('scores_update', (scoresData) => {
          setScores(scoresData);
        });

        newSocket.on('game_reset', () => {
          setIsRegistered(false);
          setTeamName('');
          setTeamId('');
          setCurrentMode(null);
          setCurrentQuestion(null);
          setSelectedAnswer(null);
          setHasAnswered(false);
          setShowResults(false);
          setResults(null);
          setScores({});
          setRafficaProgress(null);
          setBuzzerLocked(false);
          setBuzzerWinner(null);
        });

        setSocket(newSocket);

        return () => newSocket.close();
      }, [teamId]);

      // Timer
      useEffect(() => {
        if (timeLeft === null || timeLeft <= 0 || hasAnswered) return;
        
        const timer = setInterval(() => {
          setTimeLeft(prev => prev - 1);
        }, 1000);

        return () => clearInterval(timer);
      }, [timeLeft, hasAnswered]);

      const registerTeam = (e) => {
        e.preventDefault();
        if (teamName.trim()) {
          socket.emit('register_team', teamName.trim());
        }
      };

      const submitAnswer = (answerIndex) => {
        setSelectedAnswer(answerIndex);
        if (currentMode === 'raffica') {
          socket.emit('raffica_answer', { answer: answerIndex });
          setRafficaAnswers(prev => [...prev, answerIndex]);
        } else if (currentMode === 'buzzer') {
          socket.emit('buzzer_answer', { answer: answerIndex });
        } else {
          socket.emit('submit_answer', { answer: answerIndex });
        }
      };

      const pressBuzzer = () => {
        if (!buzzerLocked) {
          socket.emit('buzzer_press');
        }
      };

      if (!isRegistered) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
            <div className="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
              <h1 className="text-4xl font-bold text-center mb-8 text-purple-900">
                üéÆ Il Quizzone
              </h1>
              <form onSubmit={registerTeam}>
                <label className="block mb-2 text-gray-700 font-semibold">
                  Nome Squadra:
                </label>
                <input
                  type="text"
                  value={teamName}
                  onChange={(e) => setTeamName(e.target.value)}
                  className="w-full px-4 py-3 border-2 border-purple-300 rounded-lg mb-4 text-lg"
                  placeholder="Es: I Fenomeni"
                  autoFocus
                />
                <button
                  type="submit"
                  className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-purple-700 transition"
                >
                  Entra nel Gioco
                </button>
              </form>
            </div>
          </div>
        );
      }

      const myScore = scores[teamId] || 0;
      const scoresList = Object.entries(scores)
        .map(([id, score]) => ({ id, score }))
        .sort((a, b) => b.score - a.score);
      const myPosition = scoresList.findIndex(s => s.id === teamId) + 1;

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 p-4">
          <div className="max-w-2xl mx-auto">
            {/* Header */}
            <div className="bg-white rounded-lg shadow-xl p-4 mb-4">
              <div className="flex justify-between items-center">
                <div>
                  <h2 className="text-2xl font-bold text-purple-900">{teamName}</h2>
                  <div className="text-sm text-gray-600">Posizione: #{myPosition}</div>
                </div>
                <div className="text-right">
                  <div className="text-sm text-gray-600">Punteggio</div>
                  <div className="text-3xl font-bold text-purple-900">{myScore}</div>
                </div>
              </div>
            </div>

            {/* ===== NESSUNA DOMANDA ATTIVA ===== */}
            {!currentMode && !showResults && (
              <div className="bg-white rounded-lg shadow-xl p-12 text-center">
                <div className="text-6xl mb-4">‚è≥</div>
                <div className="text-2xl font-bold text-gray-700">
                  In attesa della prossima sfida...
                </div>
              </div>
            )}

            {/* ===== MODALIT√Ä CLASSICO/BONUS ===== */}
            {(currentMode === 'classico' || currentMode === 'bonus') && currentQuestion && (
              <div className={`rounded-lg shadow-xl p-6 ${
                currentMode === 'bonus' ? 'bg-gradient-to-br from-yellow-100 to-amber-100' : 'bg-white'
              }`}>
                {currentMode === 'bonus' && (
                  <div className="text-center mb-4 p-3 bg-amber-200 rounded-lg">
                    <div className="text-2xl font-bold text-amber-900">
                      üí∞ DOMANDA BONUS üí∞
                    </div>
                    <div className="text-lg text-amber-800">{currentQuestion.punti} PUNTI!</div>
                  </div>
                )}

                {timeLeft !== null && timeLeft > 0 && !hasAnswered && (
                  <div className="mb-4">
                    <div className="flex justify-between items-center mb-2">
                      <span className="font-semibold text-gray-700">Tempo:</span>
                      <span className={`text-3xl font-bold ${
                        timeLeft <= 5 ? 'text-red-600' : 'text-green-600'
                      }`}>
                        {timeLeft}s
                      </span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-3">
                      <div 
                        className={`h-3 rounded-full transition-all ${
                          timeLeft <= 5 ? 'bg-red-600' : 'bg-green-600'
                        }`}
                        style={{ width: `${(timeLeft / (currentMode === 'bonus' ? currentQuestion.timerSecondi : 20)) * 100}%` }}
                      />
                    </div>
                  </div>
                )}

                <div className="mb-6">
                  <div className="text-sm text-purple-600 mb-2">
                    {currentMode === 'bonus' ? 'üí∞ Bonus' : 'üìù Domanda'}
                    {currentQuestion.categoria && ` ‚Ä¢ ${getCategoryEmoji(currentQuestion.categoria)}`}
                  </div>
                  <h3 className="text-2xl font-bold text-gray-800 mb-6">
                    {currentQuestion.domanda}
                  </h3>

                  <div className="grid grid-cols-1 gap-3">
                    {currentQuestion.risposte.map((risposta, idx) => {
                      const isSelected = selectedAnswer === idx;
                      const isCorrect = showResults && results && idx === results.correctAnswer;
                      const isWrong = showResults && results && isSelected && idx !== results.correctAnswer;

                      return (
                        <button
                          key={idx}
                          onClick={() => submitAnswer(idx)}
                          disabled={hasAnswered || (timeLeft !== null && timeLeft <= 0)}
                          className={`w-full p-4 rounded-lg font-semibold text-lg transition-all ${
                            isCorrect ? 'bg-green-500 text-white' :
                            isWrong ? 'bg-red-500 text-white' :
                            isSelected ? 'bg-purple-600 text-white' :
                            hasAnswered ? 'bg-gray-300 text-gray-600 cursor-not-allowed' :
                            'bg-purple-100 text-purple-900 hover:bg-purple-200 active:scale-95'
                          }`}
                        >
                          {String.fromCharCode(65 + idx)}. {risposta}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {hasAnswered && !showResults && (
                  <div className="text-center py-4 bg-blue-100 rounded-lg">
                    <div className="text-xl font-bold text-blue-900">‚úì Risposta inviata!</div>
                    <div className="text-sm text-blue-700">In attesa degli altri...</div>
                  </div>
                )}

                {showResults && results && (
                  <div className="mt-6 p-4 bg-purple-50 rounded-lg">
                    <h4 className="font-bold text-lg mb-3 text-purple-900">üìä Il tuo risultato:</h4>
                    {results.results?.filter(r => r.teamId === teamId).map((myResult, idx) => (
                      <div key={idx} className={`p-4 rounded-lg ${
                        myResult.isCorrect ? 'bg-green-100' : 'bg-red-100'
                      }`}>
                        <div className="text-center">
                          <div className="text-3xl mb-2">
                            {myResult.isCorrect ? '‚úì' : '‚úó'}
                          </div>
                          <div className="font-bold text-xl">
                            {myResult.isCorrect ? 'Risposta Corretta!' : 'Risposta Sbagliata'}
                          </div>
                          <div className="text-sm mt-2">
                            Tempo: {myResult.timeElapsed}s
                          </div>
                          <div className="text-2xl font-bold mt-2">
                            +{myResult.points} punti
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* ===== MODALIT√Ä RAFFICA ===== */}
            {currentMode === 'raffica' && currentQuestion && (
              <div className="bg-gradient-to-br from-orange-100 to-red-100 rounded-lg shadow-xl p-6">
                <div className="mb-4">
                  <div className="flex justify-between mb-2">
                    <span className="font-bold">‚ö° Raffica</span>
                    <span>Domanda {rafficaProgress?.current + 1} / {rafficaProgress?.total}</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-3">
                    <div 
                      className="bg-gradient-to-r from-orange-500 to-red-500 h-3 rounded-full transition-all"
                      style={{ width: `${((rafficaProgress?.current + 1) / rafficaProgress?.total) * 100}%` }}
                    />
                  </div>
                </div>

                {timeLeft !== null && timeLeft > 0 && !hasAnswered && (
                  <div className="mb-4">
                    <div className="flex justify-between items-center mb-2">
                      <span className="font-semibold">Tempo:</span>
                      <span className={`text-2xl font-bold ${
                        timeLeft <= 5 ? 'text-red-600' : 'text-orange-600'
                      }`}>
                        {timeLeft}s
                      </span>
                    </div>
                  </div>
                )}

                <h3 className="text-xl font-bold text-gray-800 mb-4">
                  {currentQuestion.domanda}
                </h3>

                <div className="grid grid-cols-1 gap-3">
                  {currentQuestion.risposte.map((risposta, idx) => {
                    const isSelected = selectedAnswer === idx;

                    return (
                      <button
                        key={idx}
                        onClick={() => submitAnswer(idx)}
                        disabled={hasAnswered}
                        className={`w-full p-4 rounded-lg font-semibold text-lg transition-all ${
                          isSelected ? 'bg-orange-600 text-white' :
                          hasAnswered ? 'bg-gray-300 text-gray-600 cursor-not-allowed' :
                          'bg-white text-orange-900 hover:bg-orange-50 active:scale-95'
                        }`}
                      >
                        {String.fromCharCode(65 + idx)}. {risposta}
                      </button>
                    );
                  })}
                </div>

                {hasAnswered && (
                  <div className="mt-4 text-center py-3 bg-orange-200 rounded-lg">
                    <div className="font-bold text-orange-900">Risposta inviata! ‚ö°</div>
                  </div>
                )}
              </div>
            )}

            {/* ===== MODALIT√Ä BUZZER ===== */}
            {currentMode === 'buzzer' && currentQuestion && (
              <div className="bg-white rounded-lg shadow-xl p-6">
                <div className="text-center mb-6">
                  <div className="text-sm text-blue-600 mb-2">üîî BUZZER GAME</div>
                  <h3 className="text-xl font-bold text-gray-800">
                    {currentQuestion.domanda}
                  </h3>
                </div>

                {!buzzerLocked && !canAnswerBuzzer && (
                  <div className="text-center">
                    <button
                      onClick={pressBuzzer}
                      className="w-48 h-48 mx-auto rounded-full bg-gradient-to-br from-red-500 to-red-700 text-white font-bold text-3xl shadow-2xl hover:scale-105 active:scale-95 transition-transform pulse-glow"
                    >
                      üîî<br/>
                      <span className="text-xl">BUZZER</span>
                    </button>
                    <div className="mt-4 text-gray-600">
                      Premi il buzzer per rispondere per primo!
                    </div>
                  </div>
                )}

                {buzzerLocked && !canAnswerBuzzer && (
                  <div className="text-center py-8">
                    <div className="text-4xl mb-4">üîí</div>
                    <div className="text-xl font-bold text-gray-700">
                      {buzzerWinner?.teamName} ha premuto per primo/a!
                    </div>
                    <div className="text-sm text-gray-600 mt-2">
                      In attesa della risposta...
                    </div>
                  </div>
                )}

                {canAnswerBuzzer && !hasAnswered && (
                  <div>
                    <div className="bg-yellow-100 p-4 rounded-lg mb-4 text-center">
                      <div className="text-2xl font-bold text-yellow-900">
                        üîî Hai premuto per primo/a!
                      </div>
                      <div className="text-sm text-yellow-700">Scegli la tua risposta:</div>
                    </div>

                    <div className="grid grid-cols-1 gap-3">
                      {currentQuestion.risposte.map((risposta, idx) => (
                        <button
                          key={idx}
                          onClick={() => submitAnswer(idx)}
                          className="w-full p-4 rounded-lg font-semibold text-lg bg-blue-100 text-blue-900 hover:bg-blue-200 active:scale-95 transition-all"
                        >
                          {String.fromCharCode(65 + idx)}. {risposta}
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {showResults && results && (
                  <div className="mt-4">
                    <div className={`p-6 rounded-lg text-center ${
                      results.isCorrect ? 'bg-green-100' : 'bg-red-100'
                    }`}>
                      <div className="text-4xl mb-2">
                        {results.isCorrect ? '‚úì' : '‚úó'}
                      </div>
                      <div className="text-xl font-bold">
                        {results.isCorrect ? 'CORRETTO!' : 'SBAGLIATO!'}
                      </div>
                      {results.teamId === teamId && (
                        <div className="text-2xl font-bold mt-2">
                          +{results.points} punti
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* ===== RISULTATI RAFFICA ===== */}
            {showResults && currentMode === null && rafficaProgress === null && results && results.correctCount !== undefined && (
              <div className="bg-gradient-to-br from-orange-100 to-red-100 rounded-lg shadow-xl p-6">
                <h3 className="text-2xl font-bold text-center mb-4 text-orange-900">
                  üèÅ Raffica Completata!
                </h3>
                <div className="bg-white p-6 rounded-lg">
                  <div className="text-center">
                    <div className="text-6xl mb-4">
                      {results.correctCount === 5 ? 'üèÜ' : results.correctCount >= 3 ? '‚≠ê' : 'üëç'}
                    </div>
                    <div className="text-xl font-bold mb-2">
                      {results.correctCount}/5 risposte corrette
                    </div>
                    <div className="text-gray-600 mb-4">
                      Tempo medio: {results.avgTime}s
                    </div>
                    <div className="text-4xl font-bold text-orange-700">
                      +{results.points} punti
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Classifica Mini */}
            {scoresList.length > 0 && (
              <div className="bg-white rounded-lg shadow-xl p-4 mt-4">
                <h3 className="font-bold mb-3">üèÜ Classifica</h3>
                <div className="space-y-2">
                  {scoresList.slice(0, 5).map((team, idx) => (
                    <div 
                      key={team.id}
                      className={`flex justify-between p-2 rounded ${
                        team.id === teamId ? 'bg-purple-100 font-bold' : 'bg-gray-50'
                      }`}
                    >
                      <span>
                        {idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `${idx + 1}.`}
                        {' '}
                        {team.id === teamId ? teamName : `Squadra ${idx + 1}`}
                      </span>
                      <span>{team.score} pt</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // ============ APP PRINCIPALE ============
    function App() {
      const isAdmin = window.location.pathname === "/admin";
      
      return isAdmin ? <AdminPanel /> : <PlayerPanel />;
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
