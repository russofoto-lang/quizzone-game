<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>DISPLAY SHOW - Siponto Forever Young</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        body { background: #0f172a; color: white; overflow: hidden; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        #qrcode img { margin: 0 auto; border: 15px solid white; border-radius: 10px; }
        
        @keyframes countdown-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .countdown-critical { animation: countdown-pulse 0.5s ease-in-out infinite; }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); }
            100% { transform: translateY(100vh) rotate(720deg); }
        }
        .confetti { position: absolute; width: 10px; height: 10px; animation: confetti-fall 3s linear infinite; }
    </style>
</head>
<body class="flex flex-col h-screen p-6">

    <div class="h-[10%] flex justify-between items-center border-b border-gray-700 pb-2">
        <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-red-600">SIPONTO FOREVER YOUNG</h1>
        <div id="mini-leaderboard" class="text-xl font-mono text-blue-400"></div>
    </div>

    <div class="h-[90%] relative flex items-center justify-center">

        <!-- VISTA LOGO QR -->
        <div id="view-logo" class="view-section absolute inset-0 flex flex-col items-center justify-center">
            <div class="glass p-10 rounded-[3rem] shadow-2xl text-center animate__animated animate__fadeInDown">
                <h2 class="text-3xl font-bold mb-6 text-white uppercase tracking-tighter">Inquadra per partecipare</h2>
                <div id="qrcode" class="shadow-2xl"></div>
                <p class="mt-6 text-2xl font-black text-yellow-500">quizzone-game.onrender.com</p>
            </div>
            <div class="mt-10 text-gray-500 animate-pulse text-xl uppercase tracking-widest">Attesa inizio sessione...</div>
        </div>

        <!-- VISTA GIOCO -->
        <div id="view-gioco" class="view-section hidden absolute inset-0 flex flex-col items-center justify-center">
            <div id="buzzer-overlay" class="hidden absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center">
                <p class="text-6xl text-red-500 font-black mb-8 animate__animated animate__bounceIn">‚ö° PRENOTAZIONI BUZZER ‚ö°</p>
                
                <div class="bg-red-900/50 rounded-3xl p-8 max-w-4xl w-full">
                    <div id="buzzer-queue-display" class="space-y-4"></div>
                </div>
            </div>

            <div class="bg-gray-800/80 w-full max-w-6xl p-12 rounded-[3rem] border-t-8 border-blue-500 shadow-2xl text-center glass">
                
                <!-- TIMER DISPLAY -->
                <div id="timer-display-container" class="hidden mb-8">
                    <div class="flex justify-center items-center gap-6 mb-4">
                        <span class="text-2xl text-white font-semibold">Tempo rimasto:</span>
                        <span id="timer-display-text" class="text-7xl font-black" style="color: #10b981;">20</span>
                        <span class="text-3xl text-white">secondi</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                        <div id="timer-display-bar" class="h-4 rounded-full transition-all duration-1000" style="background-color: #10b981; width: 100%;"></div>
                    </div>
                </div>

                <h2 id="cat" class="text-2xl font-bold text-blue-400 mb-6 uppercase tracking-[0.3em]">CATEGORIA</h2>
                <div id="q-text" class="text-6xl font-black leading-tight mb-10 text-white">Caricamento domanda...</div>
                
                <div id="opts" class="grid grid-cols-2 gap-6 text-3xl hidden"></div>

                <div id="solution" class="hidden mt-8 border-t border-gray-600 pt-8 animate__animated animate__fadeInUp">
                    <div class="inline-block bg-green-600 text-white px-12 py-5 rounded-full text-5xl font-black shadow-2xl uppercase italic">
                        ‚úÖ <span id="sol-text">RISPOSTA</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA CLASSIFICA ROUND -->
        <div id="view-classifica_round" class="view-section hidden absolute inset-0 bg-indigo-950 z-40 flex flex-col items-center pt-10">
            <h2 class="text-5xl font-black text-white mb-8 bg-indigo-600 px-12 py-3 rounded-full shadow-2xl italic">‚ö° RISULTATI ROUND ‚ö°</h2>
            <div class="w-full max-w-5xl h-[70vh] overflow-y-auto glass rounded-3xl p-6">
                <table class="w-full text-left text-2xl border-collapse">
                    <thead class="text-indigo-300 border-b-2 border-indigo-800">
                        <tr>
                            <th class="p-4">POS</th>
                            <th class="p-4">SQUADRA</th>
                            <th class="p-4">RISPOSTA</th>
                            <th class="p-4 text-right">TEMPO</th>
                            <th class="p-4 text-right">PUNTI</th>
                        </tr>
                    </thead>
                    <tbody id="round-list-body"></tbody>
                </table>
            </div>
        </div>

        <!-- VISTA CLASSIFICA GENERALE -->
        <div id="view-classifica_gen" class="view-section hidden absolute inset-0 bg-slate-900 z-40 flex flex-col items-center pt-10">
            <h2 class="text-6xl font-black text-yellow-500 mb-10 uppercase tracking-tighter">üèÜ Classifica Generale üèÜ</h2>
            <div class="w-full max-w-4xl h-[70vh] overflow-y-auto glass rounded-[3rem] p-8">
                <table class="w-full text-left text-3xl"><tbody id="full-leaderboard-body"></tbody></table>
            </div>
        </div>

        <!-- VISTA BENVENUTO -->
        <div id="view-benvenuto" class="view-section hidden absolute inset-0 bg-gradient-to-br from-purple-900 via-pink-800 to-red-900 z-40 flex flex-col items-center justify-center">
            <div class="text-center animate__animated animate__fadeInDown">
                <div class="text-9xl mb-8">üéâ</div>
                <h1 class="text-8xl font-black text-white mb-6 tracking-tight">BENVENUTI!</h1>
                <p class="text-5xl text-white/90 mb-4">Siponto Forever Young</p>
                <p class="text-4xl text-yellow-300">Preparati a giocare!</p>
            </div>
        </div>

        <!-- VISTA REGOLE -->
        <div id="view-regole" class="view-section hidden absolute inset-0 bg-gradient-to-br from-blue-900 to-indigo-900 z-40 flex flex-col items-center justify-center">
            <div class="glass rounded-[3rem] p-12 max-w-5xl animate__animated animate__zoomIn">
                <h1 class="text-7xl font-black text-white mb-8 text-center">üìã REGOLAMENTO</h1>
                <div class="text-3xl text-white space-y-6">
                    <div class="flex items-start gap-4">
                        <span class="text-5xl">‚úÖ</span>
                        <div>
                            <p class="font-bold text-yellow-300">Quiz ABCD</p>
                            <p class="text-2xl">Rispondi veloce per bonus punti!</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-4">
                        <span class="text-5xl">‚ö°</span>
                        <div>
                            <p class="font-bold text-yellow-300">Buzzer</p>
                            <p class="text-2xl">Primo che preme risponde!</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-4">
                        <span class="text-5xl">üéØ</span>
                        <div>
                            <p class="font-bold text-yellow-300">Bonus Velocit√†</p>
                            <p class="text-2xl">Pi√π veloce = Pi√π punti!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA PUNTEGGI -->
        <div id="view-punteggi" class="view-section hidden absolute inset-0 bg-gradient-to-br from-green-900 to-emerald-900 z-40 flex flex-col items-center justify-center">
            <div class="glass rounded-[3rem] p-12 max-w-5xl animate__animated animate__flipInX">
                <h1 class="text-7xl font-black text-white mb-8 text-center">üí∞ SISTEMA PUNTEGGI</h1>
                <div class="text-3xl text-white space-y-4">
                    <div class="bg-white/10 rounded-2xl p-6 flex justify-between items-center">
                        <span>Risposta in 2s:</span>
                        <span class="text-5xl font-black text-green-400">145 pt üî•</span>
                    </div>
                    <div class="bg-white/10 rounded-2xl p-6 flex justify-between items-center">
                        <span>Risposta in 10s:</span>
                        <span class="text-5xl font-black text-yellow-400">125 pt ‚ö°</span>
                    </div>
                    <div class="bg-white/10 rounded-2xl p-6 flex justify-between items-center">
                        <span>Risposta in 20s:</span>
                        <span class="text-5xl font-black text-white">100 pt ‚úì</span>
                    </div>
                    <div class="bg-white/10 rounded-2xl p-6 flex justify-between items-center">
                        <span>Buzzer corretto:</span>
                        <span class="text-5xl font-black text-blue-400">100 pt</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA PAUSA -->
        <div id="view-pausa" class="view-section hidden absolute inset-0 bg-gradient-to-br from-orange-900 to-amber-900 z-40 flex flex-col items-center justify-center">
            <div class="text-center animate__animated animate__bounceIn">
                <div class="text-9xl mb-8">‚òï</div>
                <h1 class="text-8xl font-black text-white mb-12">PAUSA</h1>
                
                <div class="glass rounded-[3rem] p-8 max-w-4xl">
                    <h2 class="text-4xl font-bold text-yellow-300 mb-6">üìä CLASSIFICA ATTUALE:</h2>
                    <div id="pause-leaderboard" class="space-y-3 text-3xl text-left">
                        <!-- Popolato via JS -->
                    </div>
                </div>
                
                <p class="text-5xl text-yellow-300 mt-12 animate-pulse">‚è∞ Riprenderemo tra pochissimo</p>
            </div>
        </div>

        <!-- VISTA PROSSIMA DOMANDA -->
        <div id="view-prossima" class="view-section hidden absolute inset-0 bg-gradient-to-br from-yellow-900 to-orange-900 z-40 flex flex-col items-center justify-center">
            <div class="text-center animate__animated animate__pulse">
                <div class="text-9xl mb-8">‚è∞</div>
                <h1 class="text-8xl font-black text-white">PROSSIMA DOMANDA</h1>
            </div>
        </div>

        <!-- VISTA LOGO FOREVER YOUNG -->
        <div id="view-logo_forever" class="view-section hidden absolute inset-0 bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 z-40 flex flex-col items-center justify-center">
            <div class="text-center animate__animated animate__zoomIn">
                <div class="text-9xl mb-8">üéÆ</div>
                <h1 class="text-9xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-pink-500 to-purple-600 mb-4">
                    FOREVER YOUNG
                </h1>
                <h2 class="text-7xl font-bold text-white">SIPONTO</h2>
            </div>
        </div>

        <!-- VISTA CUSTOM -->
        <div id="view-custom" class="view-section hidden absolute inset-0 bg-gradient-to-br from-gray-900 to-slate-900 z-40 flex flex-col items-center justify-center">
            <div class="glass rounded-[3rem] p-16 max-w-5xl text-center animate__animated animate__fadeIn">
                <div class="text-9xl mb-8">üí¨</div>
                <p id="custom-text-display" class="text-6xl font-bold text-white leading-tight whitespace-pre-wrap">
                    Messaggio personalizzato
                </p>
            </div>
        </div>

        <!-- VISTA VINCITORE -->
        <div id="view-winner" class="view-section hidden absolute inset-0 bg-gradient-to-br from-yellow-400 via-pink-500 to-purple-600 z-50 flex flex-col items-center justify-center overflow-hidden">
            
            <!-- Confetti animati -->
            <div id="confetti-container" class="absolute inset-0 overflow-hidden"></div>
            
            <div class="relative z-10 text-center animate__animated animate__bounceIn">
                <!-- Corona animata -->
                <div class="text-9xl mb-8 animate__animated animate__tada animate__infinite animate__slower">
                    üëë
                </div>
                
                <h1 class="text-8xl font-black text-white mb-6 drop-shadow-2xl">
                    üèÜ VINCITORE! üèÜ
                </h1>
                
                <div class="bg-white/20 backdrop-blur-sm rounded-[3rem] p-12 mb-10 border-8 border-yellow-300 shadow-2xl">
                    <div class="text-9xl font-black text-white mb-6" id="winner-name">
                        NOME SQUADRA
                    </div>
                    <div class="text-7xl font-bold text-yellow-300">
                        <span id="winner-score">0</span> PUNTI
                    </div>
                </div>
                
                <div class="text-5xl text-white/90 font-bold animate__animated animate__pulse animate__infinite">
                    üéä COMPLIMENTI! üéä
                </div>
            </div>
        </div>

    </div>

    <script>
        const socket = io();
        let timerInterval = null;
        let questionStartTime = 0;
        let maxTime = 20;
        
        function showView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const viewId = 'view-' + id;
            const el = document.getElementById(viewId);
            if(el) {
                el.classList.remove('hidden');
                console.log('Mostro vista:', viewId);
                
                // Se √® la vista del vincitore, genera i confetti
                if(viewId === 'view-winner') {
                    generateConfetti();
                }
            } else {
                console.error('Vista non trovata:', viewId);
            }
        }

        // Funzione per generare confetti
        function generateConfetti() {
            const confettiContainer = document.getElementById('confetti-container');
            confettiContainer.innerHTML = '';
            const colors = ['#FFD700', '#FF69B4', '#9370DB', '#00FF00', '#00BFFF', '#FF4500', '#FF1493'];
            
            for(let i = 0; i < 150; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = Math.random() * 20 + 5 + 'px';
                confetti.style.height = Math.random() * 20 + 5 + 'px';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                confetti.style.animationDelay = Math.random() * 5 + 's';
                confettiContainer.appendChild(confetti);
            }
        }

        socket.on('connect', () => { 
            console.log("Display Connesso!"); 
            showView('logo');
        });

        // GESTIONE COMANDI REGIA
        socket.on('cambia_vista', (data) => {
            console.log('Ricevuto comando regia:', data.view);
            stopTimer();
            
            // Se √® la vista del vincitore, mostra i dati del vincitore
            if(data.view === 'winner' && data.data) {
                document.getElementById('winner-name').textContent = data.data.winnerName || "Nessun vincitore";
                document.getElementById('winner-score').textContent = data.data.winnerScore || 0;
            }
            
            showView(data.view);
            
            // Genera QR code
            if(data.view === 'logo') {
                const qrDiv = document.getElementById("qrcode");
                qrDiv.innerHTML = "";
                try {
                    new QRCode(qrDiv, {
                        text: window.location.origin || "https://quizzone-game.onrender.com",
                        width: 320,
                        height: 320,
                        colorDark : "#000000",
                        colorLight : "#ffffff"
                    });
                } catch(e) {
                    console.error('Errore QR:', e);
                }
            }
            
            // Classifica round
            if(data.view === 'classifica_round' && data.data) {
                renderRoundList(data.data);
            }
            
            // Schermata custom
            if(data.view === 'custom' && data.data) {
                console.log('üì∫ Ricevuto testo custom:', data.data.text);
                document.getElementById('custom-text-display').textContent = data.data.text || 'Nessun messaggio';
            }
        });

        // PAUSA GIOCO
        socket.on('game_paused', (data) => {
            console.log('Ricevuto comando pausa');
            showView('pausa');
            const leaderboard = document.getElementById('pause-leaderboard');
            leaderboard.innerHTML = '';
            
            if(data.teams && data.teams.length > 0) {
                data.teams.slice(0, 5).forEach((team, idx) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const medal = medals[idx] || `${idx + 1}¬∞`;
                    leaderboard.innerHTML += `
                        <div class="flex justify-between items-center bg-white/10 rounded-xl p-4">
                            <span><span class="text-4xl mr-3">${medal}</span> <span class="font-bold">${team.name}</span></span>
                            <span class="font-black text-yellow-400">${team.score} pt</span>
                        </div>
                    `;
                });
            } else {
                leaderboard.innerHTML = '<p class="text-white/60">Nessuna squadra registrata</p>';
            }
        });

        socket.on('game_resumed', () => {
            console.log('Gioco ripreso');
            showView('logo');
        });

        function renderRoundList(data) {
            const tbody = document.getElementById('round-list-body'); 
            tbody.innerHTML = '';
            
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-gray-500 text-4xl">Nessuna risposta</td></tr>';
                return;
            }

            const sorted = [...data].sort((a, b) => (b.punti || 0) - (a.punti || 0));

            sorted.forEach((entry, i) => {
                const isCorrect = entry.corretta;
                const rowClass = isCorrect ? 'bg-green-500/20 text-green-400' : 'text-white opacity-80';
                const punti = entry.punti || 0;
                tbody.innerHTML += `
                    <tr class="border-b border-white/5 ${rowClass} animate__animated animate__fadeInLeft" style="animation-delay: ${i*0.1}s">
                        <td class="p-6 font-mono text-3xl text-indigo-400">${i+1}</td>
                        <td class="p-6 font-black">${entry.teamName}</td>
                        <td class="p-6 italic">${entry.risposta}</td>
                        <td class="p-6 text-right font-mono">${entry.tempo}s</td>
                        <td class="p-6 text-right font-black text-2xl ${isCorrect ? 'text-green-400' : 'text-red-400'}">
                            ${isCorrect ? '+' + punti : punti}
                        </td>
                    </tr>`;
            });
        }

        // NUOVA DOMANDA
        socket.on('nuova_domanda', (d) => {
            console.log('Nuova domanda:', d.modalita);
            showView('gioco');
            stopTimer();
            
            document.getElementById('buzzer-overlay').classList.add('hidden');
            document.getElementById('solution').classList.add('hidden');
            document.getElementById('cat').innerText = (d.categoria || "PROVA").toUpperCase();
            document.getElementById('q-text').innerText = d.domanda;
            
            const o = document.getElementById('opts'); 
            o.innerHTML = '';
            
            if(d.risposte && d.modalita !== 'buzzer' && d.modalita !== 'stima' && d.modalita !== 'anagramma') { 
                o.classList.remove('hidden'); 
                d.risposte.forEach((r, idx) => {
                    o.innerHTML += `<div class="bg-white/10 p-6 rounded-2xl border-2 border-white/10 shadow-lg text-4xl font-bold">${String.fromCharCode(65+idx)}: ${r}</div>`;
                });
                
                questionStartTime = d.startTime || Date.now();
                maxTime = 20;
                startTimer();
            } else {
                o.classList.add('hidden');
                document.getElementById('timer-display-container').classList.add('hidden');
            }
        });

        // TIMER
        function startTimer() {
            stopTimer();
            document.getElementById('timer-display-container').classList.remove('hidden');
            
            const timerText = document.getElementById('timer-display-text');
            const timerBar = document.getElementById('timer-display-bar');
            
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = '#10b981';
            timerText.style.color = '#10b981';
            timerText.classList.remove('countdown-critical');
            
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - questionStartTime) / 1000;
                const remaining = Math.max(0, maxTime - elapsed);
                
                timerText.textContent = Math.ceil(remaining);
                timerBar.style.width = `${(remaining / maxTime) * 100}%`;
                
                if(remaining <= 5) {
                    timerBar.style.backgroundColor = '#ef4444';
                    timerText.style.color = '#ef4444';
                    timerText.classList.add('countdown-critical');
                } else if(remaining <= 10) {
                    timerBar.style.backgroundColor = '#f59e0b';
                    timerText.style.color = '#f59e0b';
                    timerText.classList.remove('countdown-critical');
                } else {
                    timerBar.style.backgroundColor = '#10b981';
                    timerText.style.color = '#10b981';
                    timerText.classList.remove('countdown-critical');
                }
                
                if(remaining <= 0) {
                    stopTimer();
                    timerText.textContent = '0';
                }
            }, 100);
        }

        function stopTimer() {
            if(timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // BUZZER
        socket.on('buzzer_queue_update', (d) => {
            const queueDiv = document.getElementById('buzzer-queue-display');
            if(!queueDiv) return;
            
            document.getElementById('buzzer-overlay').classList.remove('hidden');
            queueDiv.innerHTML = '';
            
            if(d.queue && d.queue.length > 0) {
                d.queue.forEach((player, idx) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const medal = medals[idx] || `${idx + 1}¬∞`;
                    
                    queueDiv.innerHTML += `
                        <div class="bg-white/10 rounded-2xl p-6 flex justify-between items-center animate__animated animate__fadeInLeft" style="animation-delay: ${idx * 0.1}s">
                            <div class="flex items-center gap-6">
                                <span class="text-6xl">${medal}</span>
                                <span class="text-5xl font-black text-white uppercase">${player.name}</span>
                            </div>
                            <span class="text-4xl text-yellow-400 font-mono">${player.time}s</span>
                        </div>
                    `;
                });
            }
        });

        socket.on('reset_buzzer_display', () => { 
            document.getElementById('buzzer-overlay').classList.add('hidden'); 
        });

        // SOLUZIONE
        socket.on('mostra_soluzione', (d) => {
            stopTimer();
            showView('gioco');
            document.getElementById('solution').classList.remove('hidden');
            document.getElementById('sol-text').innerText = d.soluzione;
            document.getElementById('buzzer-overlay').classList.add('hidden');
            document.getElementById('timer-display-container').classList.add('hidden');
        });

        // CLASSIFICA
        socket.on('update_teams', (t) => {
            t.sort((a,b) => b.score - a.score);
            
            const fb = document.getElementById('full-leaderboard-body'); 
            fb.innerHTML = '';
            t.forEach((x,i) => {
                const medal = i === 0 ? 'ü•á' : (i === 1 ? 'ü•à' : (i === 2 ? 'ü•â' : i+1));
                fb.innerHTML += `
                <tr class="border-b border-white/10 animate__animated animate__fadeInUp">
                    <td class="p-6 font-black text-4xl text-gray-400 w-24">${medal}</td>
                    <td class="p-6 text-4xl font-bold uppercase">${x.name}</td>
                    <td class="p-6 text-right text-5xl font-black text-yellow-500">${x.score}</td>
                </tr>`;
            });
            
            const mini = document.getElementById('mini-leaderboard');
            mini.innerText = t.slice(0,3).map(x => `${x.name}: ${x.score}`).join(' | ');
        });

        socket.on('force_reload', () => window.location.reload());
    </script>
</body>
</html>
