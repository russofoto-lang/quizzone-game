<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pulsantiera</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden">

    <div id="login-screen" class="flex-1 flex flex-col items-center justify-center p-6">
        <h1 class="text-3xl font-black mb-6 text-yellow-500">IL QUIZZONE</h1>
        <input type="text" id="team-name" placeholder="Nome Squadra" class="w-full p-4 rounded-xl text-black text-xl mb-4 text-center font-bold uppercase">
        <button onclick="login()" class="w-full bg-blue-600 py-4 rounded-xl font-bold text-xl shadow-lg active:scale-95">ENTRA</button>
    </div>

    <div id="game-screen" class="hidden flex-col h-full">
        <div class="bg-gray-800 p-4 flex justify-between items-center shadow">
            <span id="my-name" class="font-bold text-yellow-400">SQUADRA</span>
            <span class="text-xs text-gray-400">In attesa...</span>
        </div>

        <div class="flex-1 flex flex-col p-4 justify-center items-center relative">
            <div id="msg-box" class="absolute top-4 text-center w-full text-gray-400 animate-pulse text-lg font-bold">Attendi la domanda...</div>

            <button id="btn-buzzer" onclick="prenota()" class="hidden w-64 h-64 rounded-full bg-gray-600 border-8 border-gray-700 shadow-2xl flex items-center justify-center active:scale-95 transition-all">
                <span class="text-4xl font-black pointer-events-none">PREMI</span>
            </button>

            <div id="opts-grid" class="hidden grid grid-cols-2 gap-4 w-full h-full max-h-[500px] mt-10"></div>

            <div id="input-area" class="hidden w-full flex flex-col gap-4">
                <div class="text-center text-xl font-bold mb-2 text-blue-300" id="input-label">Inserisci la risposta:</div>
                <input type="text" id="txt-answer" class="w-full p-4 rounded-xl text-black text-center text-2xl font-bold uppercase" placeholder="...">
                <button onclick="sendText()" class="w-full bg-green-600 py-4 rounded-xl font-bold text-xl shadow-lg active:bg-green-700">INVIA</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let myId = null;
        let buzzerLocked = true;

        function login() {
            const name = document.getElementById('team-name').value;
            if(name) socket.emit('login', name);
        }
        socket.on('login_success', (data) => {
            myId = data.id;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('flex');
            document.getElementById('my-name').innerText = data.name;
        });

        // GESTIONE CAMBIO MODALITÃ€
        socket.on('nuova_domanda', (d) => {
            resetUI();
            document.getElementById('msg-box').innerText = d.domanda;

            // BUZZER
            if(d.modalita === 'buzzer') {
                const btn = document.getElementById('btn-buzzer');
                btn.classList.remove('hidden');
            } 
            // STIMA / ANAGRAMMA
            else if(d.modalita === 'stima' || d.modalita === 'anagramma') {
                document.getElementById('input-area').classList.remove('hidden');
                document.getElementById('txt-answer').value = '';
                document.getElementById('txt-answer').type = d.modalita==='stima' ? 'number' : 'text';
                document.getElementById('input-label').innerText = d.modalita==='stima' ? 'SCRIVI IL NUMERO:' : 'SCRIVI LA PAROLA:';
            }
            // CLASSICO (Se ci sono risposte array)
            else if(d.risposte) {
                const grid = document.getElementById('opts-grid');
                grid.classList.remove('hidden');
                d.risposte.forEach(r => {
                    const btn = document.createElement('button');
                    btn.className = "bg-blue-600 rounded-xl p-4 font-bold text-lg shadow active:bg-blue-800 break-words leading-tight";
                    btn.innerText = r;
                    btn.onclick = () => {
                        socket.emit('invia_risposta', r);
                        disableAll();
                    };
                    grid.appendChild(btn);
                });
            }
        });

        socket.on('stato_buzzer', (d) => {
            buzzerLocked = d.locked;
            const btn = document.getElementById('btn-buzzer');
            if(!btn.classList.contains('hidden')) {
                if(buzzerLocked) btn.className = "w-64 h-64 rounded-full bg-gray-600 border-8 border-gray-700 shadow-xl flex items-center justify-center opacity-50 cursor-not-allowed";
                else btn.className = "w-64 h-64 rounded-full bg-red-600 border-8 border-red-800 shadow-[0_0_30px_rgba(220,38,38,0.6)] flex items-center justify-center active:scale-95 cursor-pointer animate-pulse";
            }
        });

        function prenota() { if(!buzzerLocked) socket.emit('prenoto'); }
        
        socket.on('prenotazione_vinta', () => {
            const btn = document.getElementById('btn-buzzer');
            btn.className = "w-64 h-64 rounded-full bg-green-500 border-8 border-green-700 shadow-2xl flex items-center justify-center animate-bounce";
            btn.innerHTML = "<span class='text-2xl font-black text-black'>PARLA!</span>";
            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
        });

        function sendText() {
            const val = document.getElementById('txt-answer').value;
            if(val) {
                socket.emit('invia_risposta', val);
                disableAll();
            }
        }

        function disableAll() {
            document.getElementById('opts-grid').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('input-area').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('msg-box').innerText = "Risposta Inviata!";
        }

        function resetUI() {
            document.getElementById('btn-buzzer').classList.add('hidden');
            document.getElementById('opts-grid').classList.add('hidden');
            document.getElementById('input-area').classList.add('hidden');
            
            document.getElementById('opts-grid').innerHTML = '';
            document.getElementById('opts-grid').classList.remove('opacity-50', 'pointer-events-none');
            document.getElementById('input-area').classList.remove('opacity-50', 'pointer-events-none');
            document.getElementById('btn-buzzer').innerHTML = "<span class='text-4xl font-black pointer-events-none'>PREMI</span>";
        }
        
        socket.on('force_reload', () => window.location.reload());
    </script>
</body>
</html>
