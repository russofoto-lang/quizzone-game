<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Il Quizzone - Giocatore</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body { background-color: #1a1a2e; color: white; touch-action: manipulation; }
    .btn-push { transition: transform 0.1s; }
    .btn-push:active { transform: scale(0.95); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // *** FONDAMENTALE: Definizioni React ***
    const { useState, useEffect } = React;
    const socket = io(); // Connessione globale

    function PlayerPanel() {
      const [teamName, setTeamName] = useState('');
      const [isRegistered, setIsRegistered] = useState(false);
      const [msg, setMsg] = useState("Inserisci il nome della tua squadra");
      
      // Stato del gioco
      const [currentQuestion, setCurrentQuestion] = useState(null);
      const [buzzerLocked, setBuzzerLocked] = useState(false);
      const [canAnswerBuzzer, setCanAnswerBuzzer] = useState(false);
      const [winnerName, setWinnerName] = useState(null);
      const [textAnswer, setTextAnswer] = useState("");

      useEffect(() => {
        // Ascolto eventi dal server
        
        socket.on('login_success', (data) => {
          setIsRegistered(true);
          setMsg("Registrato! Attendi la domanda...");
        });

        socket.on('nuova_domanda', (domanda) => {
          setCurrentQuestion(domanda);
          setBuzzerLocked(false);
          setCanAnswerBuzzer(false);
          setWinnerName(null);
          setTextAnswer("");
          setMsg("");
        });

        socket.on('buzzer_bloccato', (data) => {
          setBuzzerLocked(true);
          setWinnerName(data.winner);
        });

        socket.on('prenotazione_vinta', () => {
          setCanAnswerBuzzer(true);
          setMsg("SCRIVI LA RISPOSTA!");
        });

        socket.on('fine_round', () => {
          setCurrentQuestion(null);
          setMsg("Guarda il risultato sullo schermo");
        });

        return () => {
          socket.off(); // Cleanup
        };
      }, []);

      const handleRegister = () => {
        if (teamName.trim()) {
          socket.emit('login', teamName);
        }
      };

      const handleBuzzer = () => {
        if (!buzzerLocked) {
          socket.emit('prenoto');
        }
      };

      const sendAnswer = (val) => {
        socket.emit('invia_risposta', val);
        setMsg("Risposta inviata!");
        setCurrentQuestion(null); // Nascondi interfaccia gioco
        setCanAnswerBuzzer(false);
      };

      // --- RENDER: LOGIN ---
      if (!isRegistered) {
        return (
          <div className="flex flex-col items-center justify-center h-screen p-4 text-center">
            <h1 className="text-4xl font-bold text-yellow-400 mb-8">IL QUIZZONE</h1>
            <input 
              type="text" 
              className="p-4 rounded text-black text-xl w-full max-w-xs mb-4"
              placeholder="Nome Squadra"
              value={teamName}
              onChange={e => setTeamName(e.target.value)}
            />
            <button 
              onClick={handleRegister}
              className="bg-green-500 text-white font-bold py-3 px-8 rounded-full text-xl w-full max-w-xs btn-push"
            >
              ENTRA
            </button>
            <p className="mt-4 text-gray-400">{msg}</p>
          </div>
        );
      }

      // --- RENDER: ATTESA ---
      if (!currentQuestion) {
        return (
          <div className="flex flex-col items-center justify-center h-screen p-4 text-center">
            <div className="text-6xl animate-pulse mb-4">‚è≥</div>
            <h2 className="text-2xl font-bold mb-2">In Attesa...</h2>
            <p className="text-gray-400">{msg}</p>
            <div className="fixed bottom-4 text-sm text-gray-600">Squadra: {teamName}</div>
          </div>
        );
      }

      // --- RENDER: GIOCO ---
      return (
        <div className="flex flex-col h-screen p-4 bg-gray-900">
          <div className="bg-gray-800 p-3 rounded mb-4 text-center">
             <span className="text-yellow-500 text-xs font-bold uppercase tracking-widest">{currentQuestion.categoria || "DOMANDA"}</span>
             <p className="text-lg font-bold mt-1">{currentQuestion.domanda}</p>
          </div>

          {/* MODALITA' BUZZER */}
          {currentQuestion.modalita === 'buzzer' && (
            <div className="flex-grow flex flex-col items-center justify-center">
              
              {/* Pulsantone */}
              {!canAnswerBuzzer && !winnerName && (
                <button 
                  onClick={handleBuzzer}
                  disabled={buzzerLocked}
                  className={`
                    w-64 h-64 rounded-full text-2xl font-bold border-8 shadow-2xl btn-push
                    ${buzzerLocked ? 'bg-gray-600 border-gray-700 text-gray-400' : 'bg-red-600 border-red-800 hover:bg-red-500 text-white animate-pulse'}
                  `}
                >
                  {buzzerLocked ? "BLOCCATO" : "PRENOTA!"}
                </button>
              )}

              {/* Qualcun altro ha vinto */}
              {winnerName && !canAnswerBuzzer && (
                <div className="text-center animate-bounce">
                    <p className="text-red-400 font-bold text-xl">HA PRENOTATO:</p>
                    <p className="text-4xl font-black mt-2">{winnerName}</p>
                </div>
              )}

              {/* Ho vinto io -> Input */}
              {canAnswerBuzzer && (
                <div className="w-full max-w-md">
                   <p className="text-green-400 font-bold text-center mb-2 animate-pulse">TOCCA A TE! SCRIVI!</p>
                   <input 
                      type="text" 
                      autoFocus
                      className="w-full p-4 text-black text-xl rounded mb-4 border-4 border-green-500"
                      placeholder="La tua risposta..."
                      value={textAnswer}
                      onChange={e => setTextAnswer(e.target.value)}
                   />
                   <button 
                      onClick={() => sendAnswer(textAnswer)}
                      className="w-full bg-green-600 py-4 rounded font-bold text-xl shadow-lg btn-push"
                   >
                      INVIA
                   </button>
                </div>
              )}
            </div>
          )}

          {/* MODALITA' CLASSICA (SCELTA MULTIPLA) */}
          {currentQuestion.modalita === 'classico' && (
             <div className="grid grid-cols-1 gap-3 mt-4">
                {currentQuestion.risposte.map((r, idx) => (
                  <button
                    key={idx}
                    onClick={() => sendAnswer(r)}
                    className="bg-blue-600 hover:bg-blue-500 p-5 rounded-xl text-lg font-semibold shadow-md btn-push text-left"
                  >
                    {r}
                  </button>
                ))}
             </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PlayerPanel />);
  </script>
</body>
</html>
