<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Siponto - Gioca</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/audio-engine.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <style>
        /* Animated gradient background */
        body {
            background: linear-gradient(-45deg, #070b14, #0c1629, #111b33, #0a1022);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .font-display { font-family: 'Orbitron', 'Inter', sans-serif; }

        /* Enhanced glass effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(16px) saturate(1.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        /* Animations */
        @keyframes button-success {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: #10b981; }
            100% { transform: scale(1); }
        }

        .btn-feedback-success {
            animation: button-success 0.4s ease-out;
        }

        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }

        .pulse-ring {
            animation: pulse-ring 0.6s ease-out;
        }

        /* Timer */
        .timer-circle-container {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto;
        }

        .timer-circle-bg {
            fill: none;
            stroke: #1e293b;
            stroke-width: 8;
        }

        .timer-circle-progress {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear, stroke 0.3s ease;
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: 900;
        }

        .buzzer-with-timer {
            position: relative;
        }

        .buzzer-timer-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* Answer buttons */
        .answer-btn {
            background: linear-gradient(135deg, rgba(37,99,235,0.9), rgba(79,70,229,0.9));
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: 0 4px 16px rgba(37,99,235,0.3);
            transition: all 0.2s ease;
            color: white;
        }
        .answer-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(37,99,235,0.2);
        }

        /* Buzzer glow */
        @keyframes buzzerGlow {
            0%, 100% { box-shadow: 0 0 40px rgba(239,68,68,0.5), 0 0 80px rgba(239,68,68,0.2); }
            50% { box-shadow: 0 0 60px rgba(239,68,68,0.7), 0 0 120px rgba(239,68,68,0.3); }
        }
        .buzzer-active {
            animation: buzzerGlow 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body class="text-white h-screen flex flex-col">
    <div id="login-screen" class="flex-1 flex flex-col items-center justify-center p-8 text-center">
        <div class="glass-panel rounded-3xl p-8 w-full max-w-sm">
            <h1 class="font-display text-3xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-orange-400 to-red-500 uppercase">SIPONTO</h1>
            <h2 class="font-display text-2xl font-bold mb-8 text-white/80 uppercase tracking-wider">Forever Young</h2>
            <input type="text" id="team-name" placeholder="Nome Squadra" class="w-full p-4 rounded-xl bg-white/10 text-white text-center font-bold uppercase mb-4 text-xl border border-white/20 placeholder-white/40 focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400/30 transition-all">
            <button onclick="login()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 py-4 rounded-xl font-bold text-xl shadow-lg active:scale-95 transition-all border border-blue-400/30" style="box-shadow: 0 4px 20px rgba(59,130,246,0.4);">ENTRA NEL GIOCO</button>
        </div>
    </div>

<div id="game-screen" class="hidden flex-col h-full">
    <div class="glass-panel p-4 flex justify-between items-center border-b border-white/10">
        <div class="flex items-center gap-2">
            <span id="my-name" class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400 uppercase tracking-widest">---</span>
            <span id="streak-indicator" class="hidden text-xs bg-gradient-to-r from-orange-600 to-red-600 px-2 py-1 rounded-full font-bold">üî• 0</span>
        </div>
        <div class="flex items-center gap-2">
            <span id="finale-indicator" class="hidden text-xs bg-red-600 px-2 py-1 rounded-full font-bold animate-pulse">üî• FINALE</span>
            <span class="text-xs font-bold animate-pulse"><span class="inline-block w-2 h-2 rounded-full bg-green-400 mr-1" style="box-shadow: 0 0 8px rgba(34,197,94,0.8);"></span>LIVE</span>
        </div>
    </div>
    
    <!-- TIMER VISIVO CIRCOLARE -->
    <div id="timer-container" class="hidden glass-panel p-4 border-b border-white/10">
        <div class="flex items-center justify-center gap-4">
            <div class="timer-circle-container">
                <svg width="80" height="80" viewBox="0 0 80 80">
                    <circle class="timer-circle-bg" cx="40" cy="40" r="36"></circle>
                    <circle id="timer-circle" class="timer-circle-progress" 
                            cx="40" cy="40" r="36"
                            stroke="#10b981"
                            stroke-dasharray="226.195"
                            stroke-dashoffset="0">
                    </circle>
                </svg>
                <div id="timer-display" class="timer-text" style="color: #10b981;">20</div>
            </div>
            <div class="text-left">
                <div class="text-xs text-gray-400 uppercase tracking-wide">Tempo rimasto</div>
                <div class="text-sm font-semibold text-white">Rispondi veloce!</div>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col p-4 overflow-y-auto">
        <div id="msg-box" class="text-center w-full text-gray-400 font-bold text-lg px-4 mb-6 flex-shrink-0">In attesa...</div>
        
        <div class="flex-1 flex flex-col justify-center items-center min-h-0">
            <!-- BOTTONI ALL IN -->
            <div id="allin-buttons" class="hidden w-full max-w-md grid grid-cols-2 gap-4">
                <button onclick="placeBet(0)" class="bg-gray-600 py-8 rounded-xl font-black text-3xl shadow-xl active:scale-95">0</button>
                <button onclick="placeBet(50)" class="bg-blue-600 py-8 rounded-xl font-black text-3xl shadow-xl active:scale-95">50</button>
                <button onclick="placeBet(100)" class="bg-orange-600 py-8 rounded-xl font-black text-3xl shadow-xl active:scale-95">100</button>
                <button onclick="placeBet(200)" class="bg-red-600 py-8 rounded-xl font-black text-3xl shadow-xl active:scale-95">200</button>
            </div>
            
            <!-- BOTTONI RUOTA FORTUNA -->
            <div id="ruota-choice-buttons" class="hidden w-full max-w-md space-y-4">
                <!-- Popolato dinamicamente -->
            </div>
            
            <button id="btn-buzzer" onclick="prenota()" class="hidden w-64 h-64 rounded-full flex items-center justify-center border-8 shadow-2xl transition-all">
                <span class="text-4xl font-black">PREMI!</span>
            </button>

            <div id="opts-grid" class="hidden grid grid-cols-2 gap-4 w-full h-full max-h-96"></div>
            
            <!-- MEMORY GRID PULSANTI -->
            <div id="memory-buttons" class="hidden w-full max-w-md">
                <div id="memory-button-grid" class="grid gap-2">
                    <!-- Popolato dinamicamente -->
                </div>
            </div>
            
            <!-- ====================================== -->
            <!-- PATTO COL DESTINO - CONTAINERS -->
            <!-- ====================================== -->
            
            <!-- PATTO - CHAT SEGRETA -->
            <div id="patto-chat-container" class="hidden flex-col h-full bg-gradient-to-br from-purple-900 to-indigo-900">
                <div class="bg-purple-800 p-4 border-b border-purple-700">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-yellow-400 uppercase">üí¨ Chat Segreta</span>
                        <span id="patto-chat-timer" class="text-2xl font-black text-white">30</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden mt-2">
                        <div id="patto-chat-timer-bar" class="h-2 bg-blue-500 rounded-full transition-all duration-1000" style="width: 100%;"></div>
                    </div>
                </div>
                
                <div id="patto-chat-messages" class="flex-1 overflow-y-auto p-4 space-y-2">
                    <div class="text-center text-gray-400 text-sm mb-4">
                        ‚ö†Ô∏è Solo voi 3 potete leggere questi messaggi<br/>
                        Fate accordi... ma ricordate: i patti possono essere violati!
                    </div>
                </div>
                
                <div class="p-4 bg-purple-900 border-t border-purple-700">
                    <div class="flex gap-2">
                        <input type="text" id="patto-chat-input" placeholder="Scrivi un messaggio..." 
                               class="flex-1 bg-gray-800 text-white p-3 rounded-lg border border-gray-700"
                               maxlength="100">
                        <button id="patto-chat-send" class="bg-blue-600 hover:bg-blue-500 px-6 rounded-lg font-bold">
                            INVIA
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- PATTO - SCELTA -->
            <div id="patto-scelta-container" class="hidden flex-col h-full bg-gradient-to-br from-orange-900 to-red-900">
                <div class="bg-red-800 p-4 border-b border-red-700">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-yellow-400 uppercase">üé≤ Scegli il tuo destino</span>
                        <span id="patto-scelta-timer" class="text-2xl font-black text-white">25</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden mt-2">
                        <div id="patto-scelta-timer-bar" class="h-2 bg-orange-500 rounded-full transition-all duration-1000" style="width: 100%;"></div>
                    </div>
                </div>
                
                <div class="flex-1 flex flex-col justify-center items-center p-6 gap-6">
                    <div id="patto-scelta-info" class="text-center text-white text-lg mb-4">
                        Scegli in segreto: PATTO o TRADIMENTO?<br/>
                        <span class="text-yellow-300">La tua scelta √® irreversibile!</span>
                    </div>
                    
                    <button id="btn-patto" class="w-full max-w-md h-48 bg-green-600 hover:bg-green-500 rounded-2xl border-4 border-green-400 flex flex-col items-center justify-center transition-all shadow-2xl">
                        <div class="text-7xl mb-3">ü§ù</div>
                        <div class="text-3xl font-black text-white">PATTO</div>
                        <div class="text-sm text-gray-200 mt-2">Collabora con gli altri</div>
                    </button>
                    
                    <button id="btn-tradimento" class="w-full max-w-md h-48 bg-red-600 hover:bg-red-500 rounded-2xl border-4 border-red-400 flex flex-col items-center justify-center transition-all shadow-2xl">
                        <div class="text-7xl mb-3">üí£</div>
                        <div class="text-3xl font-black text-white">TRADIMENTO</div>
                        <div class="text-sm text-gray-200 mt-2">Prendi tutto per te</div>
                    </button>
                    
                    <div id="patto-scelta-confermata" class="hidden text-center">
                        <div class="text-5xl mb-4">‚úÖ</div>
                        <div class="text-2xl font-bold text-green-400">Scelta inviata!</div>
                        <div class="text-gray-300">Attendere gli altri...</div>
                    </div>
                </div>
            </div>
            
            <!-- PATTO - OSSERVATORE -->
            <div id="patto-osservatore-container" class="hidden flex flex-col items-center justify-center h-full bg-gradient-to-br from-gray-900 to-gray-800 p-6 text-center">
                <div class="text-6xl mb-6">üëÄ</div>
                <div class="text-3xl font-bold text-white mb-4">Osservatore</div>
                <div id="patto-osservatore-message" class="text-xl text-gray-300">
                    Altre squadre stanno giocando...<br/>
                    Attendere il risultato!
                </div>
            </div>
            
            <!-- ====================================== -->
            <!-- FINE PATTO COL DESTINO -->
            <!-- ====================================== -->
        </div>
    </div>
</div>

<script>
    const socket = io({
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionAttempts: Infinity,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      timeout: 10000
    });
    let buzzerLocked = true;
    let timerInterval = null;
    let questionStartTime = 0;
    let maxTime = 20;
    let currentStreak = 0;

    // Initialize audio on first touch (mobile requires user gesture)
    document.addEventListener('touchstart', function initAudio() {
        SipontoAudio.init();
        SipontoAudio.setVolume(0.3); // Lower volume on mobile
        document.removeEventListener('touchstart', initAudio);
    }, { once: true });
    document.addEventListener('click', function initAudio() {
        SipontoAudio.init();
        SipontoAudio.setVolume(0.3);
        document.removeEventListener('click', initAudio);
    }, { once: true });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚úÖ FUNZIONI FEEDBACK VISIVO E VIBRAZIONE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    /**
     * Vibra il dispositivo mobile
     * @param {number} duration - Durata in millisecondi (default: 50ms)
     */
    function vibrate(duration = 50) {
        if (navigator.vibrate) {
            navigator.vibrate(duration);
        }
    }
    
    /**
     * Aggiunge feedback visivo di successo a un pulsante
     * @param {HTMLElement} button - Il pulsante da animare
     */
    function addButtonFeedback(button) {
        // Vibrazione
        vibrate(50);
        
        // Animazione CSS
        button.classList.add('btn-feedback-success');
        
        // Crea anello pulsante
        const ring = document.createElement('div');
        ring.className = 'absolute inset-0 rounded-full border-4 border-green-400 pulse-ring pointer-events-none';
        button.style.position = 'relative';
        button.appendChild(ring);
        
        // Rimuovi animazione dopo completamento
        setTimeout(() => {
            button.classList.remove('btn-feedback-success');
            ring.remove();
        }, 600);
    }
    
    /**
     * Aggiorna il timer circolare
     * @param {number} timeLeft - Tempo rimanente in secondi
     * @param {number} maxTime - Tempo massimo in secondi
     */
    function updateCircularTimer(timeLeft, maxTime) {
        const display = document.getElementById('timer-display');
        const circle = document.getElementById('timer-circle');
        
        if (!display || !circle) return;
        
        // Calcola percentuale rimanente
        const percentage = timeLeft / maxTime;
        const circumference = 226.195; // 2 * œÄ * r (r=36)
        const offset = circumference * (1 - percentage);
        
        // Aggiorna cerchio
        circle.style.strokeDashoffset = offset;
        
        // Cambia colore in base al tempo rimanente
        let color = '#10b981'; // Verde
        if (timeLeft <= 5) {
            color = '#ef4444'; // Rosso
            circle.style.stroke = color;
            display.style.color = color;
        } else if (timeLeft <= 10) {
            color = '#f59e0b'; // Arancione
            circle.style.stroke = color;
            display.style.color = color;
        }
        
        // Aggiorna numero
        display.textContent = timeLeft;
    }

    function login() { const n = document.getElementById('team-name').value; if(n) socket.emit('login', n); }
    
    socket.on('login_success', (d) => { 
        document.getElementById('login-screen').classList.add('hidden'); 
        document.getElementById('game-screen').classList.remove('hidden'); 
        document.getElementById('game-screen').classList.add('flex');
        document.getElementById('my-name').innerText = d.name;
    });

    // ‚úÖ RIMOSSO: La soluzione appare solo sul display

    // ‚úÖ PAUSA - Aggiungere notifiche visive
    socket.on('game_paused', () => {
        document.getElementById('msg-box').innerHTML = `
            <div class="text-6xl mb-4">‚è∏Ô∏è</div>
            <div class="text-yellow-400 font-black text-2xl">PAUSA</div>
        `;
        // Disabilita pulsanti
        document.querySelectorAll('button').forEach(btn => btn.disabled = true);
    });

    socket.on('game_resumed', () => {
        document.getElementById('msg-box').textContent = 'In attesa...';
        // Riabilita pulsanti
        document.querySelectorAll('button').forEach(btn => btn.disabled = false);
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CORREZIONI INDEX.HTML (Cellulari)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ‚úÖ Listener per mostrare scelta ruota (SOLO alla squadra estratta) - AGGIORNATO
    socket.on('ruota_choice', (data) => {
        console.log('üé∞ Ricevuta scelta ruota:', data);
        resetUI();
        
        document.getElementById('msg-box').innerHTML = `
            <div class="text-4xl font-black mb-8 animate-pulse text-yellow-400">üé∞ HAI VINTO LA RUOTA! üé∞</div>
            <div class="text-2xl font-bold mb-6 text-white">${data.message}</div>
        `;
        
        // Crea pulsanti per le opzioni
        const container = document.getElementById('ruota-choice-buttons');
        container.innerHTML = '';
        container.classList.remove('hidden');
        
        data.options.forEach(option => {
            const btn = document.createElement('button');
            
            if(option.id === 'safe') {
                // Bottone 50 punti sicuri
                btn.className = 'bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black text-3xl py-12 px-8 rounded-3xl shadow-2xl active:scale-95 transition-all mb-6 hover:scale-105';
                btn.innerHTML = `
                    <div class="text-6xl mb-4">üí∞</div>
                    <div class="text-2xl mb-2">${option.label}</div>
                    <div class="text-3xl mt-4 text-yellow-300 font-black">+${option.value} PUNTI</div>
                `;
            } else {
                // Bottone sfida
                btn.className = 'bg-gradient-to-r from-red-500 to-orange-600 text-white font-black text-3xl py-12 px-8 rounded-3xl shadow-2xl active:scale-95 transition-all mb-6 hover:scale-105';
                btn.innerHTML = `
                    <div class="text-6xl mb-4">üéØ</div>
                    <div class="text-2xl mb-2">${option.label}</div>
                    <div class="text-xl mt-4 text-yellow-300">Rischi 50 punti per vincerne 150!</div>
                `;
            }
            
            btn.onclick = () => {
                // ‚úÖ VIBRAZIONE E FEEDBACK per scelta ruota
                vibrate(80);
                
                // Invia la scelta al server
                socket.emit('ruota_choice_made', { choice: option.id });
                
                // Mostra feedback
                container.classList.add('hidden');
                document.getElementById('msg-box').innerHTML = `
                    <div class="bg-gradient-to-r ${option.id === 'safe' ? 'from-green-500 to-emerald-600' : 'from-orange-500 to-red-600'} p-8 rounded-3xl animate-pulse">
                        <div class="text-7xl mb-6">${option.id === 'safe' ? 'üí∞' : 'üéØ'}</div>
                        <div class="text-4xl font-black">${option.id === 'safe' ? 'HAI SCELTO 50 PUNTI SICURI!' : 'HAI SCELTO LA SFIDA!'}</div>
                        <div class="text-2xl mt-4">${option.id === 'safe' ? 'Punti aggiunti al tuo punteggio' : 'Preparati alla domanda...'}</div>
                    </div>
                `;
            };
            
            container.appendChild(btn);
        });
    });

    // Feedback dopo scelta
    socket.on('ruota_feedback', (data) => {
        document.getElementById('msg-box').innerHTML = `
            <div class="text-4xl font-black mb-4">${data.message}</div>
            ${data.points ? `<div class="text-6xl mt-4 text-yellow-400 font-black">${data.points > 0 ? '+' : ''}${data.points} PUNTI</div>` : ''}
        `;
    });

    // Risultato ruota (per tutti)
    socket.on('ruota_result', (data) => {
        console.log('üé∞ Risultato ruota:', data);
    });

    // ‚úÖ MODIFICA la gestione risposte per includere ruota
    socket.on('nuova_domanda', (d) => {
        SipontoAudio.tick();
        resetUI();
        
        // ‚úÖ Se √® una domanda della ruota, mostra messaggio speciale
        if (d.isRuotaQuestion) {
            document.getElementById('msg-box').innerHTML = `
                <div class="text-4xl font-black text-yellow-400 mb-4">üéØ SFIDA RUOTA DELLA FORTUNA!</div>
                <div class="text-2xl text-white mb-6">Rispondi correttamente per vincere 150 punti!</div>
                <div class="text-3xl font-bold">${d.domanda}</div>
            `;
        } else {
            document.getElementById('msg-box').innerText = d.domanda;
        }

        // Indicatore finale
        if(d.finaleQuestion) {
            document.getElementById('finale-indicator').classList.remove('hidden');
            document.getElementById('finale-indicator').textContent = `üî• ${d.finaleQuestion}/${d.totalFinaleQuestions}`;
        }

        if (d.modalita === 'buzzer') {
            const btn = document.getElementById('btn-buzzer');
            btn.classList.remove('hidden', 'pointer-events-none', 'opacity-50');
            btn.className = "w-64 h-64 rounded-full bg-gradient-to-br from-red-600 to-red-700 border-4 border-red-400/50 flex items-center justify-center cursor-pointer buzzer-active";
            btn.innerHTML = "<span class='text-4xl font-black text-white uppercase font-display'>BUZZER!</span>";
            btn.onclick = () => {
                socket.emit('buzzer_press', { time: Date.now() });
                btn.classList.add('pointer-events-none', 'opacity-50');
                btn.innerHTML = "<span class='text-3xl font-black'>PRENOTATO!</span>";
            };
            document.getElementById('timer-container').classList.add('hidden');
        } else if (d.risposte && d.risposte.length > 0) {
            // Timer visivo
            if (d.startTime && !d.isRuotaQuestion) {
                const networkDelay = Date.now() - d.serverTimestamp;
                questionStartTime = d.startTime + networkDelay;
                maxTime = 20;
                startTimer();
            }
            
            // Mostra opzioni
            const g = document.getElementById('opts-grid');
            g.classList.remove('hidden', 'pointer-events-none', 'opacity-75');
            g.innerHTML = '';
            
            d.risposte.forEach((r, i) => {
                const b = document.createElement('button');
                b.className = "answer-btn";
                b.innerText = r;
                b.onclick = () => {
                    addButtonFeedback(b);

                    if (d.isRuotaQuestion) {
                        socket.emit('ruota_answer', { risposta: r });
                    } else {
                        socket.emit('risposta', { risposta: r });
                    }
                    
                    g.classList.add('pointer-events-none', 'opacity-50');
                    b.classList.add('ring-4', 'ring-yellow-400', 'bg-blue-800');
                    
                    document.getElementById('msg-box').innerHTML = `
                        <div class="bg-yellow-600 p-4 rounded-xl">
                            <p class="text-2xl font-bold">‚è≥ Risposta inviata!</p>
                            <p class="text-lg mt-2">Attendi il risultato...</p>
                        </div>
                    `;
                };
                g.appendChild(b);
            });
            
            document.getElementById('btn-buzzer').classList.add('hidden');
        }
    });

    // ‚úÖ Feedback risposta inviata - SOLO CONFERMA, SENZA DETTAGLI
    socket.on('risposta_inviata', (data) => {
        SipontoAudio.pointScored();
        stopTimer();
        document.getElementById('opts-grid').classList.add('pointer-events-none', 'opacity-50');
        
        // NON mostrare se corretta/sbagliata, tempo o punti sui cellulari
        // Solo conferma che la risposta √® stata ricevuta
        document.getElementById('msg-box').innerHTML = `
            <div class="bg-blue-600 p-6 rounded-xl">
                <div class="text-6xl mb-3">‚úì</div>
                <h2 class="text-4xl font-black mb-2">RISPOSTA INVIATA!</h2>
                <p class="text-lg mt-3">Attendi il risultato sul display...</p>
            </div>
        `;
    });
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üí∞ SFIDA FINALE - ALL IN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // ALL IN - Mostra bottoni scommessa (EVENTO CORRETTO)
    socket.on('finale_allin_betting', (d) => {
        console.log('üì± Ricevuto evento scommesse ALL IN FINALE:', d);
        resetUI();
        
        document.getElementById('msg-box').innerHTML = `
            <div class="text-center">
                <div class="text-7xl mb-4 animate-pulse">üí∞</div>
                <div class="text-3xl font-black text-yellow-400 mb-2">ALL IN!</div>
                <div class="text-xl text-white">Punta i tuoi punti sulla risposta</div>
            </div>
        `;
        
        document.getElementById('allin-buttons').classList.remove('hidden');
        document.getElementById('finale-indicator').classList.remove('hidden');
        document.getElementById('finale-indicator').textContent = `üî• FINALE 1/5`;
        
        // Salva la domanda per dopo
        window.allInQuestion = d.question;
    });

    // ALL IN - Scommessa (CORRETTO: invia bet E risposta insieme)
    function placeBet(amount) {
        // ‚úÖ VIBRAZIONE per conferma scommessa
        vibrate(60);
        
        if(!window.allInQuestion) {
            console.error('‚ùå Nessuna domanda ALL IN caricata');
            return;
        }
        
        // Salva la scommessa e mostra la domanda
        window.currentBet = amount;
        
        document.getElementById('allin-buttons').classList.add('hidden');
        
        // Mostra la domanda con le opzioni
        document.getElementById('msg-box').innerHTML = `
            <div class="bg-yellow-900/50 p-4 rounded-xl mb-4">
                <div class="text-sm text-yellow-400">üí∞ HAI PUNTATO: ${amount} PUNTI</div>
            </div>
            <div class="text-2xl font-bold mb-4">${window.allInQuestion.domanda}</div>
        `;
        
        const g = document.getElementById('opts-grid');
        g.classList.remove('hidden');
        g.innerHTML = '';
        
        window.allInQuestion.risposte.forEach(r => {
            const b = document.createElement('button');
            b.className = "answer-btn";
            b.innerText = r;
            b.onclick = () => {
                // ‚úÖ FEEDBACK VISIVO E VIBRAZIONE
                addButtonFeedback(b);
                
                // Invia scommessa + risposta al server
                socket.emit('finale_allin_bet', { 
                    bet: amount, 
                    answer: r 
                });
                
                g.classList.add('opacity-50', 'pointer-events-none');
                b.classList.add('ring-4', 'ring-yellow-400', 'bg-blue-800');
                
                document.getElementById('msg-box').innerHTML = `
                    <div class="bg-green-600 p-6 rounded-xl">
                        <div class="text-6xl mb-4">‚úì</div>
                        <div class="text-3xl font-black mb-2">SCOMMESSA CONFERMATA!</div>
                        <div class="text-xl">üí∞ ${amount} punti su "${r}"</div>
                        <div class="text-lg mt-4 text-yellow-300">Attendi il risultato...</div>
                    </div>
                `;
            };
            g.appendChild(b);
        });
    }
    
    // ALL IN - Rivelazione risultati
    socket.on('finale_allin_reveal', (data) => {
        console.log('üì± Rivelazione ALL IN:', data);
        resetUI();
        
        // Trova la mia scommessa
        const myBet = data.bets.find(b => b.teamId === socket.id);
        
        if(myBet) {
            const isCorrect = myBet.answer === data.correctAnswer;
            const points = isCorrect ? myBet.bet : -myBet.bet;
            
            document.getElementById('msg-box').innerHTML = `
                <div class="bg-gradient-to-r ${isCorrect ? 'from-green-500 to-emerald-600' : 'from-red-500 to-red-700'} p-8 rounded-3xl">
                    <div class="text-8xl mb-6">${isCorrect ? 'üéâ' : 'üò¢'}</div>
                    <div class="text-4xl font-black mb-4">${isCorrect ? 'CORRETTO!' : 'SBAGLIATO!'}</div>
                    <div class="text-2xl mb-2">Risposta: ${data.correctAnswer}</div>
                    <div class="text-5xl font-black mt-4 text-yellow-300">
                        ${points > 0 ? '+' : ''}${points} PUNTI
                    </div>
                </div>
            `;
        }
    });
    
    // LEGACY: Mantieni compatibilit√† con vecchio sistema (se presente)
    socket.on('show_allin_betting', (d) => {
        console.log('üì± [LEGACY] Ricevuto evento scommesse ALL IN');
        resetUI();
        document.getElementById('msg-box').innerText = "üí∞ ALL IN - Scommetti!";
        document.getElementById('allin-buttons').classList.remove('hidden');
        document.getElementById('finale-indicator').classList.remove('hidden');
        document.getElementById('finale-indicator').textContent = `üî• 1/${d.totalFinaleQuestions || 5}`;
    });

    // BUZZER STANDALONE MODE
    socket.on('buzzer_standalone_mode', (data) => {
        if(data.active) {
            resetUI();
            document.getElementById('msg-box').innerText = "üéµ Premi quando sai la risposta!";
            document.getElementById('btn-buzzer').classList.remove('hidden');
            const btn = document.getElementById('btn-buzzer');
            btn.className = "w-64 h-64 rounded-full bg-red-600 border-red-800 flex items-center justify-center animate-pulse shadow-[0_0_50px_rgba(255,0,0,0.5)]";
            btn.innerHTML = "<span class='text-4xl font-black text-white uppercase tracking-widest'>VAI!</span>";
            btn.onclick = prenota;
            buzzerLocked = false;
        }
    });

    function startTimer() {
        // ‚úÖ PATCH 9: Doppio controllo memory leak
        if(timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        document.getElementById('timer-container').classList.remove('hidden');
        
        timerInterval = setInterval(() => {
            const elapsed = (Date.now() - questionStartTime) / 1000;
            const remaining = Math.max(0, maxTime - elapsed);
            
            // ‚úÖ Aggiorna timer circolare
            updateCircularTimer(Math.ceil(remaining), maxTime);
            
            if(remaining <= 0) {
                stopTimer();
                updateCircularTimer(0, maxTime);
            }
        }, 100);
    }

    function stopTimer() {
        if(timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    socket.on('buzzer_position', (data) => {
        const b = document.getElementById('btn-buzzer');
        const medals = ['ü•á', 'ü•à', 'ü•â'];
        const medal = medals[data.position - 1] || `${data.position}¬∞`;
        
        b.className = "w-64 h-64 rounded-full bg-green-500 border-8 border-green-700 flex flex-col items-center justify-center shadow-[0_0_50px_rgba(0,255,0,0.6)]";
        b.innerHTML = `
            <span class='text-6xl mb-2'>${medal}</span>
            <span class='text-2xl font-black text-black uppercase'>Prenotato!</span>
            <span class='text-lg text-black mt-2'>${data.time}s</span>
        `;
        if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
        
        b.onclick = null;
        b.classList.add('opacity-75');
    });

    socket.on('stato_buzzer', (d) => {
        const btn = document.getElementById('btn-buzzer');
        if(!d.attiva) {
            btn.classList.add('hidden');
            return;
        }
        
        buzzerLocked = d.locked;
        
        if(buzzerLocked) {
            btn.className = "w-64 h-64 rounded-full bg-gray-700 border-gray-800 opacity-50 flex items-center justify-center";
            btn.innerHTML = "<span class='text-2xl font-bold text-gray-400 uppercase'>Bloccato</span>";
            btn.onclick = null;
        } else {
            btn.classList.remove('hidden');
            btn.className = "w-64 h-64 rounded-full bg-red-600 border-red-800 flex items-center justify-center animate-pulse shadow-[0_0_50px_rgba(255,0,0,0.5)]";
            btn.innerHTML = "<span class='text-4xl font-black text-white uppercase tracking-widest'>VAI!</span>";
            btn.onclick = prenota;
        }
    });

    function prenota() { 
        if(!buzzerLocked) {
            // ‚úÖ VIBRAZIONE FORTE per il buzzer
            vibrate([100, 50, 100]); // Pattern: vibra-pausa-vibra
            SipontoAudio.buzzer();
            socket.emit('prenoto');
        }
    }
    
    function resetUI() {
        stopTimer();
        document.getElementById('btn-buzzer').classList.add('hidden');
        document.getElementById('opts-grid').classList.add('hidden');
        document.getElementById('opts-grid').innerHTML = '';
        document.getElementById('opts-grid').classList.remove('opacity-40','pointer-events-none');
        document.getElementById('timer-container').classList.add('hidden');
        document.getElementById('allin-buttons').classList.add('hidden');
        document.getElementById('memory-buttons').classList.add('hidden');
        document.getElementById('ruota-choice-buttons').classList.add('hidden');
        
        // Nascondi container duello
        const opponentsDiv = document.getElementById('duello-opponents-container');
        if(opponentsDiv) opponentsDiv.classList.add('hidden');
        const categoriesDiv = document.getElementById('duello-categories-container');
        if(categoriesDiv) categoriesDiv.classList.add('hidden');
        const questionDiv = document.getElementById('duello-question-container');
        if(questionDiv) questionDiv.classList.add('hidden');
    }
    
    socket.on('game_paused', () => {
        resetUI();
        document.getElementById('msg-box').innerHTML = `
            <div class="bg-orange-600 p-6 rounded-xl">
                <div class="text-6xl mb-4">‚òï</div>
                <div class="text-3xl font-black">PAUSA</div>
                <div class="text-xl mt-2">Torniamo tra pochissimo!</div>
            </div>
        `;
    });
    
    socket.on('game_resumed', () => {
        document.getElementById('msg-box').innerHTML = 'In attesa...';
        document.getElementById('msg-box').className = 'absolute top-4 text-center w-full text-gray-400 font-bold text-lg px-4';
    });
    
    socket.on('reset_client_ui', () => {
        resetUI();
        document.getElementById('msg-box').innerHTML = 'In attesa...';
        document.getElementById('msg-box').className = 'absolute top-4 text-center w-full text-gray-400 font-bold text-lg px-4';
        document.getElementById('finale-indicator').classList.add('hidden');
    });
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üî• DUELLO RUBA-PUNTI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    socket.on('duello_choose_opponent', (data) => {
        resetUI();
        document.getElementById('msg-box').innerHTML = `
            <div class="bg-red-600 p-4 rounded-xl">
                <div class="text-4xl mb-2">üî•</div>
                <div class="text-xl font-black mb-2">SCEGLI IL TUO AVVERSARIO</div>
                <div class="text-xs">Chi vuoi sfidare?</div>
            </div>
        `;
        
        // Crea container per i pulsanti se non esiste
        let opponentsDiv = document.getElementById('duello-opponents-container');
        if(!opponentsDiv) {
            opponentsDiv = document.createElement('div');
            opponentsDiv.id = 'duello-opponents-container';
            opponentsDiv.className = 'w-full max-w-md space-y-2 mt-4';
            document.querySelector('.flex-1.flex.flex-col.p-4').appendChild(opponentsDiv);
        }
        opponentsDiv.innerHTML = '';
        opponentsDiv.classList.remove('hidden');
        
        data.opponents.forEach(opp => {
            const btn = document.createElement('button');
            btn.className = 'w-full bg-gradient-to-r from-orange-500 to-red-600 p-3 rounded-xl font-black text-lg hover:scale-105 transition shadow-xl active:scale-95';
            btn.innerHTML = `${opp.name} <span class="text-xs font-normal">(${opp.score}pt)</span>`;
            btn.onclick = () => {
                socket.emit('duello_opponent_chosen', { opponentId: opp.id });
                opponentsDiv.innerHTML = '';
                opponentsDiv.classList.add('hidden');
                document.getElementById('msg-box').innerHTML = `
                    <div class="bg-green-600 p-6 rounded-xl">
                        <div class="text-5xl mb-4">‚úÖ</div>
                        <div class="text-2xl font-black">Hai sfidato ${opp.name}!</div>
                        <div class="text-sm mt-2">Ora scegli la categoria...</div>
                    </div>
                `;
            };
            opponentsDiv.appendChild(btn);
        });
    });
    
    socket.on('duello_choose_category', (data) => {
        resetUI();
        document.getElementById('msg-box').innerHTML = `
            <div class="bg-purple-600 p-6 rounded-xl">
                <div class="text-5xl mb-4">üìö</div>
                <div class="text-2xl font-black mb-4">SCEGLI LA CATEGORIA</div>
                <div class="text-sm mb-4">In quale categoria vuoi sfidare?</div>
            </div>
        `;
        
        // Crea container per le categorie se non esiste
        let categoriesDiv = document.getElementById('duello-categories-container');
        if(!categoriesDiv) {
            categoriesDiv = document.createElement('div');
            categoriesDiv.id = 'duello-categories-container';
            categoriesDiv.className = 'w-full max-w-md grid grid-cols-2 gap-3 mt-6';
            document.querySelector('.flex-1.flex.flex-col.p-4').appendChild(categoriesDiv);
        }
        categoriesDiv.innerHTML = '';
        categoriesDiv.classList.remove('hidden');
        
        data.categories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = 'bg-gradient-to-r from-indigo-500 to-purple-600 p-4 rounded-xl font-black text-lg hover:scale-105 transition shadow-xl active:scale-95';
            btn.textContent = cat.toUpperCase();
            btn.onclick = () => {
                socket.emit('duello_category_chosen', { category: cat });
                categoriesDiv.innerHTML = '';
                categoriesDiv.classList.add('hidden');
                document.getElementById('msg-box').innerHTML = `
                    <div class="bg-green-600 p-6 rounded-xl animate-pulse">
                        <div class="text-5xl mb-4">‚úÖ</div>
                        <div class="text-2xl font-black">Categoria: ${cat.toUpperCase()}</div>
                        <div class="text-sm mt-2">Preparati al duello!</div>
                    </div>
                `;
            };
            categoriesDiv.appendChild(btn);
        });
    });
    
    socket.on('duello_question', (d) => {
        resetUI();
        
        document.getElementById('msg-box').innerHTML = `
            <div class="bg-gradient-to-r from-red-600 to-orange-600 p-4 rounded-xl">
                <div class="text-3xl mb-2">‚öîÔ∏è DUELLO</div>
                <div class="text-sm">${d.categoria.toUpperCase()}</div>
            </div>
        `;
        
        // Crea container per domanda e buzzer
        let duelloQuestionDiv = document.getElementById('duello-question-container');
        if(!duelloQuestionDiv) {
            duelloQuestionDiv = document.createElement('div');
            duelloQuestionDiv.id = 'duello-question-container';
            duelloQuestionDiv.className = 'w-full max-w-md mt-6';
            document.querySelector('.flex-1.flex.flex-col.p-4').appendChild(duelloQuestionDiv);
        }
        duelloQuestionDiv.classList.remove('hidden');
        duelloQuestionDiv.innerHTML = `
            <div class="text-2xl font-black mb-6 leading-tight text-center">${d.domanda}</div>
            <button onclick="pressDuelloBuzzer()" class="w-full bg-gradient-to-r from-yellow-400 to-red-600 p-8 rounded-2xl font-black text-4xl hover:scale-105 transition shadow-2xl animate-pulse active:scale-95">
                ‚ö° BUZZER ‚ö°
            </button>
        `;
    });
    
    function pressDuelloBuzzer() {
        socket.emit('duello_buzzer_press', { teamId: socket.id });
        const duelloQuestionDiv = document.getElementById('duello-question-container');
        if(duelloQuestionDiv) {
            duelloQuestionDiv.innerHTML = `
                <div class="bg-blue-600 p-8 rounded-xl text-center">
                    <div class="text-5xl mb-4">‚ö°</div>
                    <div class="text-3xl font-black">HAI PREMUTO!</div>
                    <div class="text-lg mt-2">Rispondi vocalmente alla domanda</div>
                </div>
            `;
        }
    }
    
    socket.on('duello_buzzer_pressed', (data) => {
        // Mostra chi ha premuto
        const myId = socket.id;
        if(data.teamId === myId) {
            document.getElementById('msg-box').innerHTML = `
                <div class="bg-yellow-400 text-black p-4 rounded-xl font-black text-xl">
                    üé§ TU HAI PREMUTO! Rispondi vocalmente
                </div>
            `;
        } else {
            document.getElementById('msg-box').innerHTML = `
                <div class="bg-gray-600 p-4 rounded-xl">
                    ‚è≥ ${data.teamName} sta rispondendo...
                </div>
            `;
            const duelloQuestionDiv = document.getElementById('duello-question-container');
            if(duelloQuestionDiv) duelloQuestionDiv.innerHTML = '';
        }
    });
    
    socket.on('duello_point_scored', (data) => {
        document.getElementById('msg-box').innerHTML = `
            <div class="bg-green-600 p-6 rounded-xl">
                <div class="text-5xl mb-4">‚úÖ</div>
                <div class="text-2xl font-black">${data.teamName} SEGNA!</div>
                <div class="text-4xl mt-4">${data.scoreAttaccante} - ${data.scoreDifensore}</div>
            </div>
        `;
        const duelloQuestionDiv = document.getElementById('duello-question-container');
        if(duelloQuestionDiv) duelloQuestionDiv.innerHTML = '';
    });
    
    socket.on('duello_wrong_answer', (data) => {
        document.getElementById('msg-box').innerHTML = `
            <div class="bg-red-600 p-6 rounded-xl">
                <div class="text-5xl mb-4">‚ùå</div>
                <div class="text-xl font-black">${data.wrongTeamName} ha sbagliato!</div>
            </div>
        `;
    });
    
    socket.on('duello_end', (data) => {
        resetUI();
        const isWinner = socket.id === data.winner.id;
        
        document.getElementById('msg-box').innerHTML = `
            <div class="bg-gradient-to-r ${isWinner ? 'from-green-500 to-emerald-600' : 'from-gray-600 to-slate-700'} p-8 rounded-xl">
                <div class="text-8xl mb-6">${isWinner ? 'üèÜ' : 'üòî'}</div>
                <div class="text-4xl font-black mb-4">${isWinner ? 'HAI VINTO!' : 'HAI PERSO'}</div>
                <div class="text-2xl">${data.pointsChange}</div>
            </div>
        `;
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üß† MEMORY GAME - CLIENT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    socket.on('memory_reveal_one', (data) => {
        resetUI();
        
        document.getElementById('msg-box').innerHTML = `
            <div class="text-4xl mb-2">üß† MEMORY</div>
            <div class="text-2xl">Trova la coppia di ${data.image}!</div>
        `;
        
        const buttonsDiv = document.getElementById('memory-buttons');
        const gridDiv = document.getElementById('memory-button-grid');
        
        buttonsDiv.classList.remove('hidden');
        gridDiv.innerHTML = '';
        
        // Configura grid in base alla manche
        if(data.grid === '2x3') {
            gridDiv.className = 'grid grid-cols-3 gap-2';
        } else if(data.grid === '2x5') {
            gridDiv.className = 'grid grid-cols-5 gap-2';
        } else if(data.grid === '2x7') {
            gridDiv.className = 'grid grid-cols-7 gap-2';
        }
        
        // Crea pulsanti per ogni posizione
        const totalCards = data.grid === '2x3' ? 6 : data.grid === '2x5' ? 10 : 14;
        
        for(let i = 0; i < totalCards; i++) {
            const btn = document.createElement('button');
            btn.className = 'bg-gray-700 hover:bg-gray-600 text-white font-black text-2xl py-4 rounded-lg active:scale-95 transition-all';
            btn.textContent = i + 1;
            
            // Disabilita il pulsante della carta rivelata
            if(i === data.position) {
                btn.className = 'bg-yellow-600 text-white font-black text-2xl py-4 rounded-lg opacity-50';
                btn.disabled = true;
            } else {
                btn.onclick = () => sendMemoryAnswer(i);
            }
            
            gridDiv.appendChild(btn);
        }
    });

    function sendMemoryAnswer(position) {
        // ‚úÖ VIBRAZIONE per risposta memory
        vibrate(50);
        
        socket.emit('memory_answer', { position: position });
        
        // Disabilita tutti i pulsanti
        const gridDiv = document.getElementById('memory-button-grid');
        Array.from(gridDiv.children).forEach(btn => {
            btn.disabled = true;
            btn.className = 'bg-gray-800 text-gray-500 font-black text-2xl py-4 rounded-lg opacity-50';
        });
        
        // Evidenzia risposta data
        gridDiv.children[position].className = 'bg-blue-600 text-white font-black text-2xl py-4 rounded-lg border-4 border-blue-300';
        
        document.getElementById('msg-box').innerHTML = `
            <div class="text-3xl text-green-400">‚úÖ Risposta inviata!</div>
            <div class="text-xl mt-2">Posizione: ${position + 1}</div>
        `;
    }

    socket.on('memory_show_results', (data) => {
        const myAnswer = data.results.find(r => r.teamId === socket.id);
        
        if(myAnswer) {
            if(myAnswer.correct) {
                document.getElementById('msg-box').innerHTML = `
                    <div class="text-5xl mb-4">üéâ</div>
                    <div class="text-3xl font-black text-green-400 mb-2">CORRETTO!</div>
                    <div class="text-xl">+150 punti${myAnswer.bonus ? ' +50 bonus velocit√†!' : ''}</div>
                `;
            } else {
                document.getElementById('msg-box').innerHTML = `
                    <div class="text-5xl mb-4">‚ùå</div>
                    <div class="text-2xl font-bold text-red-400">Sbagliato!</div>
                    <div class="text-lg mt-2">La risposta era: ${data.correctPosition + 1}</div>
                `;
            }
        }
        
        setTimeout(() => {
            document.getElementById('memory-buttons').classList.add('hidden');
        }, 3000);
    });
    
    // ============================================
    // üíÄ IL PATTO COL DESTINO - MOBILE HANDLERS
    // ============================================
    
    let pattoMobileTimerInterval = null;
    let pattoIsCoinvolto = false;
    let pattoHasChosen = false;
    
    // FASE 1: Chat Segreta
    socket.on('patto_fase_chat_start', (data) => {
        // Nascondi tutto
        document.getElementById('msg-box').classList.add('hidden');
        document.getElementById('btn-buzzer').classList.add('hidden');
        document.getElementById('opts-grid').classList.add('hidden');
        
        // Controlla se questa squadra √® coinvolta
        pattoIsCoinvolto = data.squadreCoinvolte.some(s => s.id === socket.id);
        
        if (pattoIsCoinvolto) {
            // Mostra chat
            document.getElementById('patto-chat-container').classList.remove('hidden');
            document.getElementById('patto-chat-messages').innerHTML = `
                <div class="text-center text-gray-400 text-sm mb-4">
                    ‚ö†Ô∏è Solo voi 3 potete leggere questi messaggi<br/>
                    Fate accordi... ma ricordate: i patti possono essere violati!
                </div>
            `;
            pattoStartMobileTimer(data.tempoChat, 'chat');
        } else {
            // Mostra schermata osservatore
            document.getElementById('patto-osservatore-container').classList.remove('hidden');
            document.getElementById('patto-osservatore-message').innerHTML = 
                'Altre squadre stanno comunicando in segreto...<br/>Attendere!';
        }
    });
    
    // Ricevi messaggio chat
    socket.on('patto_chat_message', (data) => {
        if (!pattoIsCoinvolto) return;
        
        const container = document.getElementById('patto-chat-messages');
        const isMe = data.teamId === socket.id;
        const alignment = isMe ? 'justify-end' : 'justify-start';
        const bgColor = isMe ? 'bg-blue-600' : 'bg-gray-700';
        
        container.innerHTML += `
            <div class="flex ${alignment}">
                <div class="${bgColor} rounded-lg p-3 max-w-[80%]">
                    <div class="text-xs text-gray-300 mb-1">${data.playerName}</div>
                    <div class="text-white">${data.msg}</div>
                </div>
            </div>
        `;
        
        // Scroll automatico
        container.scrollTop = container.scrollHeight;
    });
    
    // Invia messaggio chat
    document.getElementById('patto-chat-send').addEventListener('click', () => {
        const input = document.getElementById('patto-chat-input');
        const msg = input.value.trim();
        if (msg.length === 0) return;
        
        socket.emit('patto_send_chat_message', { msg });
        input.value = '';
    });
    
    // Enter per inviare
    document.getElementById('patto-chat-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('patto-chat-send').click();
        }
    });
    
    // FASE 2: Scelta Individuale
    socket.on('patto_fase_scelta_start', (data) => {
        pattoHasChosen = false;
        
        // Nascondi chat
        document.getElementById('patto-chat-container').classList.add('hidden');
        
        if (pattoIsCoinvolto) {
            // Mostra pulsanti scelta
            document.getElementById('patto-scelta-container').classList.remove('hidden');
            document.getElementById('patto-scelta-confermata').classList.add('hidden');
            document.getElementById('btn-patto').disabled = false;
            document.getElementById('btn-tradimento').disabled = false;
            pattoStartMobileTimer(data.tempoScelta, 'scelta');
        } else {
            // Rimani osservatore
            document.getElementById('patto-osservatore-message').innerHTML = 
                'Le squadre stanno scegliendo...<br/>PATTO o TRADIMENTO?';
        }
    });
    
    // Click PATTO
    document.getElementById('btn-patto').addEventListener('click', () => {
        if (pattoHasChosen) return;
        pattoInviaScelta('patto');
    });
    
    // Click TRADIMENTO
    document.getElementById('btn-tradimento').addEventListener('click', () => {
        if (pattoHasChosen) return;
        pattoInviaScelta('tradimento');
    });
    
    function pattoInviaScelta(scelta) {
        pattoHasChosen = true;
        socket.emit('patto_invia_scelta', { scelta });
        
        // Disabilita pulsanti
        document.getElementById('btn-patto').disabled = true;
        document.getElementById('btn-tradimento').disabled = true;
        
        // Mostra conferma
        document.getElementById('btn-patto').classList.add('opacity-50');
        document.getElementById('btn-tradimento').classList.add('opacity-50');
        document.getElementById('patto-scelta-confermata').classList.remove('hidden');
    }
    
    // Reveal e risultato finale - Resetta UI mobile
    socket.on('patto_reveal_suspense', () => {
        pattoResetMobileUI();
        document.getElementById('msg-box').classList.remove('hidden');
        document.getElementById('msg-box').innerHTML = `
            <div class="text-center">
                <div class="text-5xl mb-4 animate-pulse">üé≠</div>
                <div class="text-2xl font-bold">Le scelte saranno rivelate...</div>
            </div>
        `;
    });
    
    socket.on('patto_risultato_finale', () => {
        pattoResetMobileUI();
        document.getElementById('msg-box').classList.remove('hidden');
        document.getElementById('msg-box').innerHTML = `
            <div class="text-center">
                <div class="text-5xl mb-4">üéØ</div>
                <div class="text-2xl font-bold">Guarda il display per i risultati!</div>
            </div>
        `;
    });
    
    // Reset
    socket.on('patto_reset', () => {
        pattoResetMobileUI();
    });
    
    // Funzioni helper
    function pattoStartMobileTimer(seconds, phase) {
        pattoStopMobileTimer();
        
        const timerDisplay = document.getElementById(`patto-${phase}-timer`);
        const timerBar = document.getElementById(`patto-${phase}-timer-bar`);
        
        let timeLeft = seconds;
        timerDisplay.textContent = timeLeft;
        timerBar.style.width = '100%';
        
        pattoMobileTimerInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.textContent = timeLeft;
            timerBar.style.width = `${(timeLeft / seconds) * 100}%`;
            
            if (timeLeft <= 5) {
                timerBar.style.backgroundColor = '#ef4444';
            } else if (timeLeft <= 10) {
                timerBar.style.backgroundColor = '#f59e0b';
            }
            
            if (timeLeft <= 0) {
                pattoStopMobileTimer();
            }
        }, 1000);
    }
    
    function pattoStopMobileTimer() {
        if (pattoMobileTimerInterval) {
            clearInterval(pattoMobileTimerInterval);
            pattoMobileTimerInterval = null;
        }
    }
    
    function pattoResetMobileUI() {
        pattoStopMobileTimer();
        pattoIsCoinvolto = false;
        pattoHasChosen = false;
        
        document.getElementById('patto-chat-container').classList.add('hidden');
        document.getElementById('patto-scelta-container').classList.add('hidden');
        document.getElementById('patto-osservatore-container').classList.add('hidden');
        document.getElementById('patto-scelta-confermata').classList.add('hidden');
        
        document.getElementById('btn-patto').classList.remove('opacity-50');
        document.getElementById('btn-tradimento').classList.remove('opacity-50');
    }
    
    // ============================================
    // FINE HANDLERS PATTO COL DESTINO
    // ============================================
    
    socket.on('force_reload', () => window.location.reload());
</script>
</body>
</html>
